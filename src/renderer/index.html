<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Create Linear Issue</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f5f5f5;
      padding: 20px;
      padding-top: 40px; /* ÏÉÅÎã® ÏúàÎèÑÏö∞ Ïª®Ìä∏Î°§ Î≤ÑÌäº ÏòÅÏó≠ ÌôïÎ≥¥ */
      -webkit-app-region: drag;
    }

    .container {
      background: white;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      -webkit-app-region: no-drag;
    }

    h1 {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 16px;
      color: #333;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .settings-btn {
      background: none;
      border: none;
      font-size: 18px;
      cursor: pointer;
      padding: 4px 8px;
      border-radius: 6px;
      opacity: 0.6;
      transition: opacity 0.2s, background 0.2s;
    }

    .settings-btn:hover {
      opacity: 1;
      background: #f0f0f0;
    }

    .preview {
      width: 100%;
      max-height: 150px;
      object-fit: contain;
      border-radius: 8px;
      border: 1px solid #e0e0e0;
      margin-bottom: 16px;
      background: #fafafa;
    }

    .form-group {
      margin-bottom: 14px;
    }

    label {
      display: block;
      font-size: 13px;
      font-weight: 500;
      color: #555;
      margin-bottom: 6px;
    }

    input[type="text"],
    textarea,
    select {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 14px;
      font-family: inherit;
      transition: border-color 0.2s;
      -webkit-app-region: no-drag;
    }

    input[type="text"]:focus,
    textarea:focus,
    select:focus {
      outline: none;
      border-color: #5e6ad2;
    }

    textarea {
      resize: vertical;
      min-height: 144px; /* Í∏∞Î≥∏ ÎÜíÏù¥ 80% Ï¶ùÍ∞Ä (80px ‚Üí 144px) */
    }

    .row {
      display: flex;
      gap: 12px;
    }

    .row .form-group {
      flex: 1;
    }

    .buttons {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
      margin-top: 16px;
    }

    button {
      padding: 10px 20px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-cancel {
      background: #f5f5f5;
      border: 1px solid #ddd;
      color: #666;
    }

    .btn-cancel:hover {
      background: #eee;
    }

    .btn-submit {
      background: #5e6ad2;
      border: none;
      color: white;
    }

    .btn-submit:hover {
      background: #4c5abd;
    }

    .btn-submit:disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    .loading {
      display: none;
      text-align: center;
      padding: 20px;
      color: #666;
    }

    .error {
      color: #e74c3c;
      font-size: 13px;
      margin-top: 8px;
    }

    /* AI Loading spinner */
    .ai-loading {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      background: #f0f1ff;
      border-radius: 8px;
      margin-bottom: 14px;
      font-size: 13px;
      color: #5e6ad2;
    }

    .ai-loading.hidden {
      display: none;
    }

    .spinner {
      width: 16px;
      height: 16px;
      border: 2px solid #e0e0ff;
      border-top-color: #5e6ad2;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Searchable dropdown styles */
    .searchable-select {
      position: relative;
    }

    .searchable-select .select-trigger {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 14px;
      font-family: inherit;
      background: white;
      cursor: pointer;
      text-align: left;
      display: flex;
      justify-content: space-between;
      align-items: center;
      -webkit-app-region: no-drag;
    }

    .searchable-select .select-trigger:focus {
      outline: none;
      border-color: #5e6ad2;
    }

    .searchable-select .select-trigger::after {
      content: '‚ñº';
      font-size: 10px;
      color: #999;
    }

    .searchable-select .dropdown {
      display: none;
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: white;
      border: 1px solid #ddd;
      border-radius: 8px;
      margin-top: 4px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      z-index: 1000;
      max-height: 200px;
      overflow: hidden;
    }

    .searchable-select .dropdown.open {
      display: block;
    }

    .searchable-select .search-input {
      width: 100%;
      padding: 10px 12px;
      border: none;
      border-bottom: 1px solid #eee;
      font-size: 14px;
      outline: none;
    }

    .searchable-select .options {
      max-height: 150px;
      overflow-y: auto;
    }

    .searchable-select .option {
      padding: 10px 12px;
      cursor: pointer;
      font-size: 14px;
    }

    .searchable-select .option:hover {
      background: #f5f5f5;
    }

    .searchable-select .option.selected {
      background: #e8e9f3;
      color: #5e6ad2;
    }

    .searchable-select .option.hidden {
      display: none;
    }

    .searchable-select .no-results {
      padding: 10px 12px;
      color: #999;
      font-size: 13px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>
      <span>Create Linear Issue</span>
      <button type="button" class="settings-btn" id="settingsBtn" title="Settings">&#9881;</button>
    </h1>

    <img id="preview" class="preview" src="" alt="Screenshot preview" />

    <div class="row" style="margin-bottom: 14px;">
      <div class="form-group" style="flex: 2;">
        <label for="aiModel">AI Model</label>
        <select id="aiModel" name="aiModel">
          <option value="gemini" selected>Gemini 3 Flash (Í∏∞Î≥∏)</option>
          <option value="haiku">Claude Haiku 4.5</option>
        </select>
      </div>
      <div class="form-group" style="flex: 1; display: flex; align-items: flex-end;">
        <button type="button" id="reanalyzeBtn" class="btn-submit" style="width: 100%; padding: 10px;">Ïû¨Î∂ÑÏÑù</button>
      </div>
    </div>

    <div id="aiLoading" class="ai-loading">
      <div class="spinner"></div>
      <span id="aiLoadingText">AIÍ∞Ä Ïä§ÌÅ¨Î¶∞ÏÉ∑ÏùÑ Î∂ÑÏÑù Ï§ë...</span>
    </div>

    <form id="issueForm">
      <div class="form-group">
        <label for="title">Title *</label>
        <input type="text" id="title" name="title" required placeholder="ÎåÄÏÉÅ - Íµ¨Ï≤¥Ï†Å ÎÇ¥Ïö© (Ïòà: Î°úÍ∑∏Ïù∏ - ÏÑ∏ÏÖò ÎßåÎ£å Ïò§Î•ò ÏàòÏ†ï)" />
      </div>

      <div class="form-group">
        <label for="description">Description</label>
        <textarea id="description" name="description" placeholder="Optional description..."></textarea>
      </div>

      <div class="row">
        <div class="form-group">
          <label for="team">Team *</label>
          <select id="team" name="team" required>
            <option value="">Select team...</option>
          </select>
        </div>

        <div class="form-group">
          <label for="project">Project</label>
          <div class="searchable-select" id="projectContainer">
            <button type="button" class="select-trigger" id="projectTrigger">
              <span>None</span>
            </button>
            <div class="dropdown" id="projectDropdown">
              <input type="text" class="search-input" id="projectSearch" placeholder="Search projects...">
              <div class="options" id="projectOptions"></div>
            </div>
            <input type="hidden" id="project" name="project" value="">
          </div>
        </div>
      </div>

      <div class="row">
        <div class="form-group">
          <label for="status">Status</label>
          <select id="status" name="status">
            <option value="">Default</option>
          </select>
        </div>

        <div class="form-group">
          <label for="priority">Priority</label>
          <select id="priority" name="priority">
            <option value="">No priority</option>
            <option value="1">üî¥ Urgent</option>
            <option value="2">üü† High</option>
            <option value="3">üü° Medium</option>
            <option value="4">üü¢ Low</option>
          </select>
        </div>
      </div>

      <div class="row">
        <div class="form-group">
          <label for="assignee">Assignee</label>
          <div class="searchable-select" id="assigneeContainer">
            <button type="button" class="select-trigger" id="assigneeTrigger">
              <span>Unassigned</span>
            </button>
            <div class="dropdown" id="assigneeDropdown">
              <input type="text" class="search-input" id="assigneeSearch" placeholder="Search assignees...">
              <div class="options" id="assigneeOptions"></div>
            </div>
            <input type="hidden" id="assignee" name="assignee" value="">
          </div>
        </div>

        <div class="form-group">
          <label for="estimate">Estimate</label>
          <select id="estimate" name="estimate">
            <option value="">None</option>
          </select>
        </div>
      </div>

      <div class="form-group">
        <label for="cycle">Cycle</label>
        <select id="cycle" name="cycle">
          <option value="">None</option>
        </select>
      </div>

      <div id="error" class="error"></div>

      <div class="buttons">
        <button type="button" class="btn-cancel" id="cancelBtn">Cancel</button>
        <button type="submit" class="btn-submit" id="submitBtn">Create Issue</button>
      </div>
    </form>

    <div id="loading" class="loading">Creating issue...</div>
  </div>

  <script>
    const { ipcRenderer } = require('electron');

    const form = document.getElementById('issueForm');
    const preview = document.getElementById('preview');
    const titleInput = document.getElementById('title');
    const descInput = document.getElementById('description');
    const teamSelect = document.getElementById('team');
    const projectInput = document.getElementById('project');
    const statusSelect = document.getElementById('status');
    const prioritySelect = document.getElementById('priority');
    const assigneeInput = document.getElementById('assignee');
    const estimateSelect = document.getElementById('estimate');
    const cycleSelect = document.getElementById('cycle');
    const cancelBtn = document.getElementById('cancelBtn');
    const submitBtn = document.getElementById('submitBtn');
    const errorDiv = document.getElementById('error');
    const loadingDiv = document.getElementById('loading');
    const aiLoadingDiv = document.getElementById('aiLoading');
    const aiLoadingText = document.getElementById('aiLoadingText');
    const aiModelSelect = document.getElementById('aiModel');
    const reanalyzeBtn = document.getElementById('reanalyzeBtn');

    let currentFilePath = '';

    // Searchable select elements
    const projectTrigger = document.getElementById('projectTrigger');
    const projectDropdown = document.getElementById('projectDropdown');
    const projectSearch = document.getElementById('projectSearch');
    const projectOptions = document.getElementById('projectOptions');

    const assigneeTrigger = document.getElementById('assigneeTrigger');
    const assigneeDropdown = document.getElementById('assigneeDropdown');
    const assigneeSearch = document.getElementById('assigneeSearch');
    const assigneeOptions = document.getElementById('assigneeOptions');

    let imageUrl = '';
    let allStates = [];
    let allCycles = [];
    let allTeams = [];
    let allProjects = [];
    let allUsers = [];

    // Searchable select helper functions
    function createSearchableSelect(config) {
      const { trigger, dropdown, searchInput, optionsContainer, hiddenInput, items, defaultLabel, getValue, getLabel } = config;

      function render(filteredItems) {
        optionsContainer.innerHTML = '';

        // Add default option
        const defaultOpt = document.createElement('div');
        defaultOpt.className = 'option' + (hiddenInput.value === '' ? ' selected' : '');
        defaultOpt.textContent = defaultLabel;
        defaultOpt.dataset.value = '';
        defaultOpt.addEventListener('click', () => selectOption('', defaultLabel));
        optionsContainer.appendChild(defaultOpt);

        if (filteredItems.length === 0 && searchInput.value) {
          const noResults = document.createElement('div');
          noResults.className = 'no-results';
          noResults.textContent = 'No results found';
          optionsContainer.appendChild(noResults);
        } else {
          filteredItems.forEach(item => {
            const opt = document.createElement('div');
            opt.className = 'option' + (hiddenInput.value === getValue(item) ? ' selected' : '');
            opt.textContent = getLabel(item);
            opt.dataset.value = getValue(item);
            opt.addEventListener('click', () => selectOption(getValue(item), getLabel(item)));
            optionsContainer.appendChild(opt);
          });
        }
      }

      function selectOption(value, label) {
        hiddenInput.value = value;
        trigger.querySelector('span').textContent = label;
        dropdown.classList.remove('open');
        searchInput.value = '';
        render(items);
      }

      function filter() {
        const query = searchInput.value.toLowerCase();
        const filtered = items.filter(item => getLabel(item).toLowerCase().includes(query));
        render(filtered);
      }

      trigger.addEventListener('click', (e) => {
        e.stopPropagation();
        // Close other dropdowns
        document.querySelectorAll('.dropdown.open').forEach(d => {
          if (d !== dropdown) d.classList.remove('open');
        });
        dropdown.classList.toggle('open');
        if (dropdown.classList.contains('open')) {
          searchInput.focus();
        }
      });

      searchInput.addEventListener('input', filter);
      searchInput.addEventListener('click', (e) => e.stopPropagation());

      return { render, selectOption, setItems: (newItems) => { items.length = 0; items.push(...newItems); render(items); } };
    }

    // Close dropdowns when clicking outside
    document.addEventListener('click', () => {
      document.querySelectorAll('.dropdown.open').forEach(d => d.classList.remove('open'));
    });

    // Initialize searchable selects
    let projectSearchable, assigneeSearchable;

    // Generate estimate options based on team settings
    function getEstimateOptions(team) {
      if (!team || team.issueEstimationType === 'notUsed') {
        return [];
      }

      const type = team.issueEstimationType;
      const allowZero = team.issueEstimationAllowZero;
      const extended = team.issueEstimationExtended;

      let options = [];

      if (type === 'fibonacci') {
        // Linear default fibonacci scale
        if (allowZero) options.push({ value: 0, label: '0' });
        if (extended) options.push({ value: 0.5, label: '0.5' });
        options.push(
          { value: 1, label: '1' },
          { value: 2, label: '2' },
          { value: 3, label: '3' },
          { value: 5, label: '5' },
          { value: 8, label: '8' }
        );
        if (extended) {
          options.push(
            { value: 13, label: '13' },
            { value: 21, label: '21' }
          );
        }
      } else if (type === 'exponential') {
        if (allowZero) options.push({ value: 0, label: '0' });
        options.push(
          { value: 1, label: '1' },
          { value: 2, label: '2' },
          { value: 4, label: '4' },
          { value: 8, label: '8' },
          { value: 16, label: '16' }
        );
        if (extended) {
          options.push({ value: 32, label: '32' });
        }
      } else if (type === 'linear') {
        if (allowZero) options.push({ value: 0, label: '0' });
        for (let i = 1; i <= (extended ? 10 : 5); i++) {
          options.push({ value: i, label: String(i) });
        }
      } else if (type === 'tShirt') {
        // T-shirt sizes mapped to numbers
        if (allowZero) options.push({ value: 0, label: 'None' });
        options.push(
          { value: 1, label: 'XS' },
          { value: 2, label: 'S' },
          { value: 3, label: 'M' },
          { value: 5, label: 'L' },
          { value: 8, label: 'XL' }
        );
        if (extended) {
          options.push({ value: 13, label: 'XXL' });
        }
      }

      return options;
    }

    // Update estimate dropdown based on team
    function updateEstimateDropdown(teamId) {
      const team = allTeams.find(t => t.id === teamId);
      estimateSelect.innerHTML = '<option value="">None</option>';

      const options = getEstimateOptions(team);
      options.forEach(opt => {
        const option = document.createElement('option');
        option.value = opt.value;
        option.textContent = opt.label + (opt.value !== 0 && typeof opt.value === 'number' && opt.label !== 'None' && !isNaN(Number(opt.label)) ? ' point' + (opt.value !== 1 ? 's' : '') : '');
        estimateSelect.appendChild(option);
      });
    }

    // Update status, cycle, and estimate dropdowns based on selected team
    function updateTeamDependentDropdowns(teamId) {
      // Update status dropdown (default to Todo)
      statusSelect.innerHTML = '';
      const teamStates = allStates.filter(state => state.teamId === teamId);
      const todoState = teamStates.find(state => state.name === 'Todo');

      teamStates.forEach(state => {
        const option = document.createElement('option');
        option.value = state.id;
        option.textContent = state.name;
        // Set Todo as default selected
        if (todoState && state.id === todoState.id) {
          option.selected = true;
        }
        statusSelect.appendChild(option);
      });

      // Update cycle dropdown
      cycleSelect.innerHTML = '<option value="">None</option>';
      const now = new Date();
      allCycles
        .filter(cycle => cycle.teamId === teamId)
        .forEach(cycle => {
          const option = document.createElement('option');
          option.value = cycle.id;

          // Format dates (MÏõî DÏùº)
          const startDate = new Date(cycle.startsAt);
          const endDate = new Date(cycle.endsAt);
          const formatDate = (d) => `${d.getMonth() + 1}Ïõî ${d.getDate()}Ïùº`;

          // Determine cycle status
          let status = '';
          if (now >= startDate && now <= endDate) {
            status = 'Current';
          } else if (startDate > now) {
            status = 'Upcoming';
          } else {
            status = 'Previous';
          }

          option.textContent = `Cycle ${cycle.number} (${formatDate(startDate)} - ${formatDate(endDate)}) ¬∑ ${status}`;
          cycleSelect.appendChild(option);
        });

      // Update estimate dropdown
      updateEstimateDropdown(teamId);
    }

    // Receive capture data from main process
    ipcRenderer.on('capture-ready', (event, data) => {
      console.log('Capture ready:', data);

      try {
      // Store teams, states, cycles, projects, users for filtering
      allTeams = data.teams || [];
      allStates = data.states || [];
      allCycles = data.cycles || [];
      allProjects = data.projects || [];
      allUsers = data.users || [];

      console.log('AI analysis result:', { title: data.suggestedTitle, desc: data.suggestedDescription });

      // Show preview
      preview.src = `file://${data.filePath}`;
      imageUrl = data.imageUrl;
      currentFilePath = data.filePath;

      // Populate teams
      teamSelect.innerHTML = '<option value="">Select team...</option>';
      data.teams.forEach(team => {
        const option = document.createElement('option');
        option.value = team.id;
        option.textContent = `${team.name} (${team.key})`;
        if (team.id === data.defaultTeamId) {
          option.selected = true;
        }
        teamSelect.appendChild(option);
      });

      // Initialize searchable project dropdown
      projectSearchable = createSearchableSelect({
        trigger: projectTrigger,
        dropdown: projectDropdown,
        searchInput: projectSearch,
        optionsContainer: projectOptions,
        hiddenInput: projectInput,
        items: allProjects,
        defaultLabel: 'None',
        getValue: (p) => p.id,
        getLabel: (p) => p.name
      });
      projectSearchable.render(allProjects);

      // Initialize searchable assignee dropdown
      assigneeSearchable = createSearchableSelect({
        trigger: assigneeTrigger,
        dropdown: assigneeDropdown,
        searchInput: assigneeSearch,
        optionsContainer: assigneeOptions,
        hiddenInput: assigneeInput,
        items: allUsers,
        defaultLabel: 'Unassigned',
        getValue: (u) => u.id,
        getLabel: (u) => u.name
      });
      assigneeSearchable.render(allUsers);

      // Initialize team-dependent dropdowns
      if (data.defaultTeamId) {
        updateTeamDependentDropdowns(data.defaultTeamId);
      }

      // Show AI loading spinner (AI analysis is in progress)
      aiLoadingDiv.classList.remove('hidden');

      // Reset form state
      titleInput.value = '';
      descInput.value = '';
      prioritySelect.value = '';
      estimateSelect.value = '';
      errorDiv.textContent = '';
      submitBtn.disabled = false;
      form.style.display = 'block';
      loadingDiv.style.display = 'none';

      // Set default project if available
      if (data.defaultProjectId) {
        const project = allProjects.find(p => p.id === data.defaultProjectId);
        if (project) {
          projectSearchable.selectOption(project.id, project.name);
        }
      }

      // Focus title input
      titleInput.focus();
      } catch (error) {
        console.error('Error in capture-ready handler:', error);
      }
    });

    // Handle AI analysis results (received after window is shown)
    ipcRenderer.on('ai-analysis-ready', (event, data) => {
      console.log('AI analysis ready:', data);

      // Hide AI loading spinner
      aiLoadingDiv.classList.add('hidden');
      reanalyzeBtn.disabled = false;

      if (!data.success) {
        console.log('AI analysis failed or skipped');
        return;
      }

      // Apply AI suggestions
      if (data.title) {
        titleInput.value = data.title;
        titleInput.select();
      }
      if (data.description) {
        descInput.value = data.description;
      }
      if (data.suggestedProjectId) {
        const project = allProjects.find(p => p.id === data.suggestedProjectId);
        if (project) {
          projectSearchable.selectOption(project.id, project.name);
        }
      }
      if (data.suggestedAssigneeId) {
        const user = allUsers.find(u => u.id === data.suggestedAssigneeId);
        if (user) {
          assigneeSearchable.selectOption(user.id, user.name);
        }
      }
      if (data.suggestedPriority) {
        prioritySelect.value = data.suggestedPriority.toString();
      }
      if (data.suggestedEstimate) {
        estimateSelect.value = data.suggestedEstimate.toString();
      }
    });

    // Update dropdowns when team changes
    teamSelect.addEventListener('change', () => {
      updateTeamDependentDropdowns(teamSelect.value);
    });

    // Handle form submission
    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      const title = titleInput.value.trim();
      const description = descInput.value.trim();
      const teamId = teamSelect.value;
      const projectId = projectInput.value;
      const stateId = statusSelect.value;
      const priority = prioritySelect.value;
      const assigneeId = assigneeInput.value;
      const estimate = estimateSelect.value;
      const cycleId = cycleSelect.value;

      if (!title) {
        errorDiv.textContent = 'Title is required';
        return;
      }

      if (!teamId) {
        errorDiv.textContent = 'Team is required';
        return;
      }

      errorDiv.textContent = '';
      submitBtn.disabled = true;
      form.style.display = 'none';
      loadingDiv.style.display = 'block';

      try {
        const result = await ipcRenderer.invoke('create-issue', {
          title,
          description,
          teamId,
          projectId: projectId || undefined,
          stateId: stateId || undefined,
          priority: priority ? parseInt(priority, 10) : undefined,
          assigneeId: assigneeId || undefined,
          estimate: estimate ? parseInt(estimate, 10) : undefined,
          cycleId: cycleId || undefined,
        });

        if (!result.success) {
          form.style.display = 'block';
          loadingDiv.style.display = 'none';
          submitBtn.disabled = false;
          errorDiv.textContent = result.error || 'Failed to create issue';
        }
        // Success case: window will be hidden by main process
      } catch (err) {
        form.style.display = 'block';
        loadingDiv.style.display = 'none';
        submitBtn.disabled = false;
        errorDiv.textContent = err.message || 'Unknown error';
      }
    });

    // Handle cancel
    cancelBtn.addEventListener('click', () => {
      ipcRenderer.invoke('cancel');
    });

    // Handle settings button
    document.getElementById('settingsBtn').addEventListener('click', () => {
      ipcRenderer.invoke('open-settings');
    });

    // Handle Escape key
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        ipcRenderer.invoke('cancel');
      }
    });

    // Handle re-analyze button
    reanalyzeBtn.addEventListener('click', async () => {
      if (!currentFilePath) return;

      const model = aiModelSelect.value;
      const modelName = model === 'haiku' ? 'Claude Haiku 4.5' : 'Gemini 3 Flash';

      // Show loading
      aiLoadingText.textContent = `${modelName}Î°ú Ïû¨Î∂ÑÏÑù Ï§ë...`;
      aiLoadingDiv.classList.remove('hidden');
      reanalyzeBtn.disabled = true;

      try {
        await ipcRenderer.invoke('reanalyze', {
          filePath: currentFilePath,
          model: model
        });
      } catch (err) {
        console.error('Reanalyze error:', err);
        aiLoadingDiv.classList.add('hidden');
        reanalyzeBtn.disabled = false;
      }
    });
  </script>
</body>
</html>
