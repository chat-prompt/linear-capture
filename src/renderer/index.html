<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title data-i18n="capture.title">Create Linear Issue</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f5f5f5;
      padding: 0;
      margin: 0;
      height: 100vh;
      overflow: hidden;
    }

    /* Top bar with traffic lights and settings */
    .top-bar {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: 40px;
      background: #f5f5f5;
      display: flex;
      align-items: center;
      justify-content: flex-end; /* Ïö∞Ï∏° Ï†ïÎ†¨ */
      padding: 0 16px;
      z-index: 1000;
      -webkit-app-region: drag;
    }

    .container {
      background: white;
      border-radius: 12px;
      margin: 52px 20px 20px 20px; /* top margin for top-bar */
      padding: 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      -webkit-app-region: no-drag;
      max-height: calc(100vh - 72px);
      overflow-y: auto;
    }

    h1 {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 0;
      color: #333;
    }

    /* Image Gallery */
    .image-gallery {
      display: flex;
      gap: 12px;
      overflow-x: auto;
      padding: 12px 0;
      margin-bottom: 16px;
      min-height: 100px;
      scrollbar-width: thin;
    }

    .image-gallery::-webkit-scrollbar {
      height: 6px;
    }

    .image-gallery::-webkit-scrollbar-track {
      background: #f0f0f0;
      border-radius: 3px;
    }

    .image-gallery::-webkit-scrollbar-thumb {
      background: #ccc;
      border-radius: 3px;
    }

    .gallery-item {
      position: relative;
      flex-shrink: 0;
      width: 120px;
      height: 90px;
      border-radius: 8px;
      overflow: hidden;
      border: 1px solid #e0e0e0;
      background: #fafafa;
    }

    .gallery-thumb {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .gallery-remove {
      position: absolute;
      top: 4px;
      right: 4px;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: rgba(0,0,0,0.6);
      color: white;
      border: none;
      cursor: pointer;
      font-size: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      line-height: 1;
      padding: 0;
      transition: background 0.2s;
    }

    .gallery-remove:hover {
      background: rgba(220,53,69,0.9);
    }

    .gallery-index {
      position: absolute;
      bottom: 4px;
      left: 4px;
      background: rgba(0,0,0,0.6);
      color: white;
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 4px;
    }

    .gallery-add {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: #f8f8f8;
      border: 2px dashed #ccc;
      cursor: pointer;
      transition: all 0.2s;
    }

    .gallery-add:hover {
      background: #e8e9f3;
      border-color: #5e6ad2;
    }

    .gallery-add.disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .gallery-add-icon {
      font-size: 24px;
      color: #666;
    }

    .gallery-add-text {
      font-size: 11px;
      color: #666;
      margin-top: 4px;
    }

    .preview {
      width: 100%;
      max-height: 150px;
      object-fit: contain;
      border-radius: 8px;
      border: 1px solid #e0e0e0;
      margin-bottom: 16px;
      background: #fafafa;
      display: none; /* Hidden, replaced by gallery */
    }

    .form-group {
      margin-bottom: 14px;
    }

    label {
      display: block;
      font-size: 13px;
      font-weight: 500;
      color: #555;
      margin-bottom: 6px;
    }

    input[type="text"],
    textarea,
    select {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 14px;
      font-family: inherit;
      transition: border-color 0.2s;
      -webkit-app-region: no-drag;
    }

    input[type="text"]:focus,
    textarea:focus,
    select:focus {
      outline: none;
      border-color: #5e6ad2;
    }

    textarea {
      resize: vertical;
      min-height: 144px; /* Í∏∞Î≥∏ ÎÜíÏù¥ 80% Ï¶ùÍ∞Ä (80px ‚Üí 144px) */
    }

    .row {
      display: flex;
      gap: 12px;
    }

    .row .form-group {
      flex: 1;
    }

    .buttons {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
      margin-top: 16px;
    }

    button {
      padding: 10px 20px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-cancel {
      background: #f5f5f5;
      border: 1px solid #ddd;
      color: #666;
    }

    .btn-cancel:hover {
      background: #eee;
    }

    .btn-submit {
      background: #5e6ad2;
      border: none;
      color: white;
    }

    .btn-submit:hover {
      background: #4c5abd;
    }

    .btn-submit:disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    .loading {
      display: none;
      text-align: center;
      padding: 20px;
      color: #666;
    }

    .error {
      color: #e74c3c;
      font-size: 13px;
      margin-top: 8px;
    }

    /* AI Loading spinner */
    .ai-loading {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      background: #f0f1ff;
      border-radius: 8px;
      margin-bottom: 14px;
      font-size: 13px;
      color: #5e6ad2;
    }

    .ai-loading.hidden {
      display: none;
    }

    .spinner {
      width: 16px;
      height: 16px;
      border: 2px solid #e0e0ff;
      border-top-color: #5e6ad2;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Searchable dropdown styles */
    .searchable-select {
      position: relative;
    }

    .searchable-select .select-trigger {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 14px;
      font-family: inherit;
      background: white;
      cursor: pointer;
      text-align: left;
      display: flex;
      justify-content: space-between;
      align-items: center;
      -webkit-app-region: no-drag;
    }

    .searchable-select .select-trigger:focus {
      outline: none;
      border-color: #5e6ad2;
    }

    .searchable-select .select-trigger::after {
      content: '‚ñº';
      font-size: 10px;
      color: #999;
    }

    .searchable-select .dropdown {
      display: none;
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: white;
      border: 1px solid #ddd;
      border-radius: 8px;
      margin-top: 4px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      z-index: 1000;
      max-height: 200px;
      overflow: hidden;
    }

    .searchable-select .dropdown.open {
      display: block;
    }

    .searchable-select .search-input {
      width: 100%;
      padding: 10px 12px;
      border: none;
      border-bottom: 1px solid #eee;
      font-size: 14px;
      outline: none;
    }

    .searchable-select .options {
      max-height: 150px;
      overflow-y: auto;
    }

    .searchable-select .option {
      padding: 10px 12px;
      cursor: pointer;
      font-size: 14px;
    }

    .searchable-select .option:hover {
      background: #f5f5f5;
    }

    .searchable-select .option.selected {
      background: #e8e9f3;
      color: #5e6ad2;
    }

    .searchable-select .option.hidden {
      display: none;
    }

    .searchable-select .no-results {
      padding: 10px 12px;
      color: #999;
      font-size: 13px;
    }

    /* Header */
    .header {
      margin-bottom: 16px;
    }

    /* Settings button in top-bar */
    .icon-btn {
      background: transparent;
      border: none; /* Î∞ïÏä§ Ï†úÍ±∞ */
      width: auto;
      height: auto;
      padding: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 21px; /* 1.5Î∞∞ ÌÅ¨Í∏∞ (14px * 1.5 = 21px) */
      cursor: pointer;
      transition: opacity 0.2s;
      -webkit-app-region: no-drag;
      opacity: 0.7;
    }

    .icon-btn:hover {
      opacity: 1;
    }

    /* Image Preview Modal */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 2000;
      display: flex;
      align-items: center;
      justify-content: center;
      -webkit-app-region: no-drag; /* Ïã†Ìò∏Îì± ÌÅ¥Î¶≠ Î∞©ÏßÄ */
    }

    .modal.hidden {
      display: none;
    }

    .modal-backdrop {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      -webkit-app-region: no-drag; /* Ïã†Ìò∏Îì± ÌÅ¥Î¶≠ Î∞©ÏßÄ */
    }

    .modal-content {
      position: relative;
      max-width: 90vw;
      max-height: 90vh;
    }

    .modal-content img {
      max-width: 100%;
      max-height: 85vh;
      object-fit: contain;
      border-radius: 8px;
      box-shadow: 0 4px 24px rgba(0, 0, 0, 0.3);
    }

    .modal-close {
      position: absolute;
      top: -12px;
      right: -12px;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: #fff;
      border: none;
      font-size: 20px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
      padding: 0;
      line-height: 1;
    }

    .modal-close:hover {
      background: #f0f0f0;
    }

    .gallery-thumb {
      cursor: pointer;
    }

    /* Success Screen */
    .success-screen {
      text-align: center;
      padding: 40px 20px;
    }

    .success-screen.hidden {
      display: none;
    }

    .success-icon {
      font-size: 48px;
      margin-bottom: 16px;
    }

    .success-title {
      font-size: 18px;
      font-weight: 600;
      color: #1a1a1a;
      margin-bottom: 8px;
    }

    .success-issue-id {
      font-size: 14px;
      color: #5e6ad2;
      font-weight: 500;
      margin-bottom: 24px;
    }

    .success-buttons {
      display: flex;
      gap: 12px;
      justify-content: center;
      margin-bottom: 16px;
    }

    .success-buttons .btn-submit,
    .success-buttons .btn-cancel {
      min-width: 120px;
    }

    .success-hint {
      font-size: 12px;
      color: #888;
    }

    /* Shortcut hint */
    .shortcut-hint {
      font-size: 12px;
      color: #888;
      margin-top: 4px;
    }

    .shortcut-hint kbd {
      background: #f0f0f0;
      padding: 2px 6px;
      border-radius: 4px;
      border: 1px solid #ddd;
      font-family: -apple-system, BlinkMacSystemFont, monospace;
      font-size: 11px;
    }

    /* Token warning banner */
    .token-warning {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      background: #fef3cd;
      border: 1px solid #ffc107;
      border-radius: 8px;
      padding: 12px 16px;
      margin-bottom: 16px;
    }

    .token-warning.hidden {
      display: none;
    }

    .token-warning-content {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
      color: #856404;
    }

    .token-warning-icon {
      font-size: 16px;
    }

    .token-warning-btn {
      padding: 6px 12px;
      background: #fff;
      border: 1px solid #ffc107;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 500;
      color: #856404;
      cursor: pointer;
      white-space: nowrap;
      transition: all 0.2s;
    }

    .token-warning-btn:hover {
      background: #fff3cd;
    }

    /* Label Multi-select Styles */
    .label-select {
      position: relative;
    }

    .label-chips-container {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      padding: 8px 10px;
      min-height: 42px;
      border: 1px solid #ddd;
      border-radius: 8px;
      background: white;
      cursor: pointer;
      transition: border-color 0.2s;
      align-items: center;
    }

    .label-chips-container:hover {
      border-color: #bbb;
    }

    .label-chips-container:focus-within {
      border-color: #5e6ad2;
    }

    .label-chip {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 3px 8px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 500;
      background: #f0f0f0;
      color: #333;
    }

    .label-chip-color {
      width: 8px;
      height: 8px;
      border-radius: 50%;
    }

    .label-chip-remove {
      background: none;
      border: none;
      padding: 0;
      margin-left: 2px;
      cursor: pointer;
      font-size: 14px;
      line-height: 1;
      color: #666;
      opacity: 0.6;
    }

    .label-chip-remove:hover {
      opacity: 1;
    }

    .label-add-btn {
      background: none;
      border: none;
      padding: 3px 8px;
      font-size: 12px;
      color: #888;
      cursor: pointer;
    }

    .label-add-btn:hover {
      color: #5e6ad2;
    }

    .label-dropdown {
      display: none;
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: white;
      border: 1px solid #ddd;
      border-radius: 8px;
      margin-top: 4px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      z-index: 1000;
      max-height: 220px;
      overflow: hidden;
    }

    .label-dropdown.open {
      display: block;
    }

    .label-search-input {
      width: 100%;
      padding: 10px 12px;
      border: none;
      border-bottom: 1px solid #eee;
      font-size: 14px;
      outline: none;
    }

    .label-options {
      max-height: 170px;
      overflow-y: auto;
    }

    .label-option {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 12px;
      cursor: pointer;
      font-size: 14px;
    }

    .label-option:hover {
      background: #f5f5f5;
    }

    .label-option.selected {
      background: #e8e9f3;
    }

    .label-option.hidden {
      display: none;
    }

    .label-option-color {
      width: 12px;
      height: 12px;
      border-radius: 3px;
      flex-shrink: 0;
    }

    .label-option-name {
      flex: 1;
    }

    .label-option-check {
      font-size: 14px;
      color: #5e6ad2;
    }

    .label-no-results {
      padding: 12px;
      color: #888;
      font-size: 13px;
      text-align: center;
    }

    .label-empty-hint {
      color: #999;
      font-size: 13px;
    }

    /* Context Search Section */
    .context-section {
      margin-bottom: 16px;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      overflow: hidden;
    }

    .context-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 12px;
      background: #f8f9fa;
      cursor: pointer;
      user-select: none;
    }

    .context-header:hover {
      background: #f0f1f3;
    }

    .context-header-left {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .context-header-icon {
      font-size: 16px;
    }

    .context-header-title {
      font-size: 13px;
      font-weight: 500;
      color: #333;
    }

    .context-header-badge {
      background: #5e6ad2;
      color: white;
      font-size: 11px;
      padding: 2px 6px;
      border-radius: 10px;
      margin-left: 4px;
    }

    .context-header-toggle {
      font-size: 12px;
      color: #666;
      transition: transform 0.2s;
    }

    .context-section.expanded .context-header-toggle {
      transform: rotate(180deg);
    }

    .context-body {
      display: none;
      padding: 12px;
      border-top: 1px solid #e0e0e0;
    }

    .context-section.expanded .context-body {
      display: block;
    }

    .context-tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 12px;
    }

    .context-tab {
      padding: 6px 12px;
      border: 1px solid #ddd;
      border-radius: 6px;
      background: white;
      font-size: 12px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .context-tab:hover {
      background: #f5f5f5;
    }

    .context-tab.active {
      background: #5e6ad2;
      color: white;
      border-color: #5e6ad2;
    }

    .context-tab.disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .context-tab-icon {
      font-size: 14px;
    }

    .context-search-row {
      display: flex;
      gap: 8px;
      margin-bottom: 12px;
    }

    .context-search-input {
      flex: 1;
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 13px;
    }

    .context-search-input:focus {
      outline: none;
      border-color: #5e6ad2;
    }

    .context-search-btn {
      padding: 8px 16px;
      background: #5e6ad2;
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 13px;
      cursor: pointer;
    }

    .context-search-btn:hover {
      background: #4c5abd;
    }

    .context-search-btn:disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    .context-results {
      max-height: 200px;
      overflow-y: auto;
      border: 1px solid #e0e0e0;
      border-radius: 6px;
    }

    .context-result-item {
      display: flex;
      align-items: flex-start;
      gap: 10px;
      padding: 10px 12px;
      border-bottom: 1px solid #eee;
      cursor: pointer;
    }

    .context-result-item:last-child {
      border-bottom: none;
    }

    .context-result-item:hover {
      background: #f8f9fa;
    }

    .context-result-item.selected {
      background: #e8e9f3;
    }

    .context-result-checkbox {
      margin-top: 2px;
    }

    .context-result-content {
      flex: 1;
      min-width: 0;
    }

    .context-result-meta {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 11px;
      color: #888;
      margin-bottom: 4px;
    }

    .context-result-channel {
      background: #f0f0f0;
      padding: 2px 6px;
      border-radius: 4px;
    }

    .context-result-text {
      font-size: 13px;
      color: #333;
      line-height: 1.4;
      overflow: hidden;
      text-overflow: ellipsis;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
    }

    .search-source-header {
      padding: 6px 12px;
      border-bottom: 1px solid #eee;
      background: #fafafa;
    }

    .search-source-badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 10px;
      font-size: 11px;
      font-weight: 500;
    }

    .search-source-badge.local {
      background: #e8f5e9;
      color: #2e7d32;
    }

    .search-source-badge.api {
      background: #fff3e0;
      color: #ef6c00;
    }

    .content-match-badge {
      background: #e3f2fd;
      color: #1565c0;
      padding: 1px 6px;
      border-radius: 8px;
      font-size: 10px;
    }

    .context-result-snippet {
      font-size: 11px;
      color: #666;
      font-style: italic;
      margin-top: 4px;
      padding: 4px 8px;
      background: #f5f5f5;
      border-radius: 4px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .context-empty {
      padding: 20px;
      text-align: center;
      color: #888;
      font-size: 13px;
    }

    .context-not-connected {
      padding: 16px;
      text-align: center;
    }

    .context-connect-btn {
      padding: 8px 16px;
      background: white;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 13px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .context-connect-btn:hover {
      background: #f5f5f5;
    }

    .context-loading {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 20px;
      color: #666;
      font-size: 13px;
    }

    .context-selected-count {
      font-size: 12px;
      color: #5e6ad2;
      margin-top: 8px;
    }

    /* Source Icon Styles */
    .related-context-result-source .source-icon {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 14px;
      height: 14px;
      margin-right: 4px;
      vertical-align: middle;
    }

    .related-context-result-source .source-icon svg {
      width: 12px;
      height: 12px;
    }

    /* Related Context Section */
    .related-context-section {
      margin-bottom: 16px;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      overflow: hidden;
      background: white;
    }

    .related-context-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 12px;
      background: #f8f9fa;
      cursor: pointer;
      user-select: none;
    }

    .related-context-header:hover {
      background: #f0f1f3;
    }

    .related-context-header-left {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .related-context-header-icon {
      font-size: 16px;
    }

    .related-context-header-title {
      font-size: 13px;
      font-weight: 500;
      color: #333;
    }

    .related-context-header-badge {
      background: #5e6ad2;
      color: white;
      font-size: 11px;
      padding: 2px 6px;
      border-radius: 10px;
    }

    .related-context-header-toggle {
      font-size: 12px;
      color: #666;
      transition: transform 0.2s;
    }

    .related-context-section.expanded .related-context-header-toggle {
      transform: rotate(180deg);
    }

    .related-context-body {
      display: none;
      padding: 12px;
      border-top: 1px solid #e0e0e0;
    }

    .related-context-section.expanded .related-context-body {
      display: block;
    }

    .related-context-search-row {
      display: flex;
      gap: 8px;
      margin-bottom: 12px;
    }

    .related-context-search-input {
      flex: 1;
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 13px;
    }

    .related-context-search-input:focus {
      outline: none;
      border-color: #5e6ad2;
    }

    .related-context-refresh-btn {
      padding: 8px 12px;
      background: #f5f5f5;
      border: 1px solid #ddd;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
    }

    .related-context-refresh-btn:hover {
      background: #e8e8e8;
    }

    .related-context-refresh-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .related-context-status {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      background: #f0f7ff;
      border-radius: 6px;
      font-size: 12px;
      color: #1a73e8;
      margin-bottom: 12px;
    }

    .related-context-loading {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 20px;
      color: #666;
      font-size: 13px;
    }

    .related-context-results {
      max-height: 250px;
      overflow-y: auto;
      border: 1px solid #e0e0e0;
      border-radius: 6px;
      margin-bottom: 12px;
    }

    .related-context-result-item {
      display: flex;
      align-items: flex-start;
      gap: 10px;
      padding: 10px 12px;
      border-bottom: 1px solid #eee;
      cursor: pointer;
      transition: background 0.15s;
    }

    .related-context-result-item:last-child {
      border-bottom: none;
    }

    .related-context-result-item:hover {
      background: #f8f9fa;
    }

    .related-context-result-item.selected {
      background: #e8e9f3;
    }

    .related-context-result-checkbox {
      margin-top: 2px;
      width: 16px;
      height: 16px;
      cursor: pointer;
    }

    .related-context-result-content {
      flex: 1;
      min-width: 0;
    }

    .related-context-result-meta {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 11px;
      color: #888;
      margin-bottom: 4px;
    }

    .related-context-result-source {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 10px;
      font-weight: 500;
    }

    .related-context-result-source.slack {
      background: #f0f4f8;
      color: #4a154b;
    }

    .related-context-result-source.notion {
      background: #f5f5f5;
      color: #000;
    }

    .related-context-result-source.gmail {
      background: #fef3f2;
      color: #ea4335;
    }

    .related-context-result-source.linear {
      background: #f0f1ff;
      color: #5e6ad2;
    }

    .related-context-result-source.ai {
      background: #ecfdf5;
      color: #10b981;
    }

    .related-context-result-title {
      font-size: 13px;
      font-weight: 500;
      color: #333;
      margin-bottom: 2px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .related-context-result-snippet {
      font-size: 12px;
      color: #666;
      line-height: 1.4;
      overflow: hidden;
      text-overflow: ellipsis;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
    }

    .related-context-empty {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      padding: 20px;
      color: #888;
      font-size: 13px;
    }

    .related-context-not-connected-banner {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      padding: 12px 14px;
      background: #fff8e6;
      border: 1px solid #ffe0a3;
      border-radius: 8px;
      margin-bottom: 12px;
    }

    .not-connected-content {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .not-connected-icon {
      font-size: 16px;
    }

    .not-connected-text {
      font-size: 13px;
      color: #8a6d3b;
    }

    .not-connected-btn {
      padding: 6px 12px;
      background: white;
      border: 1px solid #ffe0a3;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 500;
      color: #8a6d3b;
      cursor: pointer;
      white-space: nowrap;
      transition: background 0.2s;
    }

    .not-connected-btn:hover {
      background: #fff8e6;
    }

    .related-context-actions {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding-top: 8px;
      border-top: 1px solid #eee;
    }

    .related-context-selected-count {
      font-size: 12px;
      color: #666;
    }

    .related-context-insert-btn {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 8px 14px;
      background: #5e6ad2;
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 13px;
      cursor: pointer;
    }

    .related-context-insert-btn:hover {
      background: #4c5abd;
    }

    .related-context-insert-btn:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
  </style>
  <link rel="stylesheet" href="semantic-search.css">
</head>
<body>
  <!-- Top bar with Settings button (aligned with traffic lights) -->
  <div class="top-bar">
    <button id="settingsBtn" class="icon-btn" title="Settings">‚öôÔ∏è</button>
  </div>

  <div class="container">
    <!-- Token warning banner -->
    <div id="tokenWarning" class="token-warning hidden">
      <div class="token-warning-content">
        <span class="token-warning-icon">‚ö†Ô∏è</span>
        <span data-i18n="dialogs.tokenWarning">Linear API token not set</span>
      </div>
      <button class="token-warning-btn" id="tokenWarningBtn" data-i18n="dialogs.tokenWarningButton">Set up</button>
    </div>

    <div class="header">
      <h1 data-i18n="capture.title">Create Linear Issue</h1>
      <div class="shortcut-hint" id="shortcutHint"></div>
    </div>

    <!-- Image Gallery (multiple images) -->
    <div id="imageGallery" class="image-gallery"></div>

    <!-- AI Analysis Section (hidden on success) -->
    <div id="aiAnalysisSection">
      <!-- User Hint Input -->
      <div class="form-group" style="margin-bottom: 14px;">
        <textarea id="userHint" data-i18n-placeholder="form.userHintPlaceholder" placeholder="(Optional) Write what the AI should focus on when creating the Linear issue" style="min-height: 60px; height: 60px; resize: none; font-size: 13px; padding: 8px 12px;"></textarea>
      </div>

      <!-- Legacy single preview (hidden) -->
      <img id="preview" class="preview" src="" alt="Screenshot preview" />

      <div class="row" style="margin-bottom: 14px;">
        <div class="form-group" style="flex: 2;">
          <label for="aiModel" data-i18n="form.aiModel">AI Model</label>
          <select id="aiModel" name="aiModel">
            <option value="gemini" selected>Gemini 3 Flash (Default)</option>
            <option value="haiku">Claude Haiku 4.5</option>
          </select>
        </div>
        <div class="form-group" style="flex: 1; display: flex; align-items: flex-end;">
          <button type="button" id="reanalyzeBtn" class="btn-submit" style="width: 100%; padding: 10px;">Start Analysis</button>
        </div>
      </div>
    </div>

    <div id="aiLoading" class="ai-loading hidden">
      <div class="spinner"></div>
      <span id="aiLoadingText" data-i18n="capture.analyzing">AI is analyzing the screenshot...</span>
    </div>

    <form id="issueForm">
      <div class="form-group">
        <label for="title" data-i18n="form.titleRequired">Title *</label>
        <input type="text" id="title" name="title" required data-i18n-placeholder="form.titlePlaceholder" placeholder="Target - Specific content (e.g., Login - Fix session expiry error)" />
      </div>

      <div class="form-group">
        <label for="description" data-i18n="form.description">Description</label>
        <textarea id="description" name="description" data-i18n-placeholder="form.descriptionPlaceholder" placeholder="Optional description..."></textarea>
      </div>

      <!-- Related Context Section (unified search for Slack, Notion, AI recommendations) -->
      <div id="relatedContextSection" class="related-context-section">
        <div class="related-context-header" id="relatedContextHeader">
          <div class="related-context-header-left">
            <span class="related-context-header-icon">üìé</span>
            <span class="related-context-header-title" data-i18n="relatedContext.findFrom">Find related content from Slack/Notion/Gmail</span>
            <span class="related-context-header-badge" id="relatedContextBadge" style="display: none;">0</span>
          </div>
          <span class="related-context-header-toggle">‚ñº</span>
        </div>
        <div class="related-context-body">
          <!-- Not Connected Banner -->
          <div id="relatedContextNotConnected" class="related-context-not-connected-banner" style="display: none;">
            <div class="not-connected-content">
              <span class="not-connected-icon">üîå</span>
              <span class="not-connected-text" data-i18n="relatedContext.notConnectedHint">Connect Slack, Notion, or Gmail to search related content</span>
            </div>
            <button type="button" class="not-connected-btn" id="relatedContextOpenSettings" data-i18n="relatedContext.openSettings">Open Settings</button>
          </div>
          <!-- Search Row -->
          <div class="related-context-search-row">
            <input type="text" 
                   class="related-context-search-input" 
                   id="relatedContextSearchInput" 
                   data-i18n-placeholder="relatedContext.searchPlaceholder"
                   placeholder="Search related context...">
            <button type="button" 
                    class="related-context-refresh-btn" 
                    id="relatedContextRefreshBtn" 
                    title="Reset to title">
              üîÑ
            </button>
          </div>
          
          <!-- Status Hint -->
          <div class="related-context-status" id="relatedContextStatus">
            <span>üí°</span>
            <span data-i18n="relatedContext.hint">Edit search to refine results</span>
          </div>
          
          <!-- Loading -->
          <div id="relatedContextLoading" class="related-context-loading" style="display: none;">
            <div class="spinner"></div>
            <span data-i18n="relatedContext.searching">Searching Slack, Notion...</span>
          </div>
          
          <!-- Results -->
          <div id="relatedContextResults" class="related-context-results"></div>
          
          <!-- Empty State -->
          <div id="relatedContextEmpty" class="related-context-empty" style="display: none;">
            <span>ü§∑</span>
            <span data-i18n="relatedContext.noResults">No results found. Try different keywords.</span>
          </div>
          
          <!-- Actions -->
          <div class="related-context-actions" id="relatedContextActions" style="display: none;">
            <span class="related-context-selected-count" id="relatedContextSelectedCount">0 selected</span>
            <button type="button" class="related-context-insert-btn" id="relatedContextInsertBtn" disabled>
              <span>üìé</span>
              <span data-i18n="relatedContext.insertToDescription">Insert to Description</span>
            </button>
          </div>
        </div>
      </div>

      <!-- Linear Section - No auto-translate -->
      <div id="linearSection" data-no-translate>
      <div class="row">
        <div class="form-group">
          <label for="team">Team *</label>
          <select id="team" name="team" required>
<option value="">Select team...</option>
          </select>
        </div>

        <div class="form-group">
          <label for="project">Project</label>
          <div class="searchable-select" id="projectContainer">
            <button type="button" class="select-trigger" id="projectTrigger">
              <span>None</span>
            </button>
            <div class="dropdown" id="projectDropdown">
              <input type="text" class="search-input" id="projectSearch" placeholder="Search projects...">
              <div class="options" id="projectOptions"></div>
            </div>
            <input type="hidden" id="project" name="project" value="">
          </div>
        </div>
      </div>

      <div class="row">
        <div class="form-group">
          <label for="status">Status</label>
          <select id="status" name="status">
            <option value="">Default</option>
          </select>
        </div>

        <div class="form-group">
          <label for="priority">Priority</label>
          <select id="priority" name="priority">
            <option value="">No priority</option>
            <option value="1">üî¥ Urgent</option>
            <option value="2">üü† High</option>
            <option value="3">üü° Medium</option>
            <option value="4">üü¢ Low</option>
          </select>
        </div>
      </div>

      <div class="row">
        <div class="form-group">
          <label for="assignee">Assignee</label>
          <div class="searchable-select" id="assigneeContainer">
            <button type="button" class="select-trigger" id="assigneeTrigger">
              <span>Unassigned</span>
            </button>
            <div class="dropdown" id="assigneeDropdown">
              <input type="text" class="search-input" id="assigneeSearch" placeholder="Search assignees...">
              <div class="options" id="assigneeOptions"></div>
            </div>
            <input type="hidden" id="assignee" name="assignee" value="">
          </div>
        </div>

        <div class="form-group">
          <label for="estimate">Estimate</label>
          <select id="estimate" name="estimate">
            <option value="">None</option>
          </select>
        </div>
      </div>

      <div class="row">
        <div class="form-group">
          <label for="cycle">Cycle</label>
          <select id="cycle" name="cycle">
            <option value="">None</option>
          </select>
        </div>

        <div class="form-group">
          <label>Labels</label>
          <div class="label-select" id="labelSelect">
            <div class="label-chips-container" id="labelChipsContainer">
              <span class="label-empty-hint" id="labelEmptyHint">+ Add labels...</span>
            </div>
            <div class="label-dropdown" id="labelDropdown">
              <input type="text" class="label-search-input" id="labelSearchInput" placeholder="Search labels...">
              <div class="label-options" id="labelOptions"></div>
            </div>
          </div>
        </div>
      </div>
      </div><!-- End linearSection -->

      <div id="error" class="error"></div>

      <div class="buttons">
        <button type="button" class="btn-cancel" id="cancelBtn" data-i18n="common.cancel">Cancel</button>
        <button type="submit" class="btn-submit" id="submitBtn" data-i18n="form.createIssue">Create Issue</button>
      </div>
    </form>

    <div id="loading" class="loading">
      <div class="spinner" style="margin: 0 auto 10px;"></div>
      <span id="loadingText">Creating issue...</span>
    </div>

    <!-- Success Screen -->
    <div id="successScreen" class="success-screen hidden">
      <div class="success-icon">‚úÖ</div>
      <div class="success-title" data-i18n="success.title">Issue created!</div>
      <div class="success-issue-id" id="successIssueId"></div>
      <div class="success-buttons">
        <button type="button" class="btn-submit" id="viewIssueBtn" data-i18n="success.viewInLinear">View in Linear</button>
        <button type="button" class="btn-cancel" id="closeSuccessBtn" data-i18n="common.close">Close</button>
      </div>
      <div class="success-hint" data-i18n="success.urlCopied">URL copied to clipboard</div>
    </div>
  </div>

  <!-- Image Preview Modal -->
  <div id="imageModal" class="modal hidden">
    <div class="modal-backdrop"></div>
    <div class="modal-content">
      <img id="modalImage" src="" alt="Preview" />
      <button class="modal-close" title="Close">√ó</button>
    </div>
  </div>

  <script>
    console.log('[index.html] Script loading...');
    const { ipcRenderer } = require('electron');
    window.ipcRenderer = ipcRenderer;

    // ==================== i18n Functions ====================
    async function t(key, options = {}) {
      return await ipcRenderer.invoke('translate', key, options);
    }

    async function translatePage() {
      const elements = document.querySelectorAll('[data-i18n]');
      for (const el of elements) {
        const key = el.getAttribute('data-i18n');
        el.textContent = await t(key);
      }
      const placeholders = document.querySelectorAll('[data-i18n-placeholder]');
      for (const el of placeholders) {
        const key = el.getAttribute('data-i18n-placeholder');
        el.placeholder = await t(key);
      }
      document.title = await t('capture.title') + ' - Linear Capture';
    }

    async function updateDynamicUI() {
      // reanalyzeBtn - ÌòÑÏû¨ ÏÉÅÌÉúÏóê Îî∞Îùº ÌÖçÏä§Ìä∏ Í≤∞Ï†ï
      const hasAnalyzed = titleInput && titleInput.value.trim() !== '';
      if (aiLoadingDiv && !aiLoadingDiv.classList.contains('hidden')) {
        // Î°úÎî© Ï§ë - Í±¥ÎìúÎ¶¨ÏßÄ ÏïäÏùå
      } else if (hasAnalyzed) {
        reanalyzeBtn.textContent = await t('capture.reanalyze');
      } else {
        reanalyzeBtn.textContent = await t('capture.analysisStart');
      }
      // Linear ÏÑπÏÖò (Team, Project, Status, Priority, Assignee, Estimate, Cycle, Labels)ÏùÄ ÏòÅÏñ¥ Í≥†Ï†ï
    }

    async function autoTranslate() {
      const reverseMap = await ipcRenderer.invoke('get-reverse-translation-map');
      
      const walker = document.createTreeWalker(
        document.body, NodeFilter.SHOW_TEXT, null, false
      );
      
      while (walker.nextNode()) {
        const node = walker.currentNode;
        if (node.parentElement && node.parentElement.closest('[data-no-translate]')) {
          continue;
        }
        const text = node.textContent.trim();
        if (text && reverseMap[text]) {
          node.textContent = await t(reverseMap[text]);
        }
      }
      
      for (const el of document.querySelectorAll('[placeholder]')) {
        if (el.closest('[data-no-translate]')) {
          continue;
        }
        const placeholder = el.getAttribute('placeholder');
        if (placeholder && reverseMap[placeholder]) {
          el.placeholder = await t(reverseMap[placeholder]);
        }
      }
    }

    ipcRenderer.on('language-changed', async () => {
      try {
        await translatePage();
        await autoTranslate();
        await updateDynamicUI();
        if (typeof renderGallery === 'function') await renderGallery();
        if (typeof updateShortcutHint === 'function') await updateShortcutHint();
        // Connection UI updates handled by Related Context section
      } catch (e) {
        console.error('Language change handler error:', e);
      }
    });

    translatePage();
    document.addEventListener('DOMContentLoaded', autoTranslate);

    // Settings button
    const settingsBtn = document.getElementById('settingsBtn');
    settingsBtn.addEventListener('click', () => {
      ipcRenderer.invoke('open-settings');
    });

    // Token warning banner
    const tokenWarning = document.getElementById('tokenWarning');
    const tokenWarningBtn = document.getElementById('tokenWarningBtn');
    tokenWarningBtn.addEventListener('click', () => {
      ipcRenderer.invoke('open-settings');
    });

    // Check token status on load
    async function checkTokenStatus() {
      try {
        const settings = await ipcRenderer.invoke('get-settings');
        if (!settings || !settings.linearApiToken) {
          tokenWarning.classList.remove('hidden');
        } else {
          tokenWarning.classList.add('hidden');
        }
      } catch (error) {
        console.error('Failed to check token status:', error);
      }
    }
    checkTokenStatus();

    // Listen for settings changes to update warning
    ipcRenderer.on('settings-updated', () => {
      checkTokenStatus();
    });

    // Listen for Linear data updates (after token is saved)
    ipcRenderer.on('linear-data-updated', (event, data) => {
      console.log('Linear data updated:', data);

      // Update cached data
      allTeams = data.teams || [];
      allStates = data.states || [];
      allCycles = data.cycles || [];
      allProjects = data.projects || [];
      allUsers = data.users || [];
      allLabels = data.labels || [];

      // Repopulate team dropdown
      const currentTeamId = teamSelect.value;
      teamSelect.innerHTML = '<option value="" data-i18n="form.teamPlaceholder">Select team...</option>';
      allTeams.forEach(team => {
        const option = document.createElement('option');
        option.value = team.id;
        option.textContent = `${team.name} (${team.key})`;
        if (team.id === data.defaultTeamId || team.id === currentTeamId) {
          option.selected = true;
        }
        teamSelect.appendChild(option);
      });

      // Reinitialize searchable dropdowns
      if (projectSearchable) {
        projectSearchable.setItems(allProjects);
      }
      if (assigneeSearchable) {
        assigneeSearchable.setItems(allUsers);
      }

      // Update team-dependent dropdowns if team is selected
      if (teamSelect.value) {
updateTeamDependentDropdowns(teamSelect.value);
        updateLabelsForTeam();
      }

      console.log(`Refreshed: ${allTeams.length} teams, ${allProjects.length} projects, ${allUsers.length} users`);
    });

    const form = document.getElementById('issueForm');
    const preview = document.getElementById('preview');
    const titleInput = document.getElementById('title');
    const descInput = document.getElementById('description');
    const teamSelect = document.getElementById('team');
    const projectInput = document.getElementById('project');
    const statusSelect = document.getElementById('status');
    const prioritySelect = document.getElementById('priority');
    const assigneeInput = document.getElementById('assignee');
    const estimateSelect = document.getElementById('estimate');
    const cycleSelect = document.getElementById('cycle');
    const cancelBtn = document.getElementById('cancelBtn');
    const submitBtn = document.getElementById('submitBtn');
    const errorDiv = document.getElementById('error');
    const loadingDiv = document.getElementById('loading');
    const aiLoadingDiv = document.getElementById('aiLoading');
    const aiLoadingText = document.getElementById('aiLoadingText');
    const aiModelSelect = document.getElementById('aiModel');
    const reanalyzeBtn = document.getElementById('reanalyzeBtn');
    const loadingText = document.getElementById('loadingText');
    const aiAnalysisSection = document.getElementById('aiAnalysisSection');

    let currentFilePath = '';
    let isSubmitting = false; // Track form submission state

    // Multi-image gallery state
    const imageGallery = document.getElementById('imageGallery');
    let images = []; // Array of { filePath }
    let maxImages = 10;

    // Success Screen
    const successScreen = document.getElementById('successScreen');
    const successIssueId = document.getElementById('successIssueId');
    const viewIssueBtn = document.getElementById('viewIssueBtn');
    const closeSuccessBtn = document.getElementById('closeSuccessBtn');
    let createdIssueUrl = '';

    // Image Preview Modal
    const imageModal = document.getElementById('imageModal');
    const modalImage = document.getElementById('modalImage');
    const modalClose = imageModal.querySelector('.modal-close');
    const modalBackdrop = imageModal.querySelector('.modal-backdrop');

    function showImageModal(src) {
      modalImage.src = src;
      imageModal.classList.remove('hidden');
      // Î™®Îã¨Ïù¥ Ïó¥Î¶¨Î©¥ Ïã†Ìò∏Îì± Ïà®Í∏∞Í∏∞
      ipcRenderer.invoke('set-traffic-lights-visible', false);
    }

    function hideImageModal() {
      imageModal.classList.add('hidden');
      modalImage.src = '';
      // Î™®Îã¨Ïù¥ Îã´ÌûàÎ©¥ Ïã†Ìò∏Îì± Îã§Ïãú ÌëúÏãú
      ipcRenderer.invoke('set-traffic-lights-visible', true);
    }

    modalClose.addEventListener('click', (e) => {
      e.stopPropagation();
      hideImageModal();
    });
    modalBackdrop.addEventListener('click', (e) => {
      e.stopPropagation();
      hideImageModal();
    });
    // Î™®Îã¨ Ïª®ÌÖêÏ∏† ÌÅ¥Î¶≠ Ïãú Ïù¥Î≤§Ìä∏ Ï†ÑÌåå Î∞©ÏßÄ (Î∞∞Í≤ΩÏúºÎ°ú Ï†ÑÎã¨ Ïïà ÎêòÍ≤å)
    imageModal.querySelector('.modal-content').addEventListener('click', (e) => {
      e.stopPropagation();
    });

    // Render image gallery
    async function renderGallery() {
      imageGallery.innerHTML = '';

      // Render existing images
      images.forEach((img, idx) => {
        const item = document.createElement('div');
        item.className = 'gallery-item';
        // Disable remove button during submission
        const removeDisabled = isSubmitting ? 'disabled style="opacity:0.5;cursor:not-allowed;"' : '';
        item.innerHTML = `
          <img class="gallery-thumb" src="file://${img.filePath}" alt="Screenshot ${idx + 1}" />
          <span class="gallery-index">${idx + 1}</span>
          <button class="gallery-remove" data-index="${idx}" title="Remove image" ${removeDisabled}>√ó</button>
        `;
        // Ïç∏ÎÑ§Ïùº ÌÅ¥Î¶≠ Ïãú Î™®Îã¨Î°ú ÌôïÎåÄ Î≥¥Í∏∞
        const thumb = item.querySelector('.gallery-thumb');
        thumb.addEventListener('click', () => {
          if (!isSubmitting) {
            showImageModal(`file://${img.filePath}`);
          }
        });
        imageGallery.appendChild(item);
      });

      // Add "+" button if under limit and not submitting
      if (images.length < maxImages && !isSubmitting) {
        const addBtn = document.createElement('div');
        addBtn.className = 'gallery-item gallery-add';
        const labelText = images.length === 0 
          ? await t('capture.captureButton') 
          : await t('capture.addMore', { current: images.length, max: maxImages });
        addBtn.innerHTML = `
          <span class="gallery-add-icon">${images.length === 0 ? 'üì∏' : '+'}</span>
          <span class="gallery-add-text">${labelText}</span>
        `;
        addBtn.addEventListener('click', requestAddCapture);
        imageGallery.appendChild(addBtn);
      }

      // Update first image as currentFilePath for re-analysis
      if (images.length > 0) {
        currentFilePath = images[0].filePath;
      }
    }

    // Request additional capture via IPC
    function requestAddCapture() {
      if (isSubmitting) return;
      ipcRenderer.invoke('add-capture');
    }

    // Handle remove button clicks via event delegation
    imageGallery.addEventListener('click', (e) => {
      if (e.target.classList.contains('gallery-remove') && !isSubmitting) {
        const index = parseInt(e.target.dataset.index);
        ipcRenderer.invoke('remove-capture', { index });
      }
    });

    // Handle new image added
    ipcRenderer.on('capture-added', (event, data) => {
      console.log('Capture added:', data);
      images.push({ filePath: data.filePath });
      maxImages = data.canAddMore ? maxImages : images.length;
      renderGallery();
    });

    // Handle image removed
    ipcRenderer.on('capture-removed', (event, data) => {
      console.log('Capture removed:', data);
      images.splice(data.index, 1);
      renderGallery();
    });

    // Searchable select elements
    const projectTrigger = document.getElementById('projectTrigger');
    const projectDropdown = document.getElementById('projectDropdown');
    const projectSearch = document.getElementById('projectSearch');
    const projectOptions = document.getElementById('projectOptions');

    const assigneeTrigger = document.getElementById('assigneeTrigger');
    const assigneeDropdown = document.getElementById('assigneeDropdown');
    const assigneeSearch = document.getElementById('assigneeSearch');
    const assigneeOptions = document.getElementById('assigneeOptions');

    let imageUrl = '';
    let allStates = [];
    let allCycles = [];
    let allTeams = [];
    let allProjects = [];
    let allUsers = [];
    let allLabels = [];
    let selectedLabelIds = [];  // Currently selected label IDs

    // Label select elements
    const labelSelect = document.getElementById('labelSelect');
    const labelChipsContainer = document.getElementById('labelChipsContainer');
    const labelEmptyHint = document.getElementById('labelEmptyHint');
    const labelDropdown = document.getElementById('labelDropdown');
    const labelSearchInput = document.getElementById('labelSearchInput');
    const labelOptions = document.getElementById('labelOptions');

    // Searchable select helper functions
    function createSearchableSelect(config) {
      const { trigger, dropdown, searchInput, optionsContainer, hiddenInput, items, defaultLabel, getValue, getLabel, onSelect } = config;
      let currentDefaultLabel = defaultLabel;

      function render(filteredItems) {
        optionsContainer.innerHTML = '';

        // Add default option
        const defaultOpt = document.createElement('div');
        defaultOpt.className = 'option' + (hiddenInput.value === '' ? ' selected' : '');
        defaultOpt.textContent = currentDefaultLabel;
        defaultOpt.dataset.value = '';
        defaultOpt.addEventListener('click', () => selectOption('', currentDefaultLabel, null));
        optionsContainer.appendChild(defaultOpt);

        if (filteredItems.length === 0 && searchInput.value) {
          const noResults = document.createElement('div');
          noResults.className = 'no-results';
          noResults.textContent = 'No results found';
          optionsContainer.appendChild(noResults);
        } else {
          filteredItems.forEach(item => {
            const opt = document.createElement('div');
            opt.className = 'option' + (hiddenInput.value === getValue(item) ? ' selected' : '');
            opt.textContent = getLabel(item);
            opt.dataset.value = getValue(item);
            opt.addEventListener('click', () => selectOption(getValue(item), getLabel(item), item));
            optionsContainer.appendChild(opt);
          });
        }
      }

      function selectOption(value, label, item) {
        hiddenInput.value = value;
        trigger.querySelector('span').textContent = label;
        dropdown.classList.remove('open');
        searchInput.value = '';
        render(items);
        if (onSelect) {
          onSelect(value, label, item);
        }
      }

      function filter() {
        const query = searchInput.value.toLowerCase();
        const filtered = items.filter(item => getLabel(item).toLowerCase().includes(query));
        render(filtered);
      }

      trigger.addEventListener('click', (e) => {
        e.stopPropagation();
        // Close other dropdowns
        document.querySelectorAll('.dropdown.open').forEach(d => {
          if (d !== dropdown) d.classList.remove('open');
        });
        dropdown.classList.toggle('open');
        if (dropdown.classList.contains('open')) {
          searchInput.focus();
        }
      });

      searchInput.addEventListener('input', filter);
      searchInput.addEventListener('click', (e) => e.stopPropagation());

      return { 
        render, 
        selectOption, 
        setItems: (newItems) => { items.length = 0; items.push(...newItems); render(items); },
        updateDefaultLabel: (newLabel) => {
          currentDefaultLabel = newLabel;
          // Update trigger text if default option is currently selected
          if (hiddenInput.value === '') {
            trigger.querySelector('span').textContent = newLabel;
          }
          render(items);
        }
      };
    }

    // Close dropdowns when clicking outside
    document.addEventListener('click', (e) => {
      document.querySelectorAll('.dropdown.open').forEach(d => d.classList.remove('open'));
      // Close label dropdown if clicking outside
      if (!labelSelect.contains(e.target)) {
        labelDropdown.classList.remove('open');
      }
    });

    // ==================== Label Multi-Select Logic ====================

    // Toggle label dropdown
    labelChipsContainer.addEventListener('click', (e) => {
      e.stopPropagation();
      // Close other dropdowns
      document.querySelectorAll('.dropdown.open').forEach(d => d.classList.remove('open'));
      labelDropdown.classList.toggle('open');
      if (labelDropdown.classList.contains('open')) {
        labelSearchInput.focus();
        renderLabelOptions();
      }
    });

    // Label search
    labelSearchInput.addEventListener('input', () => {
      renderLabelOptions();
    });
    labelSearchInput.addEventListener('click', (e) => e.stopPropagation());

    // Render label options in dropdown
    function renderLabelOptions() {
      const query = labelSearchInput.value.toLowerCase();
      const selectedTeamId = teamSelect.value;

      // Filter labels: show workspace labels + selected team's labels
      const filteredLabels = allLabels.filter(label => {
        const matchesSearch = label.name.toLowerCase().includes(query);
        const matchesTeam = !label.teamId || label.teamId === selectedTeamId;
        return matchesSearch && matchesTeam;
      });

      labelOptions.innerHTML = '';

      if (filteredLabels.length === 0) {
        labelOptions.innerHTML = '<div class="label-no-results">No labels found</div>';
        return;
      }

      filteredLabels.forEach(label => {
        const isSelected = selectedLabelIds.includes(label.id);
        const option = document.createElement('div');
        option.className = 'label-option' + (isSelected ? ' selected' : '');
        option.innerHTML = `
          <span class="label-option-color" style="background-color: ${label.color}"></span>
          <span class="label-option-name">${label.name}</span>
          ${isSelected ? '<span class="label-option-check">‚úì</span>' : ''}
        `;
        option.addEventListener('click', (e) => {
          e.stopPropagation();
          toggleLabel(label.id);
        });
        labelOptions.appendChild(option);
      });
    }

    // Toggle label selection
    function toggleLabel(labelId) {
      const idx = selectedLabelIds.indexOf(labelId);
      if (idx === -1) {
        selectedLabelIds.push(labelId);
      } else {
        selectedLabelIds.splice(idx, 1);
      }
      renderLabelChips();
      renderLabelOptions();
    }

    // Render selected label chips
    function renderLabelChips() {
      // Clear container except empty hint
      labelChipsContainer.innerHTML = '';

      if (selectedLabelIds.length === 0) {
        labelChipsContainer.innerHTML = '<span class="label-empty-hint">+ Add labels...</span>';
        return;
      }

      selectedLabelIds.forEach(labelId => {
        const label = allLabels.find(l => l.id === labelId);
        if (!label) return;

        const chip = document.createElement('span');
        chip.className = 'label-chip';
        chip.innerHTML = `
          <span class="label-chip-color" style="background-color: ${label.color}"></span>
          ${label.name}
          <button type="button" class="label-chip-remove" data-id="${label.id}">√ó</button>
        `;
        labelChipsContainer.appendChild(chip);
      });

      // Add "+ Add" button at the end
      const addBtn = document.createElement('button');
      addBtn.type = 'button';
      addBtn.className = 'label-add-btn';
      addBtn.textContent = '+';
      addBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        labelDropdown.classList.add('open');
        labelSearchInput.focus();
        renderLabelOptions();
      });
      labelChipsContainer.appendChild(addBtn);
    }

    // Remove label chip via event delegation
    labelChipsContainer.addEventListener('click', (e) => {
      if (e.target.classList.contains('label-chip-remove')) {
        e.stopPropagation();
        const labelId = e.target.dataset.id;
        toggleLabel(labelId);
      }
    });

    // Re-render labels when team changes
    function updateLabelsForTeam() {
      // Remove labels that don't belong to the new team
      const selectedTeamId = teamSelect.value;
      selectedLabelIds = selectedLabelIds.filter(labelId => {
        const label = allLabels.find(l => l.id === labelId);
        return label && (!label.teamId || label.teamId === selectedTeamId);
      });
      renderLabelChips();
      renderLabelOptions();
    }

    // Initialize searchable selects
    let projectSearchable, assigneeSearchable;

    // Generate estimate options based on team settings
    function getEstimateOptions(team) {
      if (!team || team.issueEstimationType === 'notUsed') {
        return [];
      }

      const type = team.issueEstimationType;
      const allowZero = team.issueEstimationAllowZero;
      const extended = team.issueEstimationExtended;

      let options = [];

      if (type === 'fibonacci') {
        // Linear default fibonacci scale
        if (allowZero) options.push({ value: 0, label: '0' });
        if (extended) options.push({ value: 0.5, label: '0.5' });
        options.push(
          { value: 1, label: '1' },
          { value: 2, label: '2' },
          { value: 3, label: '3' },
          { value: 5, label: '5' },
          { value: 8, label: '8' }
        );
        if (extended) {
          options.push(
            { value: 13, label: '13' },
            { value: 21, label: '21' }
          );
        }
      } else if (type === 'exponential') {
        if (allowZero) options.push({ value: 0, label: '0' });
        options.push(
          { value: 1, label: '1' },
          { value: 2, label: '2' },
          { value: 4, label: '4' },
          { value: 8, label: '8' },
          { value: 16, label: '16' }
        );
        if (extended) {
          options.push({ value: 32, label: '32' });
        }
      } else if (type === 'linear') {
        if (allowZero) options.push({ value: 0, label: '0' });
        for (let i = 1; i <= (extended ? 10 : 5); i++) {
          options.push({ value: i, label: String(i) });
        }
      } else if (type === 'tShirt') {
        // T-shirt sizes mapped to numbers
        if (allowZero) options.push({ value: 0, label: 'None' });
        options.push(
          { value: 1, label: 'XS' },
          { value: 2, label: 'S' },
          { value: 3, label: 'M' },
          { value: 5, label: 'L' },
          { value: 8, label: 'XL' }
        );
        if (extended) {
          options.push({ value: 13, label: 'XXL' });
        }
      }

      return options;
    }

    // Update estimate dropdown based on team
    function updateEstimateDropdown(teamId) {
      const team = allTeams.find(t => t.id === teamId);
      estimateSelect.innerHTML = '<option value="">None</option>';

      const options = getEstimateOptions(team);
      options.forEach(opt => {
        const option = document.createElement('option');
        option.value = opt.value;
        option.textContent = opt.label + (opt.value !== 0 && typeof opt.value === 'number' && opt.label !== 'None' && !isNaN(Number(opt.label)) ? ' point' + (opt.value !== 1 ? 's' : '') : '');
        estimateSelect.appendChild(option);
      });
    }

    // Update status, cycle, and estimate dropdowns based on selected team
    function updateTeamDependentDropdowns(teamId) {
      // Update status dropdown (default to Todo)
      statusSelect.innerHTML = '';
      const teamStates = allStates.filter(state => state.teamId === teamId);
      const todoState = teamStates.find(state => state.name === 'Todo');

      teamStates.forEach(state => {
        const option = document.createElement('option');
        option.value = state.id;
        option.textContent = state.name;
        // Set Todo as default selected
        if (todoState && state.id === todoState.id) {
          option.selected = true;
        }
        statusSelect.appendChild(option);
      });

      // Update cycle dropdown
      cycleSelect.innerHTML = '<option value="">None</option>';
      const now = new Date();
      allCycles
        .filter(cycle => cycle.teamId === teamId)
        .forEach(cycle => {
          const option = document.createElement('option');
          option.value = cycle.id;

          // Format dates (MÏõî DÏùº)
          const startDate = new Date(cycle.startsAt);
          const endDate = new Date(cycle.endsAt);
          const formatDate = (d) => `${d.getMonth() + 1}Ïõî ${d.getDate()}Ïùº`;

          // Determine cycle status
          let status = '';
          if (now >= startDate && now <= endDate) {
            status = 'Current';
          } else if (startDate > now) {
            status = 'Upcoming';
          } else {
            status = 'Previous';
          }

          option.textContent = `Cycle ${cycle.number} (${formatDate(startDate)} - ${formatDate(endDate)}) ¬∑ ${status}`;
          cycleSelect.appendChild(option);
        });

      // Update estimate dropdown
      updateEstimateDropdown(teamId);
    }

    // Receive capture data from main process
    ipcRenderer.on('capture-ready', async (event, data) => {
      console.log('Capture ready:', data);

      try {
      // Store teams, states, cycles, projects, users, labels for filtering
      allTeams = data.teams || [];
      allStates = data.states || [];
      allCycles = data.cycles || [];
      allProjects = data.projects || [];
      allUsers = data.users || [];
      allLabels = data.labels || [];

      console.log('AI analysis result:', { title: data.suggestedTitle, desc: data.suggestedDescription });

      // Handle multi-image data
      if (data.images && data.images.length > 0) {
        images = data.images.map(img => ({ filePath: img.filePath }));
        maxImages = data.maxImages || 10;
        currentFilePath = images[0].filePath;
        renderGallery();
      } else if (data.filePath) {
        // Backwards compatibility for single image
        images = [{ filePath: data.filePath }];
        currentFilePath = data.filePath;
        renderGallery();
      }

      // Legacy (hidden)
      imageUrl = data.imageUrl || '';

      // Populate teams
      teamSelect.innerHTML = '<option value="" data-i18n="form.teamPlaceholder">Select team...</option>';
      data.teams.forEach(team => {
        const option = document.createElement('option');
        option.value = team.id;
        option.textContent = `${team.name} (${team.key})`;
        if (team.id === data.defaultTeamId) {
          option.selected = true;
        }
        teamSelect.appendChild(option);
      });

      // Initialize searchable project dropdown
      projectSearchable = createSearchableSelect({
        trigger: projectTrigger,
        dropdown: projectDropdown,
        searchInput: projectSearch,
        optionsContainer: projectOptions,
        hiddenInput: projectInput,
        items: allProjects,
        defaultLabel: 'None',
        getValue: (p) => p.id,
        getLabel: (p) => p.name,
        onSelect: (value, label, project) => {
          if (!value || !project) return;
          
          const teamIds = project.teamIds || [];
          if (teamIds.length > 0) {
            teamSelect.value = teamIds[0];
            updateTeamDependentDropdowns(teamIds[0]);
            updateLabelsForTeam();
          }
        }
      });
      projectSearchable.render(allProjects);

       // Initialize searchable assignee dropdown
       assigneeSearchable = createSearchableSelect({
         trigger: assigneeTrigger,
         dropdown: assigneeDropdown,
         searchInput: assigneeSearch,
         optionsContainer: assigneeOptions,
         hiddenInput: assigneeInput,
         items: allUsers,
         defaultLabel: 'Unassigned',
         getValue: (u) => u.id,
         getLabel: (u) => u.name
       });
       assigneeSearchable.render(allUsers);

       // Set default assignee to token owner if available and no AI suggestion
       if (data.userInfo && !data.suggestedAssigneeId) {
         const tokenOwner = allUsers.find(u => u.id === data.userInfo.id);
         if (tokenOwner) {
           assigneeSearchable.selectOption(tokenOwner.id, tokenOwner.name);
         }
       }

       // Initialize team-dependent dropdowns
      if (data.defaultTeamId) {
        updateTeamDependentDropdowns(data.defaultTeamId);
      }

       // AI Î°úÎî© Ïä§ÌîºÎÑà Ïà®ÍπÄ Ïú†ÏßÄ (Î∂ÑÏÑù ÏãúÏûë Î≤ÑÌäº ÌÅ¥Î¶≠ Ïãú ÌëúÏãú)
      aiLoadingDiv.classList.add('hidden');
      reanalyzeBtn.textContent = await t('capture.analysisStart');
      reanalyzeBtn.disabled = false;

      // Reset form state
      titleInput.value = '';
      descInput.value = '';
      document.getElementById('userHint').value = '';
      prioritySelect.value = '';
      estimateSelect.value = '';
      selectedLabelIds = [];  // Reset labels
      renderLabelChips();
      errorDiv.textContent = '';
      submitBtn.disabled = false;
      cancelBtn.disabled = false;
      isSubmitting = false;
      form.style.display = 'block';
      loadingDiv.style.display = 'none';
      successScreen.classList.add('hidden');
      imageGallery.style.display = 'flex';
      aiAnalysisSection.style.display = 'block';
      createdIssueUrl = '';

      // Set default project if available
      if (data.defaultProjectId) {
        const project = allProjects.find(p => p.id === data.defaultProjectId);
        if (project) {
          projectSearchable.selectOption(project.id, project.name);
        }
      }

      // Focus title input
      titleInput.focus();
      } catch (error) {
        console.error('Error in capture-ready handler:', error);
      }
    });

    // Handle AI analysis results (received after window is shown)
    ipcRenderer.on('ai-analysis-ready', async (event, data) => {
      console.log('AI analysis ready:', data);

      // Hide AI loading spinner
      aiLoadingDiv.classList.add('hidden');
      reanalyzeBtn.disabled = false;

      if (!data.success) {
        console.log('AI analysis failed or skipped');
        return;
      }

      // Î∂ÑÏÑù ÏÑ±Í≥µ Ïãú Î≤ÑÌäº ÌÖçÏä§Ìä∏ Î≥ÄÍ≤Ω
      reanalyzeBtn.textContent = await t('capture.reanalyze');

      // Apply AI suggestions
      if (data.title) {
        titleInput.value = data.title;
        titleInput.select();
      }
      if (data.description) {
        descInput.value = data.description;
      }
      if (data.suggestedProjectId) {
        const project = allProjects.find(p => p.id === data.suggestedProjectId);
        if (project) {
          projectSearchable.selectOption(project.id, project.name, project);
        }
      }
      if (data.suggestedAssigneeId) {
        const user = allUsers.find(u => u.id === data.suggestedAssigneeId);
        if (user) {
          assigneeSearchable.selectOption(user.id, user.name, user);
        }
      }
      if (data.suggestedPriority) {
        prioritySelect.value = data.suggestedPriority.toString();
      }
      if (data.suggestedEstimate) {
        estimateSelect.value = data.suggestedEstimate.toString();
      }
    });

    // Update dropdowns when team changes
    teamSelect.addEventListener('change', () => {
      updateTeamDependentDropdowns(teamSelect.value);
      updateLabelsForTeam();  // Also update labels
    });

    // Handle form submission
    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      const title = titleInput.value.trim();
      const description = descInput.value.trim();
      const teamId = teamSelect.value;
      const projectId = projectInput.value;
      const stateId = statusSelect.value;
      const priority = prioritySelect.value;
      const assigneeId = assigneeInput.value;
      const estimate = estimateSelect.value;
      const cycleId = cycleSelect.value;

      if (!title) {
        errorDiv.textContent = 'Title is required';
        return;
      }

      if (!teamId) {
        errorDiv.textContent = 'Team is required';
        return;
      }

      // Set submitting state
      isSubmitting = true;
      errorDiv.textContent = '';
      submitBtn.disabled = true;
      cancelBtn.disabled = true;
      reanalyzeBtn.disabled = true;
      form.style.display = 'none';
      loadingDiv.style.display = 'block';
      loadingText.textContent = await t('form.creating');
      renderGallery(); // Re-render to hide add button

      try {
        const result = await ipcRenderer.invoke('create-issue', {
          title,
          description,
          teamId,
          projectId: projectId || undefined,
          stateId: stateId || undefined,
          priority: priority ? parseInt(priority, 10) : undefined,
          assigneeId: assigneeId || undefined,
          estimate: estimate ? parseInt(estimate, 10) : undefined,
          cycleId: cycleId || undefined,
          labelIds: selectedLabelIds.length > 0 ? selectedLabelIds : undefined,
        });

        if (result.success) {
          // Success: show success screen
          loadingDiv.style.display = 'none';
          imageGallery.style.display = 'none';
          aiAnalysisSection.style.display = 'none';
          successIssueId.textContent = result.issueIdentifier || 'Issue created';
          createdIssueUrl = result.issueUrl || '';
          successScreen.classList.remove('hidden');
        } else {
          isSubmitting = false;
          form.style.display = 'block';
          loadingDiv.style.display = 'none';
          submitBtn.disabled = false;
          cancelBtn.disabled = false;
          reanalyzeBtn.disabled = false;
          errorDiv.textContent = result.error || 'Failed to create issue';
          // Show partial upload warning if applicable
          if (result.uploadedCount !== undefined && result.uploadedCount < images.length) {
            errorDiv.textContent += ` (${result.uploadedCount}/${images.length} images uploaded)`;
          }
          renderGallery();
        }
      } catch (err) {
        isSubmitting = false;
        form.style.display = 'block';
        loadingDiv.style.display = 'none';
        submitBtn.disabled = false;
        cancelBtn.disabled = false;
        reanalyzeBtn.disabled = false;
        errorDiv.textContent = err.message || 'Unknown error';
        renderGallery();
      }
    });

    // Handle cancel
    cancelBtn.addEventListener('click', () => {
      ipcRenderer.invoke('cancel');
    });

    // Handle Escape key
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        // Î™®Îã¨Ïù¥ Ïó¥Î†§ ÏûàÏúºÎ©¥ Î™®Îã¨Îßå Îã´Í∏∞
        if (!imageModal.classList.contains('hidden')) {
          hideImageModal();
          return;
        }
        ipcRenderer.invoke('cancel');
      }
    });

    // Handle re-analyze button
    reanalyzeBtn.addEventListener('click', async () => {
      if (!currentFilePath) return;

      const model = aiModelSelect.value;
      const modelName = model === 'haiku' ? 'Claude Haiku 4.5' : 'Gemini 3 Flash';
      const instruction = document.getElementById('userHint').value.trim();

      // Show loading
      aiLoadingText.textContent = await t('capture.reanalyzing', { model: modelName });
      aiLoadingDiv.classList.remove('hidden');
      reanalyzeBtn.disabled = true;

      try {
        await ipcRenderer.invoke('reanalyze', {
          filePath: currentFilePath,
          model: model,
          instruction: instruction || undefined
        });
      } catch (err) {
        console.error('Reanalyze error:', err);
        aiLoadingDiv.classList.add('hidden');
        reanalyzeBtn.disabled = false;
      }
    });

    // Success screen: View issue button
    viewIssueBtn.addEventListener('click', () => {
      if (createdIssueUrl) {
        require('electron').shell.openExternal(createdIssueUrl);
      }
      ipcRenderer.invoke('close-window');
    });

    // Success screen: Close button
    closeSuccessBtn.addEventListener('click', () => {
      ipcRenderer.invoke('close-window');
    });

    // ÌéòÏù¥ÏßÄ Î°úÎìú Ïãú Ï¥àÍ∏∞ Í∞§Îü¨Î¶¨ Î†åÎçîÎßÅ (Ï∫°Ï≤òÌïòÍ∏∞ Î≤ÑÌäº ÌëúÏãú)
    renderGallery();

    // ==================== Hotkey Hint Update ====================
    const shortcutHint = document.getElementById('shortcutHint');

    // Load and display current hotkey
    async function updateShortcutHint() {
      try {
        const result = await ipcRenderer.invoke('get-hotkey');
        if (result && result.displayHotkey) {
          // Parse display hotkey (e.g., "‚åò + ‚áß + L") into kbd elements
          const parts = result.displayHotkey.split(' + ').map(part => part.trim());
          const kbdHtml = parts.map(p => `<kbd>${p}</kbd>`).join(' + ');
          const hintText = await t('capture.shortcutHint', { hotkey: kbdHtml, max: 10 });
          shortcutHint.innerHTML = hintText;
        }
      } catch (error) {
        console.error('Failed to load hotkey:', error);
      }
    }
    updateShortcutHint();

    // Listen for hotkey changes
    ipcRenderer.on('hotkey-changed', async (event, data) => {
      if (data && data.displayHotkey) {
        const parts = data.displayHotkey.split(' + ').map(part => part.trim());
        const kbdHtml = parts.map(p => `<kbd>${p}</kbd>`).join(' + ');
        const hintText = await t('capture.shortcutHint', { hotkey: kbdHtml, max: 10 });
        shortcutHint.innerHTML = hintText;
      }
    });

    // ==================== Shared Helper: Escape HTML ====================
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // ==================== Semantic Search ====================
    let semantic_selectedResults = new Set();
    let semantic_currentResults = [];
    let semantic_searchDebounceTimer = null;

    const SEMANTIC_DEBOUNCE_MS = 500;
    const SEMANTIC_MIN_QUERY_LENGTH = 3;

    function initSemanticSearch() {
      const section = document.getElementById('semanticSearchSection');
      const header = document.getElementById('semanticSearchHeader');
      const searchInput = document.getElementById('semanticSearchInput');
      const searchBtn = document.getElementById('semanticSearchBtn');
      const titleInputForSemantic = document.getElementById('title');

      if (!section || !header) return;

      header.addEventListener('click', () => toggleSemanticSection(section));

      if (searchBtn) {
        searchBtn.addEventListener('click', () => {
          const query = searchInput?.value?.trim();
          if (query && query.length >= SEMANTIC_MIN_QUERY_LENGTH) {
            performSemanticSearch(query);
          }
        });
      }

      if (searchInput) {
        searchInput.addEventListener('keypress', (e) => {
          if (e.key === 'Enter') {
            e.preventDefault();
            const query = searchInput.value.trim();
            if (query && query.length >= SEMANTIC_MIN_QUERY_LENGTH) {
              performSemanticSearch(query);
            }
          }
        });
      }

      if (titleInputForSemantic) {
        titleInputForSemantic.addEventListener('blur', () => {
          const query = titleInputForSemantic.value.trim();
          if (query && query.length >= SEMANTIC_MIN_QUERY_LENGTH) {
            clearTimeout(semantic_searchDebounceTimer);
            semantic_searchDebounceTimer = setTimeout(() => {
              if (searchInput) {
                searchInput.value = query;
              }
              performSemanticSearch(query);
            }, SEMANTIC_DEBOUNCE_MS);
          }
        });
      }

      const insertBtn = document.getElementById('semanticInsertBtn');
      if (insertBtn) {
        insertBtn.addEventListener('click', insertSelectedToDescription);
      }
    }

    function toggleSemanticSection(section) {
      if (!section) {
        section = document.getElementById('semanticSearchSection');
      }
      if (section) {
        section.classList.toggle('expanded');
      }
    }

    async function performSemanticSearch(query) {
      console.log('[SemanticSearch:JS] performSemanticSearch called with query:', query);
      
      const loadingEl = document.getElementById('semanticLoading');
      const resultsEl = document.getElementById('semanticResults');
      const emptyEl = document.getElementById('semanticEmpty');
      const actionsEl = document.getElementById('semanticActions');
      const autoStatusEl = document.getElementById('semanticAutoStatus');
      const badgeEl = document.getElementById('semanticBadge');
      const section = document.getElementById('semanticSearchSection');

      if (autoStatusEl) autoStatusEl.style.display = 'none';
      if (loadingEl) loadingEl.style.display = 'flex';
      if (resultsEl) resultsEl.style.display = 'none';
      if (emptyEl) emptyEl.style.display = 'none';
      if (actionsEl) actionsEl.style.display = 'none';

      if (section && !section.classList.contains('expanded')) {
        section.classList.add('expanded');
      }

      semantic_selectedResults.clear();
      semantic_currentResults = [];

      try {
        console.log('[SemanticSearch:JS] ipcRenderer:', ipcRenderer ? 'available' : 'NOT available');
        if (!ipcRenderer) {
          console.error('[SemanticSearch:JS] ipcRenderer not available');
          if (loadingEl) loadingEl.style.display = 'none';
          if (emptyEl) {
            emptyEl.textContent = 'IPC not available. Please restart the app.';
            emptyEl.style.display = 'block';
          }
          return;
        }
        
        console.log('[SemanticSearch:JS] Calling ipcRenderer.invoke...');
        const result = await ipcRenderer.invoke('context-semantic-search', {
          query: query,
          source: 'slack'
        });
        console.log('[SemanticSearch:JS] ipcRenderer.invoke returned:', result);

        if (loadingEl) loadingEl.style.display = 'none';

        if (result.notConnected) {
          if (emptyEl) {
            emptyEl.textContent = 'Slack not connected. Connect in Settings first.';
            emptyEl.style.display = 'block';
          }
          if (badgeEl) badgeEl.style.display = 'none';
        } else if (result.success && result.results && result.results.length > 0) {
          semantic_currentResults = result.results;
          renderSemanticResults(result.results);
          if (resultsEl) resultsEl.style.display = 'block';
          if (actionsEl) actionsEl.style.display = 'flex';
          if (badgeEl) {
            badgeEl.textContent = result.results.length;
            badgeEl.style.display = 'inline';
          }
        } else {
          if (emptyEl) {
            emptyEl.textContent = 'No related documents found';
            emptyEl.style.display = 'block';
          }
          if (badgeEl) badgeEl.style.display = 'none';
        }
      } catch (error) {
        console.error('Semantic search error:', error);
        if (loadingEl) loadingEl.style.display = 'none';
        if (emptyEl) emptyEl.style.display = 'block';
        if (badgeEl) badgeEl.style.display = 'none';
      }
    }

    function renderSemanticResults(results) {
      const resultsEl = document.getElementById('semanticResults');
      if (!resultsEl) return;

      resultsEl.innerHTML = '';

      results.forEach((item, index) => {
        const itemEl = document.createElement('div');
        itemEl.className = 'semantic-result-item';
        itemEl.dataset.index = index;

        const sourceIcon = getSemanticSourceIcon(item.source);
        const scorePercent = Math.round((item.score || 0) * 100);
        const title = item.title || '';
        const content = item.content || '';
        const displayText = title || content.substring(0, 100);

        itemEl.innerHTML = `
          <input type="checkbox" class="semantic-result-checkbox" data-index="${index}">
          <div class="semantic-result-content">
            <div class="semantic-result-meta">
              <span class="semantic-result-source ${item.source}">${sourceIcon} ${capitalizeFirstSemantic(item.source)}</span>
              <span class="semantic-result-score">${scorePercent}% match</span>
            </div>
            ${title ? `<div class="semantic-result-title">${escapeHtmlSemantic(title)}</div>` : ''}
            <div class="semantic-result-text">${escapeHtmlSemantic(content)}</div>
          </div>
        `;

        const checkbox = itemEl.querySelector('.semantic-result-checkbox');
        
        itemEl.addEventListener('click', (e) => {
          if (e.target !== checkbox) {
            checkbox.checked = !checkbox.checked;
          }
          toggleSemanticResultSelection(index, checkbox.checked, itemEl);
        });

        checkbox.addEventListener('change', (e) => {
          e.stopPropagation();
          toggleSemanticResultSelection(index, checkbox.checked, itemEl);
        });

        resultsEl.appendChild(itemEl);
      });

      updateSemanticSelectedCount();
    }

    function toggleSemanticResultSelection(index, isSelected, itemEl) {
      if (isSelected) {
        semantic_selectedResults.add(index);
        itemEl.classList.add('selected');
      } else {
        semantic_selectedResults.delete(index);
        itemEl.classList.remove('selected');
      }
      updateSemanticSelectedCount();
    }

    function updateSemanticSelectedCount() {
      const countEl = document.getElementById('semanticSelectedCount');
      const insertBtn = document.getElementById('semanticInsertBtn');
      const count = semantic_selectedResults.size;

      if (countEl) {
        countEl.textContent = `${count} selected`;
      }
      if (insertBtn) {
        insertBtn.disabled = count === 0;
      }
    }

    function insertSelectedToDescription() {
      if (semantic_selectedResults.size === 0) return;

      const descriptionEl = document.getElementById('description');
      if (!descriptionEl) return;

      const items = Array.from(semantic_selectedResults)
        .map(index => semantic_currentResults[index])
        .filter(Boolean);

      if (items.length === 0) return;

      let markdown = '\n\n### Related Context\n';
      
      items.forEach(item => {
        const sourceLabel = capitalizeFirstSemantic(item.source);
        const displayText = (item.title || item.content || '').substring(0, 60);
        const cleanText = displayText.replace(/\n/g, ' ').trim();
        
        if (item.url) {
          markdown += `- [${sourceLabel}] ${cleanText}... ([View](${item.url}))\n`;
        } else {
          markdown += `- [${sourceLabel}] ${cleanText}...\n`;
        }
      });

      const currentValue = descriptionEl.value || '';
      descriptionEl.value = currentValue + markdown;

      semantic_selectedResults.clear();
      const resultsEl = document.getElementById('semanticResults');
      if (resultsEl) {
        resultsEl.querySelectorAll('.semantic-result-item').forEach(item => {
          item.classList.remove('selected');
          const checkbox = item.querySelector('.semantic-result-checkbox');
          if (checkbox) checkbox.checked = false;
        });
      }
      updateSemanticSelectedCount();

      const section = document.getElementById('semanticSearchSection');
      if (section) {
        section.classList.remove('expanded');
      }
    }

    function getSemanticSourceIcon(source) {
      const icons = {
        slack: 'üí¨',
        notion: 'üìù',
        gmail: 'üìß'
      };
      return icons[source] || 'üìÑ';
    }

    function capitalizeFirstSemantic(str) {
      if (!str) return '';
      return str.charAt(0).toUpperCase() + str.slice(1);
    }

    function escapeHtmlSemantic(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initSemanticSearch);
    } else {
      initSemanticSearch();
    }

    window.semanticSearch = {
      init: initSemanticSearch,
      toggle: toggleSemanticSection,
      search: performSemanticSearch
    };

    // ==================== Related Context Section ====================
    const relatedContextSection = document.getElementById('relatedContextSection');
    const relatedContextHeader = document.getElementById('relatedContextHeader');
    const relatedContextSearchInput = document.getElementById('relatedContextSearchInput');
    const relatedContextRefreshBtn = document.getElementById('relatedContextRefreshBtn');
    const relatedContextLoading = document.getElementById('relatedContextLoading');
    const relatedContextResults = document.getElementById('relatedContextResults');
    const relatedContextEmpty = document.getElementById('relatedContextEmpty');
    const relatedContextActions = document.getElementById('relatedContextActions');
    const relatedContextSelectedCount = document.getElementById('relatedContextSelectedCount');
    const relatedContextInsertBtn = document.getElementById('relatedContextInsertBtn');
    const relatedContextBadge = document.getElementById('relatedContextBadge');
    const relatedContextStatus = document.getElementById('relatedContextStatus');
    const relatedContextNotConnected = document.getElementById('relatedContextNotConnected');
    const relatedContextOpenSettings = document.getElementById('relatedContextOpenSettings');

    let relatedContextSelectedItems = [];
    let userModifiedSearch = false;
    let relatedContextDebounceTimer = null;
    let lastRelatedQuery = '';

    // Connection status flags (checked by updateRelatedContextConnectionBanner)
    let slackConnectedStatus = false;
    let notionConnectedStatus = false;
    let gmailConnectedStatus = false;

    // Check if any service is connected and update banner visibility
    function updateRelatedContextConnectionBanner() {
      const anyConnected = slackConnectedStatus || notionConnectedStatus || gmailConnectedStatus;
      if (anyConnected) {
        relatedContextNotConnected.style.display = 'none';
      } else {
        relatedContextNotConnected.style.display = 'flex';
      }
    }

    // Open settings button handler
    relatedContextOpenSettings.addEventListener('click', () => {
      ipcRenderer.invoke('open-settings');
    });

    // Toggle section expand/collapse
    relatedContextHeader.addEventListener('click', () => {
      relatedContextSection.classList.toggle('expanded');
    });

    // Title ‚Üí Search sync (only when user hasn't modified search)
    titleInput.addEventListener('input', () => {
      if (!userModifiedSearch) {
        relatedContextSearchInput.value = titleInput.value;
      }
      triggerRelatedSearch();
    });

    titleInput.addEventListener('blur', () => {
      if (!userModifiedSearch && titleInput.value.trim()) {
        relatedContextSearchInput.value = titleInput.value;
        triggerRelatedSearch();
      }
    });

    // Search input change marks user modification
    relatedContextSearchInput.addEventListener('input', () => {
      userModifiedSearch = true;
      triggerRelatedSearch();
    });

    // Refresh button - reset to title
    relatedContextRefreshBtn.addEventListener('click', () => {
      relatedContextSearchInput.value = titleInput.value;
      userModifiedSearch = false;
      triggerRelatedSearch();
    });

    // Debounced search trigger (300ms)
    function triggerRelatedSearch() {
      clearTimeout(relatedContextDebounceTimer);
      relatedContextDebounceTimer = setTimeout(() => {
        const query = relatedContextSearchInput.value.trim();
        if (query === lastRelatedQuery) return;
        lastRelatedQuery = query;
        performRelatedSearch(query);
      }, 300);
    }

    // Perform search via IPC
    async function performRelatedSearch(query) {
      if (!query || query.length < 3) {
        relatedContextResults.innerHTML = '';
        relatedContextResults.style.display = 'none';
        relatedContextLoading.style.display = 'none';
        relatedContextEmpty.style.display = 'none';
        relatedContextStatus.innerHTML = '<span>üí°</span><span>' + (await t('relatedContext.enterQuery') || 'Enter a title or search term') + '</span>';
        return;
      }

      relatedContextLoading.style.display = 'flex';
      relatedContextResults.style.display = 'none';
      relatedContextEmpty.style.display = 'none';
      relatedContextStatus.innerHTML = '<span>üîç</span><span>Searching for "' + escapeHtml(query.substring(0, 30)) + '"...</span>';

      try {
        const result = await ipcRenderer.invoke('context.getRelated', { query, limit: 20 });
        console.log('[RelatedContext] Result:', result);
        
        relatedContextLoading.style.display = 'none';
        
        if (!result.success) {
          console.error('[RelatedContext] Error:', result.error);
          relatedContextEmpty.style.display = 'flex';
          return;
        }

        if (!result.results || result.results.length === 0) {
          relatedContextEmpty.style.display = 'flex';
          relatedContextStatus.innerHTML = '<span>ü§∑</span><span>' + (await t('relatedContext.noResultsHint') || 'Try different keywords') + '</span>';
          return;
        }

        renderRelatedResults(result.results);
        relatedContextStatus.innerHTML = '<span>‚ú®</span><span>' + result.results.length + ' results ¬∑ Edit to refine</span>';
        
        // Auto-expand when results found
        relatedContextSection.classList.add('expanded');
      } catch (error) {
        console.error('[RelatedContext] Error:', error);
        relatedContextLoading.style.display = 'none';
        relatedContextEmpty.style.display = 'flex';
      }
    }

    // Render results list
    function renderRelatedResults(items) {
      relatedContextResults.innerHTML = '';
      
      items.forEach(item => {
        const isSelected = relatedContextSelectedItems.some(s => s.id === item.id);
        const div = document.createElement('div');
        div.className = 'related-context-result-item' + (isSelected ? ' selected' : '');
        div.dataset.id = item.id;

        const sourceClass = item.source || 'ai';
        const sourceIcons = {
          'gmail': '<span class="source-icon"><svg viewBox="0 0 24 24" fill="none"><path d="M24 5.457v13.909c0 .904-.732 1.636-1.636 1.636h-3.819V11.73L12 16.64l-6.545-4.91v9.273H1.636A1.636 1.636 0 0 1 0 19.366V5.457c0-2.023 2.309-3.178 3.927-1.964L5.455 4.64 12 9.548l6.545-4.91 1.528-1.145C21.69 2.28 24 3.434 24 5.457z" fill="#EA4335"/></svg></span>',
          'slack': '<span class="source-icon"><svg viewBox="0 0 24 24" fill="none"><path d="M5.042 15.165a2.528 2.528 0 0 1-2.52 2.523A2.528 2.528 0 0 1 0 15.165a2.527 2.527 0 0 1 2.522-2.52h2.52v2.52zm1.271 0a2.527 2.527 0 0 1 2.521-2.52 2.527 2.527 0 0 1 2.521 2.52v6.313A2.528 2.528 0 0 1 8.834 24a2.528 2.528 0 0 1-2.521-2.522v-6.313z" fill="#E01E5A"/><path d="M8.834 5.042a2.528 2.528 0 0 1-2.521-2.52A2.528 2.528 0 0 1 8.834 0a2.528 2.528 0 0 1 2.521 2.522v2.52H8.834zm0 1.271a2.528 2.528 0 0 1 2.521 2.521 2.528 2.528 0 0 1-2.521 2.521H2.522A2.528 2.528 0 0 1 0 8.834a2.528 2.528 0 0 1 2.522-2.521h6.312z" fill="#36C5F0"/><path d="M18.956 8.834a2.528 2.528 0 0 1 2.522-2.521A2.528 2.528 0 0 1 24 8.834a2.528 2.528 0 0 1-2.522 2.521h-2.522V8.834zm-1.27 0a2.528 2.528 0 0 1-2.522 2.521 2.528 2.528 0 0 1-2.52-2.521V2.522A2.528 2.528 0 0 1 15.165 0a2.528 2.528 0 0 1 2.521 2.522v6.312z" fill="#2EB67D"/><path d="M15.165 18.956a2.528 2.528 0 0 1 2.521 2.522A2.528 2.528 0 0 1 15.165 24a2.527 2.527 0 0 1-2.52-2.522v-2.522h2.52zm0-1.27a2.527 2.527 0 0 1-2.52-2.522 2.527 2.527 0 0 1 2.52-2.52h6.313A2.528 2.528 0 0 1 24 15.165a2.528 2.528 0 0 1-2.522 2.521h-6.313z" fill="#ECB22E"/></svg></span>',
          'notion': '<span class="source-icon"><svg viewBox="0 0 24 24" fill="none"><path d="M4.459 4.208c.746.606 1.026.56 2.428.466l13.215-.793c.28 0 .047-.28-.046-.326L17.86 1.968c-.42-.326-.98-.7-2.055-.607L3.01 2.295c-.466.046-.56.28-.374.466l1.823 1.447zm.793 3.08v13.904c0 .747.373 1.027 1.214.98l14.523-.84c.841-.046.934-.56.934-1.166V6.354c0-.606-.233-.933-.747-.886l-15.177.887c-.56.046-.747.326-.747.933zm14.337.745c.093.42 0 .84-.42.888l-.7.14v10.264c-.608.327-1.168.514-1.635.514-.747 0-.934-.234-1.495-.933l-4.577-7.186v6.952l1.448.327s0 .84-1.168.84l-3.222.186c-.093-.186 0-.653.327-.746l.84-.233V9.854L7.822 9.76c-.094-.42.14-1.026.793-1.073l3.456-.233 4.764 7.279v-6.44l-1.215-.139c-.093-.514.28-.886.747-.933l3.222-.186zM2.877.466L16.039.014c1.635-.14 2.055.093 2.755.606l3.596 2.521c.56.373.746.466.746 1.072v17.04c0 .72-.28 1.19-1.12 1.236L6.03 23.466c-.653.046-1.025-.046-1.4-.56l-3.5-4.624c-.374-.56-.514-.98-.514-1.493V1.906c0-.653.28-1.12.98-1.16l1.281-.28z" fill="#000"/></svg></span>',
          'linear': '<span class="source-icon"><svg viewBox="0 0 24 24" fill="#5E6AD2"><path d="M2.886 4.18A11.982 11.982 0 0 1 11.99 0C18.624 0 24 5.376 24 12.009c0 3.64-1.62 6.903-4.18 9.105L2.887 4.18ZM1.817 5.626l16.556 16.556c-.524.33-1.075.62-1.65.866L.951 7.277c.247-.575.537-1.126.866-1.65ZM.322 9.163l14.515 14.515c-.71.172-1.443.282-2.195.322L0 11.358a12 12 0 0 1 .322-2.195Zm-.17 4.862 9.823 9.824a12.02 12.02 0 0 1-9.824-9.824Z"/></svg></span>',
          'ai': '<span class="source-icon">‚ú®</span>'
        };
        const sourceLabel = {
          'slack': (sourceIcons['slack'] || '') + 'Slack',
          'notion': (sourceIcons['notion'] || '') + 'Notion',
          'gmail': (sourceIcons['gmail'] || '') + 'Gmail',
          'linear': (sourceIcons['linear'] || '') + 'Linear',
          'ai': (sourceIcons['ai'] || '') + 'AI'
        }[sourceClass] || sourceClass;

        const timeStr = item.timestamp 
          ? new Date(item.timestamp).toLocaleString('ko-KR', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' })
          : '';

        div.innerHTML = `
          <input type="checkbox" class="related-context-result-checkbox" ${isSelected ? 'checked' : ''}>
          <div class="related-context-result-content">
            <div class="related-context-result-meta">
              <span class="related-context-result-source ${sourceClass}">${sourceLabel}</span>
              ${timeStr ? `<span>${timeStr}</span>` : ''}
              ${item.confidence ? `<span>${Math.round(item.confidence * 100)}%</span>` : ''}
            </div>
            <div class="related-context-result-title">${escapeHtml(item.title || '')}</div>
            <div class="related-context-result-snippet">${escapeHtml(item.snippet || '')}</div>
          </div>
        `;

        div.addEventListener('click', (e) => {
          if (e.target.type === 'checkbox') return;
          toggleRelatedItem(item, div);
        });

        const checkbox = div.querySelector('.related-context-result-checkbox');
        checkbox.addEventListener('change', () => {
          toggleRelatedItem(item, div);
        });

        relatedContextResults.appendChild(div);
      });

      relatedContextResults.style.display = 'block';
      updateRelatedContextActions();
    }

    // Toggle item selection
    function toggleRelatedItem(item, element) {
      const idx = relatedContextSelectedItems.findIndex(s => s.id === item.id);
      const checkbox = element.querySelector('.related-context-result-checkbox');

      if (idx === -1) {
        relatedContextSelectedItems.push(item);
        element.classList.add('selected');
        checkbox.checked = true;
      } else {
        relatedContextSelectedItems.splice(idx, 1);
        element.classList.remove('selected');
        checkbox.checked = false;
      }

      updateRelatedContextActions();
    }

    // Update actions visibility and badge
    async function updateRelatedContextActions() {
      const count = relatedContextSelectedItems.length;
      if (count > 0) {
        relatedContextActions.style.display = 'flex';
        relatedContextSelectedCount.textContent = (await t('relatedContext.selected', { count })) || `${count} selected`;
        relatedContextInsertBtn.disabled = false;
        relatedContextBadge.textContent = count;
        relatedContextBadge.style.display = 'inline';
      } else {
        relatedContextActions.style.display = 'none';
        relatedContextInsertBtn.disabled = true;
        relatedContextBadge.style.display = 'none';
      }
    }

    // Insert selected items to description
    relatedContextInsertBtn.addEventListener('click', () => {
      if (relatedContextSelectedItems.length === 0) return;

      let contextText = '\n\n---\n## Related Context\n\n';
      
      relatedContextSelectedItems.forEach(item => {
        const sourceLabel = {
          'slack': 'Slack',
          'notion': 'Notion',
          'gmail': 'Gmail',
          'linear': 'Linear',
          'ai': 'Recommendation'
        }[item.source] || item.source;

        contextText += `### ${sourceLabel}: ${item.title}\n`;
        if (item.snippet) {
          contextText += `> ${item.snippet.replace(/\n/g, '\n> ')}\n`;
        }
        if (item.url) {
          contextText += `[View](${item.url})\n`;
        }
        contextText += '\n';
      });

      descInput.value = (descInput.value + contextText).trim();
      
      // Clear selection
      relatedContextSelectedItems = [];
      updateRelatedContextActions();
      
      // Update UI
      document.querySelectorAll('.related-context-result-item.selected').forEach(el => {
        el.classList.remove('selected');
        el.querySelector('.related-context-result-checkbox').checked = false;
      });
    });
  </script>
</body>
</html>
