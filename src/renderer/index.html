<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Create Linear Issue</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f5f5f5;
      padding: 0;
      margin: 0;
      height: 100vh;
      overflow: hidden;
    }

    /* Top bar with traffic lights and settings */
    .top-bar {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: 40px;
      background: #f5f5f5;
      display: flex;
      align-items: center;
      justify-content: flex-end; /* Ïö∞Ï∏° Ï†ïÎ†¨ */
      padding: 0 16px;
      z-index: 1000;
      -webkit-app-region: drag;
    }

    .container {
      background: white;
      border-radius: 12px;
      margin: 52px 20px 20px 20px; /* top margin for top-bar */
      padding: 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      -webkit-app-region: no-drag;
      max-height: calc(100vh - 72px);
      overflow-y: auto;
    }

    h1 {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 0;
      color: #333;
    }

    /* Image Gallery */
    .image-gallery {
      display: flex;
      gap: 12px;
      overflow-x: auto;
      padding: 12px 0;
      margin-bottom: 16px;
      min-height: 100px;
      scrollbar-width: thin;
    }

    .image-gallery::-webkit-scrollbar {
      height: 6px;
    }

    .image-gallery::-webkit-scrollbar-track {
      background: #f0f0f0;
      border-radius: 3px;
    }

    .image-gallery::-webkit-scrollbar-thumb {
      background: #ccc;
      border-radius: 3px;
    }

    .gallery-item {
      position: relative;
      flex-shrink: 0;
      width: 120px;
      height: 90px;
      border-radius: 8px;
      overflow: hidden;
      border: 1px solid #e0e0e0;
      background: #fafafa;
    }

    .gallery-thumb {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .gallery-remove {
      position: absolute;
      top: 4px;
      right: 4px;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: rgba(0,0,0,0.6);
      color: white;
      border: none;
      cursor: pointer;
      font-size: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      line-height: 1;
      padding: 0;
      transition: background 0.2s;
    }

    .gallery-remove:hover {
      background: rgba(220,53,69,0.9);
    }

    .gallery-index {
      position: absolute;
      bottom: 4px;
      left: 4px;
      background: rgba(0,0,0,0.6);
      color: white;
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 4px;
    }

    .gallery-add {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: #f8f8f8;
      border: 2px dashed #ccc;
      cursor: pointer;
      transition: all 0.2s;
    }

    .gallery-add:hover {
      background: #e8e9f3;
      border-color: #5e6ad2;
    }

    .gallery-add.disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .gallery-add-icon {
      font-size: 24px;
      color: #666;
    }

    .gallery-add-text {
      font-size: 11px;
      color: #666;
      margin-top: 4px;
    }

    .preview {
      width: 100%;
      max-height: 150px;
      object-fit: contain;
      border-radius: 8px;
      border: 1px solid #e0e0e0;
      margin-bottom: 16px;
      background: #fafafa;
      display: none; /* Hidden, replaced by gallery */
    }

    .form-group {
      margin-bottom: 14px;
    }

    label {
      display: block;
      font-size: 13px;
      font-weight: 500;
      color: #555;
      margin-bottom: 6px;
    }

    input[type="text"],
    textarea,
    select {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 14px;
      font-family: inherit;
      transition: border-color 0.2s;
      -webkit-app-region: no-drag;
    }

    input[type="text"]:focus,
    textarea:focus,
    select:focus {
      outline: none;
      border-color: #5e6ad2;
    }

    textarea {
      resize: vertical;
      min-height: 144px; /* Í∏∞Î≥∏ ÎÜíÏù¥ 80% Ï¶ùÍ∞Ä (80px ‚Üí 144px) */
    }

    .row {
      display: flex;
      gap: 12px;
    }

    .row .form-group {
      flex: 1;
    }

    .buttons {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
      margin-top: 16px;
    }

    button {
      padding: 10px 20px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-cancel {
      background: #f5f5f5;
      border: 1px solid #ddd;
      color: #666;
    }

    .btn-cancel:hover {
      background: #eee;
    }

    .btn-submit {
      background: #5e6ad2;
      border: none;
      color: white;
    }

    .btn-submit:hover {
      background: #4c5abd;
    }

    .btn-submit:disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    .loading {
      display: none;
      text-align: center;
      padding: 20px;
      color: #666;
    }

    .error {
      color: #e74c3c;
      font-size: 13px;
      margin-top: 8px;
    }

    /* AI Loading spinner */
    .ai-loading {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      background: #f0f1ff;
      border-radius: 8px;
      margin-bottom: 14px;
      font-size: 13px;
      color: #5e6ad2;
    }

    .ai-loading.hidden {
      display: none;
    }

    .spinner {
      width: 16px;
      height: 16px;
      border: 2px solid #e0e0ff;
      border-top-color: #5e6ad2;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Searchable dropdown styles */
    .searchable-select {
      position: relative;
    }

    .searchable-select .select-trigger {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 14px;
      font-family: inherit;
      background: white;
      cursor: pointer;
      text-align: left;
      display: flex;
      justify-content: space-between;
      align-items: center;
      -webkit-app-region: no-drag;
    }

    .searchable-select .select-trigger:focus {
      outline: none;
      border-color: #5e6ad2;
    }

    .searchable-select .select-trigger::after {
      content: '‚ñº';
      font-size: 10px;
      color: #999;
    }

    .searchable-select .dropdown {
      display: none;
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: white;
      border: 1px solid #ddd;
      border-radius: 8px;
      margin-top: 4px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      z-index: 1000;
      max-height: 200px;
      overflow: hidden;
    }

    .searchable-select .dropdown.open {
      display: block;
    }

    .searchable-select .search-input {
      width: 100%;
      padding: 10px 12px;
      border: none;
      border-bottom: 1px solid #eee;
      font-size: 14px;
      outline: none;
    }

    .searchable-select .options {
      max-height: 150px;
      overflow-y: auto;
    }

    .searchable-select .option {
      padding: 10px 12px;
      cursor: pointer;
      font-size: 14px;
    }

    .searchable-select .option:hover {
      background: #f5f5f5;
    }

    .searchable-select .option.selected {
      background: #e8e9f3;
      color: #5e6ad2;
    }

    .searchable-select .option.hidden {
      display: none;
    }

    .searchable-select .no-results {
      padding: 10px 12px;
      color: #999;
      font-size: 13px;
    }

    /* Header */
    .header {
      margin-bottom: 16px;
    }

    /* Settings button in top-bar */
    .icon-btn {
      background: transparent;
      border: none; /* Î∞ïÏä§ Ï†úÍ±∞ */
      width: auto;
      height: auto;
      padding: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 21px; /* 1.5Î∞∞ ÌÅ¨Í∏∞ (14px * 1.5 = 21px) */
      cursor: pointer;
      transition: opacity 0.2s;
      -webkit-app-region: no-drag;
      opacity: 0.7;
    }

    .icon-btn:hover {
      opacity: 1;
    }

    /* Image Preview Modal */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 2000;
      display: flex;
      align-items: center;
      justify-content: center;
      -webkit-app-region: no-drag; /* Ïã†Ìò∏Îì± ÌÅ¥Î¶≠ Î∞©ÏßÄ */
    }

    .modal.hidden {
      display: none;
    }

    .modal-backdrop {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      -webkit-app-region: no-drag; /* Ïã†Ìò∏Îì± ÌÅ¥Î¶≠ Î∞©ÏßÄ */
    }

    .modal-content {
      position: relative;
      max-width: 90vw;
      max-height: 90vh;
    }

    .modal-content img {
      max-width: 100%;
      max-height: 85vh;
      object-fit: contain;
      border-radius: 8px;
      box-shadow: 0 4px 24px rgba(0, 0, 0, 0.3);
    }

    .modal-close {
      position: absolute;
      top: -12px;
      right: -12px;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: #fff;
      border: none;
      font-size: 20px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
      padding: 0;
      line-height: 1;
    }

    .modal-close:hover {
      background: #f0f0f0;
    }

    .gallery-thumb {
      cursor: pointer;
    }

    /* Success Screen */
    .success-screen {
      text-align: center;
      padding: 40px 20px;
    }

    .success-screen.hidden {
      display: none;
    }

    .success-icon {
      font-size: 48px;
      margin-bottom: 16px;
    }

    .success-title {
      font-size: 18px;
      font-weight: 600;
      color: #1a1a1a;
      margin-bottom: 8px;
    }

    .success-issue-id {
      font-size: 14px;
      color: #5e6ad2;
      font-weight: 500;
      margin-bottom: 24px;
    }

    .success-buttons {
      display: flex;
      gap: 12px;
      justify-content: center;
      margin-bottom: 16px;
    }

    .success-buttons .btn-submit,
    .success-buttons .btn-cancel {
      min-width: 120px;
    }

    .success-hint {
      font-size: 12px;
      color: #888;
    }

    /* Shortcut hint */
    .shortcut-hint {
      font-size: 12px;
      color: #888;
      margin-top: 4px;
    }

    .shortcut-hint kbd {
      background: #f0f0f0;
      padding: 2px 6px;
      border-radius: 4px;
      border: 1px solid #ddd;
      font-family: -apple-system, BlinkMacSystemFont, monospace;
      font-size: 11px;
    }

    /* Token warning banner */
    .token-warning {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      background: #fef3cd;
      border: 1px solid #ffc107;
      border-radius: 8px;
      padding: 12px 16px;
      margin-bottom: 16px;
    }

    .token-warning.hidden {
      display: none;
    }

    .token-warning-content {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
      color: #856404;
    }

    .token-warning-icon {
      font-size: 16px;
    }

    .token-warning-btn {
      padding: 6px 12px;
      background: #fff;
      border: 1px solid #ffc107;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 500;
      color: #856404;
      cursor: pointer;
      white-space: nowrap;
      transition: all 0.2s;
    }

    .token-warning-btn:hover {
      background: #fff3cd;
    }

    /* Label Multi-select Styles */
    .label-select {
      position: relative;
    }

    .label-chips-container {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      padding: 8px 10px;
      min-height: 42px;
      border: 1px solid #ddd;
      border-radius: 8px;
      background: white;
      cursor: pointer;
      transition: border-color 0.2s;
      align-items: center;
    }

    .label-chips-container:hover {
      border-color: #bbb;
    }

    .label-chips-container:focus-within {
      border-color: #5e6ad2;
    }

    .label-chip {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 3px 8px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 500;
      background: #f0f0f0;
      color: #333;
    }

    .label-chip-color {
      width: 8px;
      height: 8px;
      border-radius: 50%;
    }

    .label-chip-remove {
      background: none;
      border: none;
      padding: 0;
      margin-left: 2px;
      cursor: pointer;
      font-size: 14px;
      line-height: 1;
      color: #666;
      opacity: 0.6;
    }

    .label-chip-remove:hover {
      opacity: 1;
    }

    .label-add-btn {
      background: none;
      border: none;
      padding: 3px 8px;
      font-size: 12px;
      color: #888;
      cursor: pointer;
    }

    .label-add-btn:hover {
      color: #5e6ad2;
    }

    .label-dropdown {
      display: none;
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: white;
      border: 1px solid #ddd;
      border-radius: 8px;
      margin-top: 4px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      z-index: 1000;
      max-height: 220px;
      overflow: hidden;
    }

    .label-dropdown.open {
      display: block;
    }

    .label-search-input {
      width: 100%;
      padding: 10px 12px;
      border: none;
      border-bottom: 1px solid #eee;
      font-size: 14px;
      outline: none;
    }

    .label-options {
      max-height: 170px;
      overflow-y: auto;
    }

    .label-option {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 12px;
      cursor: pointer;
      font-size: 14px;
    }

    .label-option:hover {
      background: #f5f5f5;
    }

    .label-option.selected {
      background: #e8e9f3;
    }

    .label-option.hidden {
      display: none;
    }

    .label-option-color {
      width: 12px;
      height: 12px;
      border-radius: 3px;
      flex-shrink: 0;
    }

    .label-option-name {
      flex: 1;
    }

    .label-option-check {
      font-size: 14px;
      color: #5e6ad2;
    }

    .label-no-results {
      padding: 12px;
      color: #888;
      font-size: 13px;
      text-align: center;
    }

    .label-empty-hint {
      color: #999;
      font-size: 13px;
    }
  </style>
</head>
<body>
  <!-- Top bar with Settings button (aligned with traffic lights) -->
  <div class="top-bar">
    <button id="settingsBtn" class="icon-btn" title="Settings">‚öôÔ∏è</button>
  </div>

  <div class="container">
    <!-- Token warning banner -->
    <div id="tokenWarning" class="token-warning hidden">
      <div class="token-warning-content">
        <span class="token-warning-icon">‚ö†Ô∏è</span>
        <span>Linear API ÌÜ†ÌÅ∞Ïù¥ ÏÑ§Ï†ïÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§</span>
      </div>
      <button class="token-warning-btn" id="tokenWarningBtn">ÏÑ§Ï†ïÌïòÍ∏∞</button>
    </div>

    <div class="header">
      <h1>Create Linear Issue</h1>
      <div class="shortcut-hint" id="shortcutHint"><kbd>‚åò</kbd> + <kbd>Shift</kbd> + <kbd>L</kbd> Î°ú Ï∫°Ï≤ò (ÏµúÎåÄ 10Ïû•)</div>
    </div>

    <!-- Image Gallery (multiple images) -->
    <div id="imageGallery" class="image-gallery"></div>

    <!-- User Hint Input -->
    <div class="form-group" style="margin-bottom: 14px;">
      <textarea id="userHint" placeholder="ÏßëÏ§ëÌï† ÎÇ¥Ïö©ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî (ÏÑ†ÌÉùÏÇ¨Ìï≠)" style="min-height: 60px; height: 60px; resize: none; font-size: 13px; padding: 8px 12px;"></textarea>
    </div>

    <!-- Legacy single preview (hidden) -->
    <img id="preview" class="preview" src="" alt="Screenshot preview" />

    <div class="row" style="margin-bottom: 14px;">
      <div class="form-group" style="flex: 2;">
        <label for="aiModel">AI Model</label>
        <select id="aiModel" name="aiModel">
          <option value="gemini" selected>Gemini 3 Flash (Í∏∞Î≥∏)</option>
          <option value="haiku">Claude Haiku 4.5</option>
        </select>
      </div>
      <div class="form-group" style="flex: 1; display: flex; align-items: flex-end;">
        <button type="button" id="reanalyzeBtn" class="btn-submit" style="width: 100%; padding: 10px;">Î∂ÑÏÑù ÏãúÏûë</button>
      </div>
    </div>

    <div id="aiLoading" class="ai-loading hidden">
      <div class="spinner"></div>
      <span id="aiLoadingText">AIÍ∞Ä Ïä§ÌÅ¨Î¶∞ÏÉ∑ÏùÑ Î∂ÑÏÑù Ï§ë...</span>
    </div>

    <form id="issueForm">
      <div class="form-group">
        <label for="title">Title *</label>
        <input type="text" id="title" name="title" required placeholder="ÎåÄÏÉÅ - Íµ¨Ï≤¥Ï†Å ÎÇ¥Ïö© (Ïòà: Î°úÍ∑∏Ïù∏ - ÏÑ∏ÏÖò ÎßåÎ£å Ïò§Î•ò ÏàòÏ†ï)" />
      </div>

      <div class="form-group">
        <label for="description">Description</label>
        <textarea id="description" name="description" placeholder="Optional description..."></textarea>
      </div>

      <div class="row">
        <div class="form-group">
          <label for="team">Team *</label>
          <select id="team" name="team" required>
            <option value="">Select team...</option>
          </select>
        </div>

        <div class="form-group">
          <label for="project">Project</label>
          <div class="searchable-select" id="projectContainer">
            <button type="button" class="select-trigger" id="projectTrigger">
              <span>None</span>
            </button>
            <div class="dropdown" id="projectDropdown">
              <input type="text" class="search-input" id="projectSearch" placeholder="Search projects...">
              <div class="options" id="projectOptions"></div>
            </div>
            <input type="hidden" id="project" name="project" value="">
          </div>
        </div>
      </div>

      <div class="row">
        <div class="form-group">
          <label for="status">Status</label>
          <select id="status" name="status">
            <option value="">Default</option>
          </select>
        </div>

        <div class="form-group">
          <label for="priority">Priority</label>
          <select id="priority" name="priority">
            <option value="">No priority</option>
            <option value="1">üî¥ Urgent</option>
            <option value="2">üü† High</option>
            <option value="3">üü° Medium</option>
            <option value="4">üü¢ Low</option>
          </select>
        </div>
      </div>

      <div class="row">
        <div class="form-group">
          <label for="assignee">Assignee</label>
          <div class="searchable-select" id="assigneeContainer">
            <button type="button" class="select-trigger" id="assigneeTrigger">
              <span>Unassigned</span>
            </button>
            <div class="dropdown" id="assigneeDropdown">
              <input type="text" class="search-input" id="assigneeSearch" placeholder="Search assignees...">
              <div class="options" id="assigneeOptions"></div>
            </div>
            <input type="hidden" id="assignee" name="assignee" value="">
          </div>
        </div>

        <div class="form-group">
          <label for="estimate">Estimate</label>
          <select id="estimate" name="estimate">
            <option value="">None</option>
          </select>
        </div>
      </div>

      <div class="row">
        <div class="form-group">
          <label for="cycle">Cycle</label>
          <select id="cycle" name="cycle">
            <option value="">None</option>
          </select>
        </div>

        <div class="form-group">
          <label>Labels</label>
          <div class="label-select" id="labelSelect">
            <div class="label-chips-container" id="labelChipsContainer">
              <span class="label-empty-hint" id="labelEmptyHint">+ Add labels...</span>
            </div>
            <div class="label-dropdown" id="labelDropdown">
              <input type="text" class="label-search-input" id="labelSearchInput" placeholder="Search labels...">
              <div class="label-options" id="labelOptions"></div>
            </div>
          </div>
        </div>
      </div>

      <div id="error" class="error"></div>

      <div class="buttons">
        <button type="button" class="btn-cancel" id="cancelBtn">Cancel</button>
        <button type="submit" class="btn-submit" id="submitBtn">Create Issue</button>
      </div>
    </form>

    <div id="loading" class="loading">
      <div class="spinner" style="margin: 0 auto 10px;"></div>
      <span id="loadingText">Creating issue...</span>
    </div>

    <!-- Success Screen -->
    <div id="successScreen" class="success-screen hidden">
      <div class="success-icon">‚úÖ</div>
      <div class="success-title">Ïù¥ÏäàÍ∞Ä ÏÉùÏÑ±ÎêòÏóàÏäµÎãàÎã§!</div>
      <div class="success-issue-id" id="successIssueId"></div>
      <div class="success-buttons">
        <button type="button" class="btn-submit" id="viewIssueBtn">LinearÏóêÏÑú Î≥¥Í∏∞</button>
        <button type="button" class="btn-cancel" id="closeSuccessBtn">Îã´Í∏∞</button>
      </div>
      <div class="success-hint">URLÏù¥ ÌÅ¥Î¶ΩÎ≥¥ÎìúÏóê Î≥µÏÇ¨ÎêòÏóàÏäµÎãàÎã§</div>
    </div>
  </div>

  <!-- Image Preview Modal -->
  <div id="imageModal" class="modal hidden">
    <div class="modal-backdrop"></div>
    <div class="modal-content">
      <img id="modalImage" src="" alt="Preview" />
      <button class="modal-close" title="Close">√ó</button>
    </div>
  </div>

  <script>
    const { ipcRenderer } = require('electron');

    // Settings button
    const settingsBtn = document.getElementById('settingsBtn');
    settingsBtn.addEventListener('click', () => {
      ipcRenderer.invoke('open-settings');
    });

    // Token warning banner
    const tokenWarning = document.getElementById('tokenWarning');
    const tokenWarningBtn = document.getElementById('tokenWarningBtn');
    tokenWarningBtn.addEventListener('click', () => {
      ipcRenderer.invoke('open-settings');
    });

    // Check token status on load
    async function checkTokenStatus() {
      try {
        const settings = await ipcRenderer.invoke('get-settings');
        if (!settings || !settings.linearApiToken) {
          tokenWarning.classList.remove('hidden');
        } else {
          tokenWarning.classList.add('hidden');
        }
      } catch (error) {
        console.error('Failed to check token status:', error);
      }
    }
    checkTokenStatus();

    // Listen for settings changes to update warning
    ipcRenderer.on('settings-updated', () => {
      checkTokenStatus();
    });

    // Listen for Linear data updates (after token is saved)
    ipcRenderer.on('linear-data-updated', (event, data) => {
      console.log('Linear data updated:', data);

      // Update cached data
      allTeams = data.teams || [];
      allStates = data.states || [];
      allCycles = data.cycles || [];
      allProjects = data.projects || [];
      allUsers = data.users || [];
      allLabels = data.labels || [];

      // Repopulate team dropdown
      const currentTeamId = teamSelect.value;
      teamSelect.innerHTML = '<option value="">Select team...</option>';
      allTeams.forEach(team => {
        const option = document.createElement('option');
        option.value = team.id;
        option.textContent = `${team.name} (${team.key})`;
        if (team.id === data.defaultTeamId || team.id === currentTeamId) {
          option.selected = true;
        }
        teamSelect.appendChild(option);
      });

      // Reinitialize searchable dropdowns
      if (projectSearchable) {
        projectSearchable.setItems(allProjects);
      }
      if (assigneeSearchable) {
        assigneeSearchable.setItems(allUsers);
      }

      // Update team-dependent dropdowns if team is selected
      if (teamSelect.value) {
        updateTeamDependentDropdowns(teamSelect.value);
        updateLabelsForTeam();
      }

      console.log(`Refreshed: ${allTeams.length} teams, ${allProjects.length} projects, ${allUsers.length} users`);
    });

    const form = document.getElementById('issueForm');
    const preview = document.getElementById('preview');
    const titleInput = document.getElementById('title');
    const descInput = document.getElementById('description');
    const teamSelect = document.getElementById('team');
    const projectInput = document.getElementById('project');
    const statusSelect = document.getElementById('status');
    const prioritySelect = document.getElementById('priority');
    const assigneeInput = document.getElementById('assignee');
    const estimateSelect = document.getElementById('estimate');
    const cycleSelect = document.getElementById('cycle');
    const cancelBtn = document.getElementById('cancelBtn');
    const submitBtn = document.getElementById('submitBtn');
    const errorDiv = document.getElementById('error');
    const loadingDiv = document.getElementById('loading');
    const aiLoadingDiv = document.getElementById('aiLoading');
    const aiLoadingText = document.getElementById('aiLoadingText');
    const aiModelSelect = document.getElementById('aiModel');
    const reanalyzeBtn = document.getElementById('reanalyzeBtn');
    const loadingText = document.getElementById('loadingText');

    let currentFilePath = '';
    let isSubmitting = false; // Track form submission state

    // Multi-image gallery state
    const imageGallery = document.getElementById('imageGallery');
    let images = []; // Array of { filePath }
    let maxImages = 10;

    // Success Screen
    const successScreen = document.getElementById('successScreen');
    const successIssueId = document.getElementById('successIssueId');
    const viewIssueBtn = document.getElementById('viewIssueBtn');
    const closeSuccessBtn = document.getElementById('closeSuccessBtn');
    let createdIssueUrl = '';

    // Image Preview Modal
    const imageModal = document.getElementById('imageModal');
    const modalImage = document.getElementById('modalImage');
    const modalClose = imageModal.querySelector('.modal-close');
    const modalBackdrop = imageModal.querySelector('.modal-backdrop');

    function showImageModal(src) {
      modalImage.src = src;
      imageModal.classList.remove('hidden');
      // Î™®Îã¨Ïù¥ Ïó¥Î¶¨Î©¥ Ïã†Ìò∏Îì± Ïà®Í∏∞Í∏∞
      ipcRenderer.invoke('set-traffic-lights-visible', false);
    }

    function hideImageModal() {
      imageModal.classList.add('hidden');
      modalImage.src = '';
      // Î™®Îã¨Ïù¥ Îã´ÌûàÎ©¥ Ïã†Ìò∏Îì± Îã§Ïãú ÌëúÏãú
      ipcRenderer.invoke('set-traffic-lights-visible', true);
    }

    modalClose.addEventListener('click', (e) => {
      e.stopPropagation();
      hideImageModal();
    });
    modalBackdrop.addEventListener('click', (e) => {
      e.stopPropagation();
      hideImageModal();
    });
    // Î™®Îã¨ Ïª®ÌÖêÏ∏† ÌÅ¥Î¶≠ Ïãú Ïù¥Î≤§Ìä∏ Ï†ÑÌåå Î∞©ÏßÄ (Î∞∞Í≤ΩÏúºÎ°ú Ï†ÑÎã¨ Ïïà ÎêòÍ≤å)
    imageModal.querySelector('.modal-content').addEventListener('click', (e) => {
      e.stopPropagation();
    });

    // Render image gallery
    function renderGallery() {
      imageGallery.innerHTML = '';

      // Render existing images
      images.forEach((img, idx) => {
        const item = document.createElement('div');
        item.className = 'gallery-item';
        // Disable remove button during submission
        const removeDisabled = isSubmitting ? 'disabled style="opacity:0.5;cursor:not-allowed;"' : '';
        item.innerHTML = `
          <img class="gallery-thumb" src="file://${img.filePath}" alt="Screenshot ${idx + 1}" />
          <span class="gallery-index">${idx + 1}</span>
          <button class="gallery-remove" data-index="${idx}" title="Remove image" ${removeDisabled}>√ó</button>
        `;
        // Ïç∏ÎÑ§Ïùº ÌÅ¥Î¶≠ Ïãú Î™®Îã¨Î°ú ÌôïÎåÄ Î≥¥Í∏∞
        const thumb = item.querySelector('.gallery-thumb');
        thumb.addEventListener('click', () => {
          if (!isSubmitting) {
            showImageModal(`file://${img.filePath}`);
          }
        });
        imageGallery.appendChild(item);
      });

      // Add "+" button if under limit and not submitting
      if (images.length < maxImages && !isSubmitting) {
        const addBtn = document.createElement('div');
        addBtn.className = 'gallery-item gallery-add';
        const labelText = images.length === 0 ? 'Ï∫°Ï≤òÌïòÍ∏∞' : `Ï∂îÍ∞Ä (${images.length}/${maxImages})`;
        addBtn.innerHTML = `
          <span class="gallery-add-icon">${images.length === 0 ? 'üì∏' : '+'}</span>
          <span class="gallery-add-text">${labelText}</span>
        `;
        addBtn.addEventListener('click', requestAddCapture);
        imageGallery.appendChild(addBtn);
      }

      // Update first image as currentFilePath for re-analysis
      if (images.length > 0) {
        currentFilePath = images[0].filePath;
      }
    }

    // Request additional capture via IPC
    function requestAddCapture() {
      if (isSubmitting) return;
      ipcRenderer.invoke('add-capture');
    }

    // Handle remove button clicks via event delegation
    imageGallery.addEventListener('click', (e) => {
      if (e.target.classList.contains('gallery-remove') && !isSubmitting) {
        const index = parseInt(e.target.dataset.index);
        ipcRenderer.invoke('remove-capture', { index });
      }
    });

    // Handle new image added
    ipcRenderer.on('capture-added', (event, data) => {
      console.log('Capture added:', data);
      images.push({ filePath: data.filePath });
      maxImages = data.canAddMore ? maxImages : images.length;
      renderGallery();
    });

    // Handle image removed
    ipcRenderer.on('capture-removed', (event, data) => {
      console.log('Capture removed:', data);
      images.splice(data.index, 1);
      renderGallery();
    });

    // Searchable select elements
    const projectTrigger = document.getElementById('projectTrigger');
    const projectDropdown = document.getElementById('projectDropdown');
    const projectSearch = document.getElementById('projectSearch');
    const projectOptions = document.getElementById('projectOptions');

    const assigneeTrigger = document.getElementById('assigneeTrigger');
    const assigneeDropdown = document.getElementById('assigneeDropdown');
    const assigneeSearch = document.getElementById('assigneeSearch');
    const assigneeOptions = document.getElementById('assigneeOptions');

    let imageUrl = '';
    let allStates = [];
    let allCycles = [];
    let allTeams = [];
    let allProjects = [];
    let allUsers = [];
    let allLabels = [];
    let selectedLabelIds = [];  // Currently selected label IDs

    // Label select elements
    const labelSelect = document.getElementById('labelSelect');
    const labelChipsContainer = document.getElementById('labelChipsContainer');
    const labelEmptyHint = document.getElementById('labelEmptyHint');
    const labelDropdown = document.getElementById('labelDropdown');
    const labelSearchInput = document.getElementById('labelSearchInput');
    const labelOptions = document.getElementById('labelOptions');

    // Searchable select helper functions
    function createSearchableSelect(config) {
      const { trigger, dropdown, searchInput, optionsContainer, hiddenInput, items, defaultLabel, getValue, getLabel, onSelect } = config;

      function render(filteredItems) {
        optionsContainer.innerHTML = '';

        // Add default option
        const defaultOpt = document.createElement('div');
        defaultOpt.className = 'option' + (hiddenInput.value === '' ? ' selected' : '');
        defaultOpt.textContent = defaultLabel;
        defaultOpt.dataset.value = '';
        defaultOpt.addEventListener('click', () => selectOption('', defaultLabel, null));
        optionsContainer.appendChild(defaultOpt);

        if (filteredItems.length === 0 && searchInput.value) {
          const noResults = document.createElement('div');
          noResults.className = 'no-results';
          noResults.textContent = 'No results found';
          optionsContainer.appendChild(noResults);
        } else {
          filteredItems.forEach(item => {
            const opt = document.createElement('div');
            opt.className = 'option' + (hiddenInput.value === getValue(item) ? ' selected' : '');
            opt.textContent = getLabel(item);
            opt.dataset.value = getValue(item);
            opt.addEventListener('click', () => selectOption(getValue(item), getLabel(item), item));
            optionsContainer.appendChild(opt);
          });
        }
      }

      function selectOption(value, label, item) {
        hiddenInput.value = value;
        trigger.querySelector('span').textContent = label;
        dropdown.classList.remove('open');
        searchInput.value = '';
        render(items);
        if (onSelect) {
          onSelect(value, label, item);
        }
      }

      function filter() {
        const query = searchInput.value.toLowerCase();
        const filtered = items.filter(item => getLabel(item).toLowerCase().includes(query));
        render(filtered);
      }

      trigger.addEventListener('click', (e) => {
        e.stopPropagation();
        // Close other dropdowns
        document.querySelectorAll('.dropdown.open').forEach(d => {
          if (d !== dropdown) d.classList.remove('open');
        });
        dropdown.classList.toggle('open');
        if (dropdown.classList.contains('open')) {
          searchInput.focus();
        }
      });

      searchInput.addEventListener('input', filter);
      searchInput.addEventListener('click', (e) => e.stopPropagation());

      return { render, selectOption, setItems: (newItems) => { items.length = 0; items.push(...newItems); render(items); } };
    }

    // Close dropdowns when clicking outside
    document.addEventListener('click', (e) => {
      document.querySelectorAll('.dropdown.open').forEach(d => d.classList.remove('open'));
      // Close label dropdown if clicking outside
      if (!labelSelect.contains(e.target)) {
        labelDropdown.classList.remove('open');
      }
    });

    // ==================== Label Multi-Select Logic ====================

    // Toggle label dropdown
    labelChipsContainer.addEventListener('click', (e) => {
      e.stopPropagation();
      // Close other dropdowns
      document.querySelectorAll('.dropdown.open').forEach(d => d.classList.remove('open'));
      labelDropdown.classList.toggle('open');
      if (labelDropdown.classList.contains('open')) {
        labelSearchInput.focus();
        renderLabelOptions();
      }
    });

    // Label search
    labelSearchInput.addEventListener('input', () => {
      renderLabelOptions();
    });
    labelSearchInput.addEventListener('click', (e) => e.stopPropagation());

    // Render label options in dropdown
    function renderLabelOptions() {
      const query = labelSearchInput.value.toLowerCase();
      const selectedTeamId = teamSelect.value;

      // Filter labels: show workspace labels + selected team's labels
      const filteredLabels = allLabels.filter(label => {
        const matchesSearch = label.name.toLowerCase().includes(query);
        const matchesTeam = !label.teamId || label.teamId === selectedTeamId;
        return matchesSearch && matchesTeam;
      });

      labelOptions.innerHTML = '';

      if (filteredLabels.length === 0) {
        labelOptions.innerHTML = '<div class="label-no-results">No labels found</div>';
        return;
      }

      filteredLabels.forEach(label => {
        const isSelected = selectedLabelIds.includes(label.id);
        const option = document.createElement('div');
        option.className = 'label-option' + (isSelected ? ' selected' : '');
        option.innerHTML = `
          <span class="label-option-color" style="background-color: ${label.color}"></span>
          <span class="label-option-name">${label.name}</span>
          ${isSelected ? '<span class="label-option-check">‚úì</span>' : ''}
        `;
        option.addEventListener('click', (e) => {
          e.stopPropagation();
          toggleLabel(label.id);
        });
        labelOptions.appendChild(option);
      });
    }

    // Toggle label selection
    function toggleLabel(labelId) {
      const idx = selectedLabelIds.indexOf(labelId);
      if (idx === -1) {
        selectedLabelIds.push(labelId);
      } else {
        selectedLabelIds.splice(idx, 1);
      }
      renderLabelChips();
      renderLabelOptions();
    }

    // Render selected label chips
    function renderLabelChips() {
      // Clear container except empty hint
      labelChipsContainer.innerHTML = '';

      if (selectedLabelIds.length === 0) {
        labelChipsContainer.innerHTML = '<span class="label-empty-hint">+ Add labels...</span>';
        return;
      }

      selectedLabelIds.forEach(labelId => {
        const label = allLabels.find(l => l.id === labelId);
        if (!label) return;

        const chip = document.createElement('span');
        chip.className = 'label-chip';
        chip.innerHTML = `
          <span class="label-chip-color" style="background-color: ${label.color}"></span>
          ${label.name}
          <button type="button" class="label-chip-remove" data-id="${label.id}">√ó</button>
        `;
        labelChipsContainer.appendChild(chip);
      });

      // Add "+ Add" button at the end
      const addBtn = document.createElement('button');
      addBtn.type = 'button';
      addBtn.className = 'label-add-btn';
      addBtn.textContent = '+';
      addBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        labelDropdown.classList.add('open');
        labelSearchInput.focus();
        renderLabelOptions();
      });
      labelChipsContainer.appendChild(addBtn);
    }

    // Remove label chip via event delegation
    labelChipsContainer.addEventListener('click', (e) => {
      if (e.target.classList.contains('label-chip-remove')) {
        e.stopPropagation();
        const labelId = e.target.dataset.id;
        toggleLabel(labelId);
      }
    });

    // Re-render labels when team changes
    function updateLabelsForTeam() {
      // Remove labels that don't belong to the new team
      const selectedTeamId = teamSelect.value;
      selectedLabelIds = selectedLabelIds.filter(labelId => {
        const label = allLabels.find(l => l.id === labelId);
        return label && (!label.teamId || label.teamId === selectedTeamId);
      });
      renderLabelChips();
      renderLabelOptions();
    }

    // Initialize searchable selects
    let projectSearchable, assigneeSearchable;

    // Generate estimate options based on team settings
    function getEstimateOptions(team) {
      if (!team || team.issueEstimationType === 'notUsed') {
        return [];
      }

      const type = team.issueEstimationType;
      const allowZero = team.issueEstimationAllowZero;
      const extended = team.issueEstimationExtended;

      let options = [];

      if (type === 'fibonacci') {
        // Linear default fibonacci scale
        if (allowZero) options.push({ value: 0, label: '0' });
        if (extended) options.push({ value: 0.5, label: '0.5' });
        options.push(
          { value: 1, label: '1' },
          { value: 2, label: '2' },
          { value: 3, label: '3' },
          { value: 5, label: '5' },
          { value: 8, label: '8' }
        );
        if (extended) {
          options.push(
            { value: 13, label: '13' },
            { value: 21, label: '21' }
          );
        }
      } else if (type === 'exponential') {
        if (allowZero) options.push({ value: 0, label: '0' });
        options.push(
          { value: 1, label: '1' },
          { value: 2, label: '2' },
          { value: 4, label: '4' },
          { value: 8, label: '8' },
          { value: 16, label: '16' }
        );
        if (extended) {
          options.push({ value: 32, label: '32' });
        }
      } else if (type === 'linear') {
        if (allowZero) options.push({ value: 0, label: '0' });
        for (let i = 1; i <= (extended ? 10 : 5); i++) {
          options.push({ value: i, label: String(i) });
        }
      } else if (type === 'tShirt') {
        // T-shirt sizes mapped to numbers
        if (allowZero) options.push({ value: 0, label: 'None' });
        options.push(
          { value: 1, label: 'XS' },
          { value: 2, label: 'S' },
          { value: 3, label: 'M' },
          { value: 5, label: 'L' },
          { value: 8, label: 'XL' }
        );
        if (extended) {
          options.push({ value: 13, label: 'XXL' });
        }
      }

      return options;
    }

    // Update estimate dropdown based on team
    function updateEstimateDropdown(teamId) {
      const team = allTeams.find(t => t.id === teamId);
      estimateSelect.innerHTML = '<option value="">None</option>';

      const options = getEstimateOptions(team);
      options.forEach(opt => {
        const option = document.createElement('option');
        option.value = opt.value;
        option.textContent = opt.label + (opt.value !== 0 && typeof opt.value === 'number' && opt.label !== 'None' && !isNaN(Number(opt.label)) ? ' point' + (opt.value !== 1 ? 's' : '') : '');
        estimateSelect.appendChild(option);
      });
    }

    // Update status, cycle, and estimate dropdowns based on selected team
    function updateTeamDependentDropdowns(teamId) {
      // Update status dropdown (default to Todo)
      statusSelect.innerHTML = '';
      const teamStates = allStates.filter(state => state.teamId === teamId);
      const todoState = teamStates.find(state => state.name === 'Todo');

      teamStates.forEach(state => {
        const option = document.createElement('option');
        option.value = state.id;
        option.textContent = state.name;
        // Set Todo as default selected
        if (todoState && state.id === todoState.id) {
          option.selected = true;
        }
        statusSelect.appendChild(option);
      });

      // Update cycle dropdown
      cycleSelect.innerHTML = '<option value="">None</option>';
      const now = new Date();
      allCycles
        .filter(cycle => cycle.teamId === teamId)
        .forEach(cycle => {
          const option = document.createElement('option');
          option.value = cycle.id;

          // Format dates (MÏõî DÏùº)
          const startDate = new Date(cycle.startsAt);
          const endDate = new Date(cycle.endsAt);
          const formatDate = (d) => `${d.getMonth() + 1}Ïõî ${d.getDate()}Ïùº`;

          // Determine cycle status
          let status = '';
          if (now >= startDate && now <= endDate) {
            status = 'Current';
          } else if (startDate > now) {
            status = 'Upcoming';
          } else {
            status = 'Previous';
          }

          option.textContent = `Cycle ${cycle.number} (${formatDate(startDate)} - ${formatDate(endDate)}) ¬∑ ${status}`;
          cycleSelect.appendChild(option);
        });

      // Update estimate dropdown
      updateEstimateDropdown(teamId);
    }

    // Receive capture data from main process
    ipcRenderer.on('capture-ready', (event, data) => {
      console.log('Capture ready:', data);

      try {
      // Store teams, states, cycles, projects, users, labels for filtering
      allTeams = data.teams || [];
      allStates = data.states || [];
      allCycles = data.cycles || [];
      allProjects = data.projects || [];
      allUsers = data.users || [];
      allLabels = data.labels || [];

      console.log('AI analysis result:', { title: data.suggestedTitle, desc: data.suggestedDescription });

      // Handle multi-image data
      if (data.images && data.images.length > 0) {
        images = data.images.map(img => ({ filePath: img.filePath }));
        maxImages = data.maxImages || 10;
        currentFilePath = images[0].filePath;
        renderGallery();
      } else if (data.filePath) {
        // Backwards compatibility for single image
        images = [{ filePath: data.filePath }];
        currentFilePath = data.filePath;
        renderGallery();
      }

      // Legacy (hidden)
      imageUrl = data.imageUrl || '';

      // Populate teams
      teamSelect.innerHTML = '<option value="">Select team...</option>';
      data.teams.forEach(team => {
        const option = document.createElement('option');
        option.value = team.id;
        option.textContent = `${team.name} (${team.key})`;
        if (team.id === data.defaultTeamId) {
          option.selected = true;
        }
        teamSelect.appendChild(option);
      });

      // Initialize searchable project dropdown
      projectSearchable = createSearchableSelect({
        trigger: projectTrigger,
        dropdown: projectDropdown,
        searchInput: projectSearch,
        optionsContainer: projectOptions,
        hiddenInput: projectInput,
        items: allProjects,
        defaultLabel: 'None',
        getValue: (p) => p.id,
        getLabel: (p) => p.name,
        onSelect: (value, label, project) => {
          // Debug logging for project-team validation
          console.log('Project selected:', { value, label, project });
          console.log('Project teamIds:', project?.teamIds);
          console.log('Current team:', teamSelect.value);

          // Skip if no project selected (None option)
          if (!value || !project) {
            console.log('No project selected, skipping team validation');
            return;
          }

          // Check teamIds
          const teamIds = project.teamIds || [];
          if (teamIds.length === 0) {
            console.warn('Project has no associated teams!');
            return;
          }

          const currentTeamId = teamSelect.value;
          if (!teamIds.includes(currentTeamId)) {
            // Current team is not in project's teams - switch to first team
            console.log(`Switching team from ${currentTeamId} to ${teamIds[0]}`);
            teamSelect.value = teamIds[0];
            updateTeamDependentDropdowns(teamIds[0]);
            updateLabelsForTeam();
          }
        }
      });
      projectSearchable.render(allProjects);

      // Initialize searchable assignee dropdown
      assigneeSearchable = createSearchableSelect({
        trigger: assigneeTrigger,
        dropdown: assigneeDropdown,
        searchInput: assigneeSearch,
        optionsContainer: assigneeOptions,
        hiddenInput: assigneeInput,
        items: allUsers,
        defaultLabel: 'Unassigned',
        getValue: (u) => u.id,
        getLabel: (u) => u.name
      });
      assigneeSearchable.render(allUsers);

      // Initialize team-dependent dropdowns
      if (data.defaultTeamId) {
        updateTeamDependentDropdowns(data.defaultTeamId);
      }

      // AI Î°úÎî© Ïä§ÌîºÎÑà Ïà®ÍπÄ Ïú†ÏßÄ (Î∂ÑÏÑù ÏãúÏûë Î≤ÑÌäº ÌÅ¥Î¶≠ Ïãú ÌëúÏãú)
      aiLoadingDiv.classList.add('hidden');
      reanalyzeBtn.textContent = 'Î∂ÑÏÑù ÏãúÏûë';
      reanalyzeBtn.disabled = false;

      // Reset form state
      titleInput.value = '';
      descInput.value = '';
      document.getElementById('userHint').value = '';
      prioritySelect.value = '';
      estimateSelect.value = '';
      selectedLabelIds = [];  // Reset labels
      renderLabelChips();
      errorDiv.textContent = '';
      submitBtn.disabled = false;
      cancelBtn.disabled = false;
      isSubmitting = false;
      form.style.display = 'block';
      loadingDiv.style.display = 'none';
      successScreen.classList.add('hidden');
      imageGallery.style.display = 'flex';
      createdIssueUrl = '';

      // Set default project if available
      if (data.defaultProjectId) {
        const project = allProjects.find(p => p.id === data.defaultProjectId);
        if (project) {
          projectSearchable.selectOption(project.id, project.name);
        }
      }

      // Focus title input
      titleInput.focus();
      } catch (error) {
        console.error('Error in capture-ready handler:', error);
      }
    });

    // Handle AI analysis results (received after window is shown)
    ipcRenderer.on('ai-analysis-ready', (event, data) => {
      console.log('AI analysis ready:', data);

      // Hide AI loading spinner
      aiLoadingDiv.classList.add('hidden');
      reanalyzeBtn.disabled = false;

      if (!data.success) {
        console.log('AI analysis failed or skipped');
        return;
      }

      // Î∂ÑÏÑù ÏÑ±Í≥µ Ïãú Î≤ÑÌäº ÌÖçÏä§Ìä∏ Î≥ÄÍ≤Ω
      reanalyzeBtn.textContent = 'Ïû¨Î∂ÑÏÑù';

      // Apply AI suggestions
      if (data.title) {
        titleInput.value = data.title;
        titleInput.select();
      }
      if (data.description) {
        descInput.value = data.description;
      }
      if (data.suggestedProjectId) {
        const project = allProjects.find(p => p.id === data.suggestedProjectId);
        if (project) {
          projectSearchable.selectOption(project.id, project.name);
        }
      }
      if (data.suggestedAssigneeId) {
        const user = allUsers.find(u => u.id === data.suggestedAssigneeId);
        if (user) {
          assigneeSearchable.selectOption(user.id, user.name);
        }
      }
      if (data.suggestedPriority) {
        prioritySelect.value = data.suggestedPriority.toString();
      }
      if (data.suggestedEstimate) {
        estimateSelect.value = data.suggestedEstimate.toString();
      }
    });

    // Update dropdowns when team changes
    teamSelect.addEventListener('change', () => {
      updateTeamDependentDropdowns(teamSelect.value);
      updateLabelsForTeam();  // Also update labels
    });

    // Handle form submission
    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      const title = titleInput.value.trim();
      const description = descInput.value.trim();
      const teamId = teamSelect.value;
      const projectId = projectInput.value;
      const stateId = statusSelect.value;
      const priority = prioritySelect.value;
      const assigneeId = assigneeInput.value;
      const estimate = estimateSelect.value;
      const cycleId = cycleSelect.value;

      if (!title) {
        errorDiv.textContent = 'Title is required';
        return;
      }

      if (!teamId) {
        errorDiv.textContent = 'Team is required';
        return;
      }

      // Validate project-team match before submission
      if (projectId) {
        const selectedProject = allProjects.find(p => p.id === projectId);
        if (selectedProject && selectedProject.teamIds && !selectedProject.teamIds.includes(teamId)) {
          errorDiv.textContent = 'ÏÑ†ÌÉùÌïú ÌîÑÎ°úÏ†ùÌä∏Í∞Ä Ìï¥Îãπ ÌåÄÏóê ÏÜçÌïòÏßÄ ÏïäÏäµÎãàÎã§. ÌåÄÏùÑ ÌôïÏù∏Ìï¥Ï£ºÏÑ∏Ïöî.';
          console.error('Project-team mismatch:', {
            projectId,
            projectTeamIds: selectedProject.teamIds,
            selectedTeamId: teamId
          });
          return;
        }
      }

      // Set submitting state
      isSubmitting = true;
      errorDiv.textContent = '';
      submitBtn.disabled = true;
      cancelBtn.disabled = true;
      reanalyzeBtn.disabled = true;
      form.style.display = 'none';
      loadingDiv.style.display = 'block';
      loadingText.textContent = images.length > 1
        ? `Uploading ${images.length} images...`
        : 'Creating issue...';
      renderGallery(); // Re-render to hide add button

      try {
        const result = await ipcRenderer.invoke('create-issue', {
          title,
          description,
          teamId,
          projectId: projectId || undefined,
          stateId: stateId || undefined,
          priority: priority ? parseInt(priority, 10) : undefined,
          assigneeId: assigneeId || undefined,
          estimate: estimate ? parseInt(estimate, 10) : undefined,
          cycleId: cycleId || undefined,
          labelIds: selectedLabelIds.length > 0 ? selectedLabelIds : undefined,
        });

        if (result.success) {
          // Success: show success screen
          loadingDiv.style.display = 'none';
          imageGallery.style.display = 'none';
          successIssueId.textContent = result.issueIdentifier || 'Issue created';
          createdIssueUrl = result.issueUrl || '';
          successScreen.classList.remove('hidden');
        } else {
          isSubmitting = false;
          form.style.display = 'block';
          loadingDiv.style.display = 'none';
          submitBtn.disabled = false;
          cancelBtn.disabled = false;
          reanalyzeBtn.disabled = false;
          errorDiv.textContent = result.error || 'Failed to create issue';
          // Show partial upload warning if applicable
          if (result.uploadedCount !== undefined && result.uploadedCount < images.length) {
            errorDiv.textContent += ` (${result.uploadedCount}/${images.length} images uploaded)`;
          }
          renderGallery();
        }
      } catch (err) {
        isSubmitting = false;
        form.style.display = 'block';
        loadingDiv.style.display = 'none';
        submitBtn.disabled = false;
        cancelBtn.disabled = false;
        reanalyzeBtn.disabled = false;
        errorDiv.textContent = err.message || 'Unknown error';
        renderGallery();
      }
    });

    // Handle cancel
    cancelBtn.addEventListener('click', () => {
      ipcRenderer.invoke('cancel');
    });

    // Handle Escape key
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        // Î™®Îã¨Ïù¥ Ïó¥Î†§ ÏûàÏúºÎ©¥ Î™®Îã¨Îßå Îã´Í∏∞
        if (!imageModal.classList.contains('hidden')) {
          hideImageModal();
          return;
        }
        ipcRenderer.invoke('cancel');
      }
    });

    // Handle re-analyze button
    reanalyzeBtn.addEventListener('click', async () => {
      if (!currentFilePath) return;

      const model = aiModelSelect.value;
      const modelName = model === 'haiku' ? 'Claude Haiku 4.5' : 'Gemini 3 Flash';
      const instruction = document.getElementById('userHint').value.trim();

      // Show loading
      aiLoadingText.textContent = `${modelName}Î°ú Ïû¨Î∂ÑÏÑù Ï§ë...`;
      aiLoadingDiv.classList.remove('hidden');
      reanalyzeBtn.disabled = true;

      try {
        await ipcRenderer.invoke('reanalyze', {
          filePath: currentFilePath,
          model: model,
          instruction: instruction || undefined
        });
      } catch (err) {
        console.error('Reanalyze error:', err);
        aiLoadingDiv.classList.add('hidden');
        reanalyzeBtn.disabled = false;
      }
    });

    // Success screen: View issue button
    viewIssueBtn.addEventListener('click', () => {
      if (createdIssueUrl) {
        require('electron').shell.openExternal(createdIssueUrl);
      }
      ipcRenderer.invoke('close-window');
    });

    // Success screen: Close button
    closeSuccessBtn.addEventListener('click', () => {
      ipcRenderer.invoke('close-window');
    });

    // ÌéòÏù¥ÏßÄ Î°úÎìú Ïãú Ï¥àÍ∏∞ Í∞§Îü¨Î¶¨ Î†åÎçîÎßÅ (Ï∫°Ï≤òÌïòÍ∏∞ Î≤ÑÌäº ÌëúÏãú)
    renderGallery();

    // ==================== Hotkey Hint Update ====================
    const shortcutHint = document.getElementById('shortcutHint');

    // Load and display current hotkey
    async function updateShortcutHint() {
      try {
        const result = await ipcRenderer.invoke('get-hotkey');
        if (result && result.displayHotkey) {
          // Parse display hotkey (e.g., "‚åò + ‚áß + L") into kbd elements
          const parts = result.displayHotkey.split(' + ').map(part => part.trim());
          const kbdHtml = parts.map(p => `<kbd>${p}</kbd>`).join(' + ');
          shortcutHint.innerHTML = `${kbdHtml} Î°ú Ï∫°Ï≤ò (ÏµúÎåÄ 10Ïû•)`;
        }
      } catch (error) {
        console.error('Failed to load hotkey:', error);
      }
    }
    updateShortcutHint();

    // Listen for hotkey changes
    ipcRenderer.on('hotkey-changed', (event, data) => {
      if (data && data.displayHotkey) {
        const parts = data.displayHotkey.split(' + ').map(part => part.trim());
        const kbdHtml = parts.map(p => `<kbd>${p}</kbd>`).join(' + ');
        shortcutHint.innerHTML = `${kbdHtml} Î°ú Ï∫°Ï≤ò (ÏµúÎåÄ 10Ïû•)`;
      }
    });
  </script>
</body>
</html>
