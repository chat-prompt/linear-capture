<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title data-i18n="capture.title">Create Linear Issue</title>
  <link rel="stylesheet" href="styles/tokens.css">
  <link rel="stylesheet" href="styles/reset.css">
  <link rel="stylesheet" href="styles/base.css">
  <link rel="stylesheet" href="styles/components/forms.css">
  <link rel="stylesheet" href="styles/components/buttons.css">
  <link rel="stylesheet" href="styles/components/spinner.css">
  <link rel="stylesheet" href="styles/pages/issue-form.css">
  <link rel="stylesheet" href="styles/features/gallery.css">
  <link rel="stylesheet" href="styles/features/dropdown.css">
  <link rel="stylesheet" href="styles/features/context.css">
  <link rel="stylesheet" href="styles/components/dialog.css">
</head>
<body>
  <!-- Top bar with Settings button (aligned with traffic lights) -->
  <div class="top-bar">
    <button id="settingsBtn" class="icon-btn" title="Settings">&#9881;&#65039;</button>
  </div>

  <div class="container">
    <!-- Token warning banner -->
    <div id="tokenWarning" class="token-warning hidden">
      <div class="token-warning-content">
        <span class="token-warning-icon">&#9888;&#65039;</span>
        <span data-i18n="dialogs.tokenWarning">Linear API token not set</span>
      </div>
      <button class="token-warning-btn" id="tokenWarningBtn" data-i18n="dialogs.tokenWarningButton">Set up</button>
    </div>

    <div class="header">
      <h1 data-i18n="capture.title">Create Linear Issue</h1>
      <div class="shortcut-hint" id="shortcutHint"></div>
    </div>

    <!-- Image Gallery (multiple images) -->
    <div id="imageGallery" class="image-gallery"></div>

    <!-- AI Analysis Section (hidden on success) -->
    <div id="aiAnalysisSection">
      <!-- User Hint Input -->
      <div class="form-group">
        <label for="userHint" data-i18n="form.prompt">Prompt</label>
        <textarea id="userHint" data-i18n-placeholder="form.userHintPlaceholder" placeholder="(Optional) Write what the AI should focus on when creating the Linear issue"></textarea>
      </div>

      <!-- Legacy single preview (hidden) -->
      <img id="preview" class="preview" src="" alt="Screenshot preview" />

      <div class="row ai-model-row">
        <div class="form-group">
          <label for="aiModel" data-i18n="form.aiModel">AI Model</label>
          <div class="custom-select" data-name="aiModel">
            <button type="button" class="select-display" id="aiModel-display">Gemini 3 Flash (Default)</button>
            <div class="select-options" id="aiModel-options">
              <div class="select-option selected" data-value="gemini">Gemini 3 Flash (Default)</div>
              <div class="select-option" data-value="haiku">Claude Haiku 4.5</div>
            </div>
            <input type="hidden" name="aiModel" id="aiModel" value="gemini">
          </div>
        </div>
        <div class="form-group">
          <button type="button" id="reanalyzeBtn" class="btn-submit">Start Analysis</button>
        </div>
      </div>
    </div>

    <div id="aiLoading" class="ai-loading hidden">
      <div class="spinner"></div>
      <span id="aiLoadingText" data-i18n="capture.analyzing">AI is analyzing the screenshot...</span>
    </div>

    <form id="issueForm">
      <div class="form-group">
        <label for="title" data-i18n="form.titleRequired">Title *</label>
        <input type="text" id="title" name="title" required data-i18n-placeholder="form.titlePlaceholder" placeholder="Target - Specific content (e.g., Login - Fix session expiry error)" />
      </div>

      <div class="form-group">
        <label for="description" data-i18n="form.description">Description</label>
        <textarea id="description" name="description" data-i18n-placeholder="form.descriptionPlaceholder" placeholder="Optional description..."></textarea>
      </div>

      <!-- Related Context Section (unified search for Slack, Notion, AI recommendations) -->
      <div id="relatedContextSection" class="related-context-section">
        <div class="related-context-header" id="relatedContextHeader">
          <div class="related-context-header-left">
            <span class="related-context-header-icon">&#128206;</span>
            <span class="related-context-header-title" data-i18n="relatedContext.findFrom">Find related content from Slack/Notion/Gmail</span>
            <span class="related-context-header-badge" id="relatedContextBadge" style="display: none;">0</span>
          </div>
          <span class="related-context-header-toggle">&#9660;</span>
        </div>
        <div class="related-context-body">
          <!-- Not Connected Banner -->
          <div id="relatedContextNotConnected" class="related-context-not-connected-banner" style="display: none;">
            <div class="not-connected-content">
              <span class="not-connected-icon">&#128268;</span>
              <span class="not-connected-text" data-i18n="relatedContext.notConnectedHint">Connect Slack, Notion, or Gmail to search related content</span>
            </div>
            <button type="button" class="not-connected-btn" id="relatedContextOpenSettings" data-i18n="relatedContext.openSettings">Open Settings</button>
          </div>
          <!-- Mode Tabs -->
          <div class="related-context-tabs" id="relatedContextTabs">
            <button type="button" class="related-context-tab active" data-tab="auto" data-i18n="relatedContext.tabAuto">Auto</button>
            <button type="button" class="related-context-tab" data-tab="search" data-i18n="relatedContext.tabSearch">Search</button>
            <button type="button"
                    class="related-context-refresh-btn"
                    id="relatedContextRefreshBtn"
                    title="Reset to auto">
              &#128260;
            </button>
          </div>

          <!-- Search Row (visible only in Search tab) -->
          <div class="related-context-search-row" style="display: none;">
            <input type="text"
                   class="related-context-search-input"
                   id="relatedContextSearchInput"
                   data-i18n-placeholder="relatedContext.searchPlaceholder"
                   placeholder="Search related context...">
          </div>

          <!-- Source Filters (visible only in Search tab) -->
          <div class="related-context-source-filters" id="relatedContextSourceFilters" style="display: none;">
            <button type="button" class="source-filter-chip active" data-source="all" data-i18n="relatedContext.filterAll">All</button>
            <button type="button" class="source-filter-chip" data-source="slack"><svg class="filter-icon" viewBox="0 0 24 24" fill="none"><path d="M5.042 15.165a2.528 2.528 0 0 1-2.52 2.523A2.528 2.528 0 0 1 0 15.165a2.527 2.527 0 0 1 2.522-2.52h2.52v2.52zm1.271 0a2.527 2.527 0 0 1 2.521-2.52 2.527 2.527 0 0 1 2.521 2.52v6.313A2.528 2.528 0 0 1 8.834 24a2.528 2.528 0 0 1-2.521-2.522v-6.313z" fill="#E01E5A"/><path d="M8.834 5.042a2.528 2.528 0 0 1-2.521-2.52A2.528 2.528 0 0 1 8.834 0a2.528 2.528 0 0 1 2.521 2.522v2.52H8.834zm0 1.271a2.528 2.528 0 0 1 2.521 2.521 2.528 2.528 0 0 1-2.521 2.521H2.522A2.528 2.528 0 0 1 0 8.834a2.528 2.528 0 0 1 2.522-2.521h6.312z" fill="#36C5F0"/><path d="M18.956 8.834a2.528 2.528 0 0 1 2.522-2.521A2.528 2.528 0 0 1 24 8.834a2.528 2.528 0 0 1-2.522 2.521h-2.522V8.834zm-1.27 0a2.528 2.528 0 0 1-2.522 2.521 2.528 2.528 0 0 1-2.52-2.521V2.522A2.528 2.528 0 0 1 15.165 0a2.528 2.528 0 0 1 2.521 2.522v6.312z" fill="#2EB67D"/><path d="M15.165 18.956a2.528 2.528 0 0 1 2.521 2.522A2.528 2.528 0 0 1 15.165 24a2.527 2.527 0 0 1-2.52-2.522v-2.522h2.52zm0-1.27a2.527 2.527 0 0 1-2.52-2.522 2.527 2.527 0 0 1 2.52-2.52h6.313A2.528 2.528 0 0 1 24 15.165a2.528 2.528 0 0 1-2.522 2.521h-6.313z" fill="#ECB22E"/></svg> <span data-i18n="relatedContext.filterSlack">Slack</span></button>
            <button type="button" class="source-filter-chip" data-source="notion"><svg class="filter-icon" viewBox="0 0 24 24" fill="none"><path d="M4.459 4.208c.746.606 1.026.56 2.428.466l13.215-.793c.28 0 .047-.28-.046-.326L17.86 1.968c-.42-.326-.98-.7-2.055-.607L3.01 2.295c-.466.046-.56.28-.374.466l1.823 1.447zm.793 3.08v13.904c0 .747.373 1.027 1.214.98l14.523-.84c.841-.046.934-.56.934-1.166V6.354c0-.606-.233-.933-.747-.886l-15.177.887c-.56.046-.747.326-.747.933zm14.337.745c.093.42 0 .84-.42.888l-.7.14v10.264c-.608.327-1.168.514-1.635.514-.747 0-.934-.234-1.495-.933l-4.577-7.186v6.952l1.448.327s0 .84-1.168.84l-3.222.186c-.093-.186 0-.653.327-.746l.84-.233V9.854L7.822 9.76c-.094-.42.14-1.026.793-1.073l3.456-.233 4.764 7.279v-6.44l-1.215-.139c-.093-.514.28-.886.747-.933l3.222-.186zM2.877.466L16.039.014c1.635-.14 2.055.093 2.755.606l3.596 2.521c.56.373.746.466.746 1.072v17.04c0 .72-.28 1.19-1.12 1.236L6.03 23.466c-.653.046-1.025-.046-1.4-.56l-3.5-4.624c-.374-.56-.514-.98-.514-1.493V1.906c0-.653.28-1.12.98-1.16l1.281-.28z" fill="#000"/></svg> <span data-i18n="relatedContext.filterNotion">Notion</span></button>
            <button type="button" class="source-filter-chip" data-source="gmail"><svg class="filter-icon" viewBox="0 0 24 24" fill="none"><path d="M24 5.457v13.909c0 .904-.732 1.636-1.636 1.636h-3.819V11.73L12 16.64l-6.545-4.91v9.273H1.636A1.636 1.636 0 0 1 0 19.366V5.457c0-2.023 2.309-3.178 3.927-1.964L5.455 4.64 12 9.548l6.545-4.91 1.528-1.145C21.69 2.28 24 3.434 24 5.457z" fill="#EA4335"/></svg> <span data-i18n="relatedContext.filterGmail">Gmail</span></button>
            <button type="button" class="source-filter-chip" data-source="linear"><svg class="filter-icon" viewBox="0 0 24 24" fill="#5E6AD2"><path d="M2.886 4.18A11.982 11.982 0 0 1 11.99 0C18.624 0 24 5.376 24 12.009c0 3.64-1.62 6.903-4.18 9.105L2.887 4.18ZM1.817 5.626l16.556 16.556c-.524.33-1.075.62-1.65.866L.951 7.277c.247-.575.537-1.126.866-1.65ZM.322 9.163l14.515 14.515c-.71.172-1.443.282-2.195.322L0 11.358a12 12 0 0 1 .322-2.195Zm-.17 4.862 9.823 9.824a12.02 12.02 0 0 1-9.824-9.824Z"/></svg> <span data-i18n="relatedContext.filterLinear">Linear</span></button>
          </div>

          <!-- Status Hint -->
          <div class="related-context-status" id="relatedContextStatus">
            <span>&#128161;</span>
            <span data-i18n="relatedContext.hint">Edit search to refine results</span>
          </div>

          <!-- Loading -->
          <div id="relatedContextLoading" class="related-context-loading" style="display: none;">
            <div class="spinner"></div>
            <span data-i18n="relatedContext.searching">Searching Slack, Notion...</span>
          </div>

          <!-- Results -->
          <div id="relatedContextResults" class="related-context-results"></div>

          <!-- Empty State -->
          <div id="relatedContextEmpty" class="related-context-empty" style="display: none;">
            <span>&#129335;</span>
            <span data-i18n="relatedContext.noResults">No results found. Try different keywords.</span>
          </div>

          <!-- Actions -->
          <div class="related-context-actions" id="relatedContextActions" style="display: none;">
            <span class="related-context-selected-count" id="relatedContextSelectedCount">0 selected</span>
            <button type="button" class="related-context-insert-btn" id="relatedContextInsertBtn" disabled>
              <span>&#128206;</span>
              <span data-i18n="relatedContext.insertToDescription">Insert to Description</span>
            </button>
          </div>
        </div>
      </div>

      <!-- Linear Section - No auto-translate -->
      <div id="linearSection" data-no-translate>
      <div class="row">
        <div class="form-group">
          <label for="team">Team *</label>
          <div class="custom-select" data-name="team">
            <button type="button" class="select-display placeholder" id="team-display">Select team...</button>
            <div class="select-options" id="team-options"></div>
            <input type="hidden" name="team" id="team" value="" required>
          </div>
        </div>

        <div class="form-group">
          <label for="project">Project</label>
          <div class="searchable-select" id="projectContainer">
            <button type="button" class="select-trigger" id="projectTrigger">
              <span>None</span>
            </button>
            <div class="dropdown" id="projectDropdown">
              <input type="text" class="search-input" id="projectSearch" placeholder="Search projects...">
              <div class="options" id="projectOptions"></div>
            </div>
            <input type="hidden" id="project" name="project" value="">
          </div>
        </div>
      </div>

      <div class="row">
        <div class="form-group">
          <label for="status">Status</label>
          <div class="custom-select" data-name="status">
            <button type="button" class="select-display placeholder" id="status-display">Default</button>
            <div class="select-options" id="status-options"></div>
            <input type="hidden" name="status" id="status" value="">
          </div>
        </div>

        <div class="form-group">
          <label for="priority">Priority</label>
          <div class="custom-select" data-name="priority">
            <button type="button" class="select-display placeholder" id="priority-display">No priority</button>
            <div class="select-options" id="priority-options">
              <div class="select-option selected" data-value="">No priority</div>
              <div class="select-option" data-value="1">&#128308; Urgent</div>
              <div class="select-option" data-value="2">&#128992; High</div>
              <div class="select-option" data-value="3">&#128993; Medium</div>
              <div class="select-option" data-value="4">&#128994; Low</div>
            </div>
            <input type="hidden" name="priority" id="priority" value="">
          </div>
        </div>
      </div>

      <div class="row">
        <div class="form-group">
          <label for="assignee">Assignee</label>
          <div class="searchable-select" id="assigneeContainer">
            <button type="button" class="select-trigger" id="assigneeTrigger">
              <span>Unassigned</span>
            </button>
            <div class="dropdown" id="assigneeDropdown">
              <input type="text" class="search-input" id="assigneeSearch" placeholder="Search assignees...">
              <div class="options" id="assigneeOptions"></div>
            </div>
            <input type="hidden" id="assignee" name="assignee" value="">
          </div>
        </div>

        <div class="form-group">
          <label for="estimate">Estimate</label>
          <div class="custom-select" data-name="estimate">
            <button type="button" class="select-display placeholder" id="estimate-display">None</button>
            <div class="select-options" id="estimate-options"></div>
            <input type="hidden" name="estimate" id="estimate" value="">
          </div>
        </div>
      </div>

      <div class="row">
        <div class="form-group">
          <label for="cycle">Cycle</label>
          <div class="custom-select" data-name="cycle">
            <button type="button" class="select-display placeholder" id="cycle-display">None</button>
            <div class="select-options" id="cycle-options"></div>
            <input type="hidden" name="cycle" id="cycle" value="">
          </div>
        </div>

        <div class="form-group">
          <label>Labels</label>
          <div class="label-select" id="labelSelect">
            <div class="label-chips-container" id="labelChipsContainer">
              <span class="label-empty-hint" id="labelEmptyHint">+ Add labels...</span>
            </div>
            <div class="label-dropdown" id="labelDropdown">
              <input type="text" class="label-search-input" id="labelSearchInput" placeholder="Search labels...">
              <div class="label-options" id="labelOptions"></div>
            </div>
          </div>
        </div>
      </div>
      </div><!-- End linearSection -->

      <div id="error" class="error"></div>

      <div class="buttons">
        <button type="button" class="btn-cancel" id="cancelBtn" data-i18n="common.cancel">Cancel</button>
        <button type="submit" class="btn-submit" id="submitBtn" data-i18n="form.createIssue">Create Issue</button>
      </div>
    </form>

    <div id="loading" class="loading">
      <div class="spinner"></div>
      <span id="loadingText">Creating issue...</span>
    </div>

    <!-- Success Screen -->
    <div id="successScreen" class="success-screen hidden">
      <div class="success-icon">&#9989;</div>
      <div class="success-title" data-i18n="success.title">Issue created!</div>
      <div class="success-issue-id" id="successIssueId"></div>
      <div class="success-buttons">
        <button type="button" class="btn-submit" id="viewIssueBtn" data-i18n="success.viewInLinear">View in Linear</button>
        <button type="button" class="btn-cancel" id="closeSuccessBtn" data-i18n="common.close">Close</button>
      </div>
      <div class="success-hint" data-i18n="success.urlCopied">URL copied to clipboard</div>
    </div>
  </div>

  <!-- Image Preview Modal -->
  <div id="imageModal" class="modal hidden">
    <div class="modal-backdrop"></div>
    <div class="modal-content">
      <img id="modalImage" src="" alt="Preview" />
      <button class="modal-close" title="Close">&times;</button>
    </div>
  </div>

  <script src="scripts/main/app.js"></script>
</body>
</html>
