# F07-지메일 (Gmail Integration) 기능 통합 문서

## 개요

Linear Capture 앱에 Gmail 연동을 추가한 기능. OAuth 2.0 인증으로 사용자의 Gmail 계정에 연결하여 이슈 생성 시 관련 메일을 검색/참조할 수 있도록 구현. Slack/Notion과 동일한 패턴으로 구현되며, Worker(Cloudflare)에서 토큰을 관리하고 앱은 클라이언트 역할.

**완료 버전**: v1.2.9 (2025-01-30)

**핵심 파일**:

| 파일 | 역할 |
|------|------|
| `src/services/gmail-client.ts` | Gmail 서비스 클라이언트 (OAuth, 검색) |
| `src/services/sync-adapters/gmail-sync.ts` | 로컬 DB 동기화 어댑터 |
| `src/services/context-adapters/gmail-adapter.ts` | 실시간 API 검색 (fallback용) |
| `src/main/index.ts` | deep link handler + IPC handlers |
| `src/renderer/settings.html` | Gmail 연결 UI 섹션 |
| Worker `src/gmail/oauth.ts` | OAuth 엔드포인트 (Worker 측) |

---

## 구현 히스토리

### Phase 1: Gmail OAuth + 검색 기본 구현

**GCP 설정**:
- Google Cloud Console에서 Gmail API 활성화
- OAuth 2.0 Client ID 생성 (웹 애플리케이션)
- Redirect URI: `https://linear-capture-ai.ny-4f1.workers.dev/gmail/oauth-redirect`
- Scope: `https://www.googleapis.com/auth/gmail.readonly` (읽기 전용)

**Worker 엔드포인트** (6개):

| 엔드포인트 | 역할 |
|-----------|------|
| `GET /gmail/auth` | OAuth URL 생성 (state에 deviceId 포함) |
| `GET /gmail/oauth-redirect` | OAuth callback HTML (deep link redirect) |
| `POST /gmail/callback` | code -> token 교환, KV에 저장 |
| `GET /gmail/status` | 연결 상태 확인 (토큰 유효성 검증) |
| `POST /gmail/disconnect` | 토큰 삭제 |
| `GET /gmail/search` | 메일 검색 (토큰 자동 갱신 포함) |

**앱 클라이언트** (`gmail-client.ts`):
- `GmailService` 클래스: `startOAuthFlow()`, `handleCallback()`, `getConnectionStatus()`, `disconnect()`, `searchEmails()`
- Slack/Notion 클라이언트와 동일한 팩토리 패턴 (`createGmailService()`)
- 검색 결과: `id`, `threadId`, `subject`, `from`, `date`, `snippet`

**앱 통합**:
- `main/index.ts`에 deep link handler 추가 (`linear-capture://gmail/callback`)
- IPC handlers 4개: `gmail-connect`, `gmail-disconnect`, `gmail-status`, `gmail-search`
- Settings UI에 Gmail 연결 섹션 (Google 브랜드 컬러 `#EA4335`)

### Phase 2: 토큰 지속성 버그 수정

**문제**: Gmail 연결 후 앱 재시작 시 연결이 해제됨 (Slack/Notion은 정상)

**근본 원인**: Worker의 `token-storage.ts` KV TTL 로직

| 서비스 | expires_at | refresh_token | KV TTL | 결과 |
|--------|-----------|---------------|--------|------|
| Slack | 없음 | 없음 | 영구 | 정상 |
| Notion | 없음 | 없음 | 영구 | 정상 |
| Gmail | 1시간 | 있음 | **1시간** | KV 삭제됨 |

Gmail의 access_token은 1시간 후 만료되지만 refresh_token은 영구적. 그런데 KV의 TTL이 access_token 만료 시간(1시간)으로 설정되어 KV 키 자체가 삭제됨 (refresh_token 포함).

**수정**: `storeTokens()`에서 `refresh_token`이 있으면 TTL을 설정하지 않음 (영구 보관)

```typescript
// Before
const expirationTtl = tokens.expires_at
  ? Math.max(tokens.expires_at - Math.floor(Date.now() / 1000), 60)
  : undefined;

// After
const expirationTtl = tokens.refresh_token
  ? undefined  // 영구 보관
  : tokens.expires_at
    ? Math.max(tokens.expires_at - Math.floor(Date.now() / 1000), 60)
    : undefined;
```

### Phase 3: Gmail Sync + 로컬 컨텍스트 검색 전환

**Gmail Sync Adapter** (`sync-adapters/gmail-sync.ts`):
- `notion-sync.ts` 패턴을 그대로 복사하여 Gmail용으로 수정
- `sync()`: 전체 동기화 (최근 1000개 이메일)
- `syncIncremental()`: 마지막 커서 이후 이메일만 동기화
- Gmail date 형식 변환: ISO string -> `after:YYYY/MM/DD` 쿼리 형식
- DB 저장: `source_type='gmail'`, metadata에 `from`, `fromName`, `threadId` 포함
- content_hash로 중복 방지

**LocalSearchService 통합** (`local-search.ts`):
- `DatabaseRow.source_type`에 `'gmail'` 추가
- `SyncStatus`에 `gmail` 필드 추가
- `syncSource('gmail')` case 추가
- `syncAll()`에 gmail 포함 (`sources = ['slack', 'notion', 'linear', 'gmail']`)

**context.getRelated 로컬 전환** (`ipc-handlers.ts`):
- 기존: 각 서비스 API 직접 호출 (Slack, Notion, Gmail, Linear)
- 변경: `LocalSearchService`에서 전체 로컬 DB 검색
- source별 그룹핑 후 각 5개씩 반환 (`QUOTA_PER_SOURCE = 5`)
- LocalSearchService 미초기화 시 기존 API 호출로 fallback

---

## 주요 결정사항

| 결정 | 이유 |
|------|------|
| 읽기 전용(gmail.readonly) | 메일 검색만 필요, 보안 최소 권한 |
| Worker에서 토큰 관리 | Slack/Notion과 동일 패턴, deviceId 기준 |
| Deep link으로 OAuth callback | Electron 앱에서 OAuth redirect 처리 표준 방식 |
| Snippet만 반환 (본문 전체 X) | 컨텍스트 참조용으로 충분, 네트워크/저장소 절약 |
| sync-adapter와 context-adapter 분리 | sync는 로컬 DB 동기화, context는 실시간 API fallback |
| refresh_token 있으면 KV 영구 보관 | access_token 만료와 무관하게 갱신 가능해야 함 |

---

## 최종 아키텍처

```
앱 (Electron)
├── src/services/gmail-client.ts        # OAuth + 실시간 검색
├── src/services/sync-adapters/
│   └── gmail-sync.ts                   # 로컬 DB 동기화
├── src/services/context-adapters/
│   └── gmail-adapter.ts                # API 직접 검색 (fallback)
├── src/services/local-search.ts        # 로컬 DB 통합 검색
├── src/main/index.ts                   # deep link + IPC handlers
└── src/renderer/settings.html          # Gmail 연결 UI

Worker (Cloudflare)
├── src/gmail/oauth.ts                  # OAuth 엔드포인트
├── src/oauth/token-storage.ts          # KV 토큰 저장 (TTL 수정됨)
└── Secrets: GOOGLE_CLIENT_ID, GOOGLE_CLIENT_SECRET
```

**인증 흐름**:
1. 앱: Settings > Gmail > Connect 클릭
2. 앱: Worker `/gmail/auth`로 OAuth URL 요청
3. Worker: Google OAuth URL 생성 (state에 deviceId 포함)
4. 사용자: 브라우저에서 Google 로그인 + 권한 승인
5. Google: Worker `/gmail/oauth-redirect`로 redirect
6. Worker: HTML 페이지에서 deep link (`linear-capture://gmail/callback`) redirect
7. 앱: deep link 수신 → Worker `/gmail/callback`으로 code 전달
8. Worker: code → token 교환, KV에 저장 (refresh_token 있으면 영구)
9. 앱: Settings에 "xxx@gmail.com 연결됨" 표시

**검색 흐름** (로컬 우선):
1. 이슈 생성 폼에서 컨텍스트 검색 실행
2. `LocalSearchService.search()` → PGlite 로컬 DB 검색
3. Gmail 결과 포함하여 source별 그룹핑 반환
4. 로컬 DB 미초기화 시 → `gmail-client.ts` API 직접 호출 fallback

---

## 미완료 사항 (추후 작업)

- 이슈 생성 폼에 Gmail 검색/선택 UI 추가
- 선택한 메일을 이슈 description에 참조로 첨부
- AI 기반 관련 메일 자동 추천
