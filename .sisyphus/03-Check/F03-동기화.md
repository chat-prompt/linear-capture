# F03 - 동기화 시스템 최적화

## 개요

Linear Capture의 데이터 동기화 시스템(Notion/Linear/Gmail) 전반에 대한 성능 최적화 및 버그 수정 기록.
주요 성과: Notion 6개 → 21k 페이지 동기화, Linear 15-20배 속도 향상, Gmail 배치 튜닝 + 재시도 로직 추가.

---

## Notion 동기화

### 문제 진단

| 증상 | 원인 |
|------|------|
| 21k 페이지 중 6개만 동기화 | `searchPages()` 호출 시 cursor/hasMore 페이지네이션 누락 |
| 로컬 캐시 사용 시 페이지네이션 불가 | `NotionLocalReader.searchPages()`가 `hasMore`/`nextCursor` 미반환 |
| 중첩 블록 본문 미수집 | Worker의 `blocks.ts`가 1레벨만 fetch (재귀 미구현) |

### 해결 내역

#### 1. 페이지네이션 수정 (`notion-sync-pagination`)

- `sync()`와 `syncIncremental()`에 `while(hasMore)` 루프 추가
- `NotionService.searchPages()`에 cursor 파라미터 지원
- 실패 시 커서 저장 → resume 가능
- TDD 방식으로 구현 (Vitest)

#### 2. 로컬 리더 우회 (`notion-sync-local-bypass`)

- **근본 원인**: 로컬 리더는 검색 UI용으로 설계됨, Sync에서 사용하면 페이지네이션 작동 안 함
- **해결**: `NotionService.searchPagesForSync()` 메서드 추가 (항상 API 사용, 로컬 리더 우회)
- 기존 `searchPages()`는 변경 없음 (UI 검색 영향 없음)

#### 3. 성능 최적화 (`notion-sync-perf`)

| 항목 | 변경 전 | 변경 후 |
|------|---------|---------|
| 처리 방식 | 순차 N+1 API 호출 | 배치 처리 (embedBatch 300개) |
| API 병렬화 | 없음 | `getPageContent()` 동시 3개 |
| 콘텐츠 제한 | 무제한 | 2000자 (`getFullPageContent()`) |
| 예상 시간 (21k) | ~125분 | ~25분 (**~5배 개선**) |

#### 4. 블록 가져오기 수정 (`notion-blocks-fix`)

Worker(`blocks.ts`) 재작성:
- 재귀적 블록 가져오기 (depth 3까지)
- 페이지네이션 (`has_more` + `next_cursor`)
- Rate Limit 429 재시도 (최대 3회, 지수 백오프)
- 서브리퀘스트 예산 관리 (최대 40개)
- 순환 참조 방지 (방문 block ID Set 관리)

#### 5. 관측성 개선 (`notion-local-sync`)

- `console.log` → `logger` 통일
- Sync 로그에 검색 소스(`local`/`api`) 표시
- Settings UI에 마지막 동기화 소스 표시
- `SyncResult`에 `source` 필드 추가

---

## Linear 동기화

### 문제

- 이슈 동기화가 매우 느림
- `syncIssue()`에서 5개 관계를 순차 await (병목)
- 개별 `embedSingle()` 호출 (비효율)

### 해결 (`linear-sync-optimization`)

| 최적화 항목 | 변경 내용 |
|-------------|-----------|
| 댓글 동기화 제거 | `syncComments()`, `syncComment()` 삭제 (이슈만 동기화) |
| 관계 로딩 병렬화 | 순차 await → `Promise.all([team, project, state, assignee, labels()])` |
| 배치 처리 | 10개씩 `Promise.allSettled`로 병렬 처리 |
| 임베딩 배치 | `embedSingle()` → `embed(texts[])` 배치 호출 |
| 부분 실패 | 1개 실패해도 나머지 계속 처리, 성공한 것만 카운트 |
| 커서 관리 | 성공한 이슈 중 가장 최신 `updatedAt`으로 업데이트 |

**예상 성능**: **15-20배 속도 향상**

---

## Gmail 동기화

### 문제

- 100~500개 이메일에 1~3분 소요
- 재시도 로직 없음 (실패 시 즉시 throw)

### 해결 (`gmail-sync-speed-improvement`)

| 항목 | 변경 전 | 변경 후 |
|------|---------|---------|
| BATCH_SIZE | 40 | 150 |
| BATCH_DELAY_MS | 500ms | 200ms |
| 재시도 | 없음 | 3회 지수 백오프 (1s → 2s → 4s) |
| 비재시도 에러 | - | 401, 403은 즉시 실패 |
| UI 에러 표시 | 없음 | `.error` 클래스 + 재시도 횟수 표시 |

---

## 수동 테스트 절차 (`manual-test-sync-optimization`)

### 사전 준비
```bash
npm run pack:clean   # 빌드 + 패키징 + 실행
```

### 테스트 항목

| 테스트 | 확인 방법 | 성공 기준 |
|--------|----------|----------|
| Notion Sync | 콘솔에서 `sync:trigger, 'notion'` | "Using local reader" + "Embedding batch" 로그 |
| Gmail Sync | 콘솔에서 `sync:trigger, 'gmail'` | 배치 사이즈 100, 재시도 로직 로그 |
| Worker API | `curl` 엔드포인트 테스트 | 200 OK 응답 |
| OAuth 연결 | Settings > 각 서비스 상태 확인 | "Connected" 표시 |
| 이슈 생성 E2E | 캡처 → 분석 → 생성 | Linear에서 이슈 확인 |

---

## 성능 개선 종합

| 소스 | 변경 전 | 변경 후 | 개선 |
|------|---------|---------|------|
| Notion | 6개 / 느림 | 21k 페이지 / ~25분 | 페이지네이션 + 5배 속도 |
| Linear | 매우 느림 | 병렬 + 배치 | 15-20배 |
| Gmail | 1-3분 (100-500개) | 배치 튜닝 + 재시도 | ~60초 목표 |

## 변경 파일 요약

| 파일 | 변경 내용 |
|------|----------|
| `src/services/sync-adapters/notion-sync.ts` | 페이지네이션 루프, searchPagesForSync, 배치 임베딩, 로거 통일 |
| `src/services/notion-client.ts` | cursor 파라미터, searchPagesForSync 메서드 |
| `src/services/notion-local-reader.ts` | getFullPageContent 2000자 제한 |
| `src/services/sync-adapters/linear-sync.ts` | 댓글 제거, Promise.all 병렬화, 배치 처리 |
| `src/services/sync-adapters/gmail-sync.ts` | 배치 상수 튜닝, retryWithBackoff 추가 |
| `src/renderer/settings.html` | Gmail 에러 표시, Notion sync 소스 표시 |
| Worker `blocks.ts` | 재귀 + 페이지네이션 + rate limit |
