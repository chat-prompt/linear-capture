# F08 - 인프라 및 유지보수

## 개요

앱 인프라 관련 작업 모음: Analytics 지표 수집, 문서 업데이트, AI 분석 버그 수정, 머지 충돌 해결, AI 추천 어댑터 추가.

---

## Analytics 지표 수집 (`analytics-implementation`)

PMF 검증을 위한 최소 지표 수집 체계 구현.

### 이벤트 스키마

| 이벤트 | 용도 | 메타데이터 |
|--------|------|-----------|
| `app_open` | DAU 측정 | `appVersion` |
| `issue_created` | 핵심 기능 사용 | `appVersion` |
| `api_error` | Linear API 실패 | `errorType`, `message`, `statusCode` |
| `capture_failed` | 캡처 실패 | `errorType` (permission/cancelled/system_error) |
| `analysis_failed` | AI 분석 실패 | `errorType` (anthropic/gemini/network/timeout) |

### 구현 내용

- **Worker**: `VALID_EVENTS`에 에러 3종 추가, KV 저장 (90일 TTL)
- **App**: `trackApiError()`, `trackCaptureFailed()`, `trackAnalysisFailed()` 함수
- 모든 이벤트에 `appVersion` 자동 포함, 에러 메시지 200자 truncate
- fire-and-forget 패턴 유지 (실패 무시)

### 연동 위치

| 서비스 | 추적 함수 |
|--------|----------|
| `linear-client.ts` (createIssue, validateToken) | `trackApiError()` |
| `capture.darwin.ts` (실패/취소) | `trackCaptureFailed()` |
| `anthropic-analyzer.ts`, `gemini-analyzer.ts` | `trackAnalysisFailed()` |

---

## v1.2.10 문서 업데이트 (`docs-v1210-update`)

코드베이스에 맞게 프로젝트 문서 전면 업데이트.

### 변경 내용

| 파일 | 변경 |
|------|------|
| `README.md` | 기술 스택 섹션 교체 (PGlite, pgvector, i18next, Slack/Gmail API 등) |
| `src/services/CLAUDE.md` | 신규 생성 - 서비스 레이어 맵, Sync/Context Adapter 패턴, 검색 파이프라인 |
| `src/main/CLAUDE.md` | 신규 생성 - 메인 프로세스 구조, IPC 핸들러, OAuth Deep Link 플로우, AppState |

### 핵심 원칙
- 루트 CLAUDE.md와 내용 중복 금지
- 코드 파일 변경 금지
- `.sisyphus/` 파일 커밋 제외

---

## AI 분석 버그 수정 (`fix-ai-analysis`)

### 문제
모듈 분할 후 AI 분석이 `{success: false}` 반환.

### 근본 원인
```typescript
// JavaScript에서 빈 배열 []은 truthy
const imagePaths = state.captureSession?.images.map(img => img.filePath) || [data.filePath];
// [] || [data.filePath] → [] (fallback 미작동!)
```

### 수정
```typescript
const sessionImages = state.captureSession?.images.map(img => img.filePath);
const imagePaths = (sessionImages && sessionImages.length > 0) ? sessionImages : [data.filePath];
```

### 추가 개선
- 분석 실패 시 에러 정보를 renderer로 전달 (`error` 필드 추가)
- 디버깅 로그 추가 (세션 상태, 이미지 경로)

---

## 머지 충돌 해결 (`merge-cleanup`)

### 상황
`feat/local-vector-search` → master 머지 후 stash 복원 시 충돌 발생.

### 해결

| 충돌 파일 | 해결 방식 |
|----------|----------|
| `semantic-search.ts` import | 양쪽 모두 포함 (LocalVectorStore + logger) |
| `semantic-search.ts` error logging | `logger.error` 사용 + `[SemanticSearch]` prefix 유지 |

### 작업 흐름
충돌 해결 → `git add` → `npm run build` → `npm run pack:clean` → 리팩토링 커밋

---

## Notion/Gmail AI 추천 통합 (`notion-gmail-ai-recommend`)

### 목적
캡처 시점에 Notion 문서/Gmail 이메일이 AI 자동 추천에 포함되도록 통합.

### 구현

| 어댑터 | 소스 | 데이터 매핑 |
|--------|------|------------|
| `NotionAdapter` | `notion-client.ts` | `page.matchContext \|\| page.title` → content, `page.url` → url |
| `GmailAdapter` | `gmail-client.ts` | `msg.snippet` → content, `mail.google.com/.../${msg.id}` → url |

### 동적 분배 로직
- 연결된 서비스만 limit 나눔 (비연결 서비스는 에러 없이 스킵)
- 예: 3개 연결 시 각 ~25%, 1개만 연결 시 ~50% (AI 50%)
- `Promise.allSettled` 패턴 유지

### 변경 파일

| 파일 | 변경 |
|------|------|
| `context-adapters/notion-adapter.ts` | 신규 - ContextAdapter 구현 |
| `context-adapters/gmail-adapter.ts` | 신규 - ContextAdapter 구현 |
| `context-adapters/index.ts` | getAdapter switch에 notion/gmail 추가 |
| `ipc-handlers.ts` | semantic-gmail 태스크 추가, 동적 분배 로직 |
| `context-adapters.test.ts` | 신규 - NotionAdapter/GmailAdapter 단위 테스트 |
