# F05. Linear 통합 (완료)

Linear Capture 앱의 Linear API 연동 개선 작업 기록.

---

## 1. Linear 검색 디버깅

### 문제
- `context.getRelated` 핸들러에 Linear issueSearch API 통합 후 `linear: 0 results`
- 앱 실행 시 `Error: write EPIPE` / `Cannot create BrowserWindow before app is ready` 에러

### 해결
- `linear-client.ts`, `index.ts`의 디버그 `console.log` 전부 제거
- `console.error`(에러 로깅)만 유지
- Linear API 토큰 유효성 확인 후 검색 동작 정상화

### 관련 파일

| 파일 | 수정 내용 |
|------|----------|
| `src/services/linear-client.ts:332-353` | `searchIssues()` 메서드 디버그 로그 제거 |
| `src/main/index.ts:1137-1250` | `context.getRelated` 핸들러 디버그 로그 제거 |

---

## 2. Linear 인덱싱 수정 (Invalid JSON body)

### 문제
- Gmail, Notion, Slack 인덱싱 정상, Linear만 `Invalid JSON body` 에러
- **원인**: 다른 소스는 Worker가 OAuth 토큰으로 직접 API 호출하지만, Linear는 앱이 토큰 관리 → Worker에 토큰 없음

### 소스별 Worker 인덱싱 비교

| 소스 | Worker 동작 | 앱에서 보내는 것 |
|------|-------------|-----------------|
| Gmail/Slack/Notion | Worker가 저장된 OAuth 토큰으로 API 호출 | `POST /index/{source}?device_id=xxx` (body 없음) |
| **Linear** | **앱에서 issues 배열을 body로 전달** | `POST /index/linear` + `{ device_id, issues }` |

### 해결
1. `linear-client.ts`에 `getRecentIssues(limit)` 메서드 추가
   - `client.issues({ first: N, orderBy: UpdatedAt })` 사용
   - Worker 기대 형식(`id, identifier, title, description, url, state, updatedAt`)으로 매핑
2. `worker-indexing.ts`에 `indexLinearToWorker()` 전용 함수 추가
   - `createLinearServiceFromEnv()`로 인스턴스 생성 → `getRecentIssues(100)` 호출 → body에 포함

### 관련 파일

| 파일 | 역할 |
|------|------|
| `src/services/linear-client.ts` | `getRecentIssues()` + `LinearIssueForIndex` 인터페이스 |
| `src/services/worker-indexing.ts` | Linear 전용 인덱싱 분기 (`indexLinearToWorker()`) |

---

## 3. Linear 로컬 캐시 (프로젝트 매칭 개선)

### 개요
Linear Desktop App의 로컬 IndexedDB 캐시에서 "최근 이슈 제목"을 추출하여 AI 프로젝트 매칭 정확도를 50%에서 거의 100%로 향상.

### 아키텍처
- **Python 스크립트 spawn**: 기존 `slack-linear-sync`의 IndexedDB 파싱 코드 재활용
- **캐시 경로**: `~/Library/Application Support/Linear/IndexedDB/https_linear.app_0.indexeddb.leveldb`
- **Graceful fallback**: Python 미설치 / Linear Desktop 미설치 시 기존 방식 유지 (추가 API 호출 없음)

### 주요 결정사항

| 항목 | 결정 |
|------|------|
| 캐시 읽기 방식 | Python 스크립트 spawn (Native 모듈 회피) |
| 추출 범위 | 프로젝트별 최근 10개 이슈 제목 (완료/취소 제외) |
| 타임아웃 | 5초 |
| Assignee 기본값 | API 토큰 소유자 자동 설정 (viewer 정보 활용) |

### 구현 파일

| 파일 | 역할 |
|------|------|
| `scripts/export_linear_cache.py` | IndexedDB 캐시 읽기 (JSON stdout) |
| `src/services/linear-local-cache.ts` | Python spawn + JSON 파싱 서비스 |
| `src/main/index.ts` | 캐시 로드 + AI 컨텍스트 연동 |
| `src/services/gemini-analyzer.ts` | 프로젝트 컨텍스트에 최근 이슈 포함 |
| `src/services/anthropic-analyzer.ts` | 동일 |
| `src/renderer/index.html` | Assignee 기본값 설정 (`capture-ready` 이벤트) |
| `src/__tests__/linear-local-cache.test.ts` | 단위 테스트 (4 케이스) |

---

## 4. Linear Direct Upload (R2 → SDK fileUpload)

### 문제
- Worker URL 변경(`ny-4f1.workers.dev` → `kangjun-f0f.workers.dev`)으로 R2 이미지 업로드 실패

### 해결
Linear SDK `fileUpload()` API로 전환하여 Worker 의존성(업로드 부분) 제거.

### 업로드 흐름 비교

| 항목 | 기존 (R2) | 변경 (Linear SDK) |
|------|-----------|------------------|
| 1단계 | Worker에 POST → R2 업로드 | `fileUpload(contentType, filename, size)` → pre-signed URL |
| 2단계 | R2 URL 반환 | PUT으로 pre-signed URL에 업로드 |
| 반환값 | R2 URL | `assetUrl` (Linear CDN) |
| Worker 필요 | 필요 | 불필요 (AI 분석용만 유지) |

### 구현 파일

| 파일 | 역할 |
|------|------|
| `src/services/linear-uploader.ts` | Linear SDK 기반 업로더 (`upload`, `uploadMultiple`) |
| `src/main/ipc-handlers.ts` | `R2Uploader` → `LinearUploader` 교체 |
| `src/services/r2-uploader.ts` | 삭제하지 않고 백업 유지 (롤백용) |

### 핵심 원칙
- `UploadResult`, `MultiUploadResult` 인터페이스는 R2Uploader와 동일하게 유지
- Worker URL은 제거하지 않음 (AI 분석에 필요)
- 마크다운 이미지 포맷 유지: `![Screenshot N](url)`

---

## 관련 파일 요약

| 파일 | 역할 |
|------|------|
| `src/services/linear-client.ts` | Linear SDK 래퍼 (검색, 이슈 조회, 인덱싱용 fetch) |
| `src/services/linear-uploader.ts` | Linear SDK 직접 업로드 |
| `src/services/linear-local-cache.ts` | Desktop 캐시 읽기 서비스 |
| `src/services/worker-indexing.ts` | Worker 인덱싱 (Linear 전용 분기) |
| `src/main/ipc-handlers.ts` | IPC 핸들러 (업로더 교체) |
| `src/main/index.ts` | context.getRelated + 캐시 연동 |
| `scripts/export_linear_cache.py` | IndexedDB 캐시 추출 |
