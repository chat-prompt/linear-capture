# F02 - 검색 시스템

## 개요

Linear Capture의 로컬 검색 시스템 구축 과정을 정리한 문서. 스크린샷 캡처 후 AI 분석 시 관련 컨텍스트(Slack, Notion, Gmail, Linear)를 로컬에서 검색하여 이슈 생성 품질을 높이는 기능.

**핵심 구성요소:**

| 구성요소 | 역할 | 파일 |
|---------|------|------|
| PGlite (PostgreSQL WASM) | 로컬 DB, 벡터 저장, FTS | `src/services/database.ts` |
| EmbeddingService | OpenAI text-embedding-3-small | `src/services/embedding-service.ts` |
| LocalSearchService | 하이브리드 검색 오케스트레이터 | `src/services/local-search.ts` |
| HybridSearch (RRF) | 벡터 + FTS 결합 검색 | `src/services/hybrid-search.ts` |
| Sync Adapters | 소스별 동기화 어댑터 | `src/services/sync-adapters/*.ts` |

---

## 아키텍처 진화

### Phase 1: Worker 기반 시맨틱 검색 (초기)

```
앱 → Worker (/search) → Cloudflare Vectorize (bge-m3)
```

- Worker에서 임베딩 생성 및 벡터 검색 수행
- 오프라인 검색 불가, 네트워크 의존성 높음

### Phase 2: SQLite 로컬 벡터 저장 (sql.js)

```
앱 → Worker (/embeddings, OpenAI) → 로컬 SQLite (sql.js)
        임베딩 생성                    벡터 저장/검색
```

- `local-vector-store.ts`: Float32Array BLOB 저장, FTS4 키워드 검색
- `embedding-client.ts`: Worker `/embeddings` 엔드포인트 경유 OpenAI API 호출
- `hybrid-search.ts`: RRF (Reciprocal Rank Fusion) 알고리즘으로 벡터 + FTS4 결합
- `slack-sync.ts`: Slack 메시지 증분 동기화 (채널별 커서 관리)
- FTS5 미지원 확인 후 FTS4 사용 결정

### Phase 3: PGlite 통합 아키텍처 (현재)

```
앱 (Electron)
 ├── PGlite DB (PostgreSQL WASM + pgvector)
 │     ├── documents 테이블 (벡터 + 메타데이터)
 │     ├── sync_cursors 테이블
 │     └── FTS (tsvector)
 ├── EmbeddingService (OpenAI 직접, Settings에서 API Key 입력)
 ├── Sync Adapters
 │     ├── SlackSyncAdapter
 │     ├── NotionSyncAdapter
 │     ├── LinearSyncAdapter
 │     └── GmailSyncAdapter
 └── LocalSearchService (하이브리드 RRF 검색)

 Fallback Chain: LocalSearch (PGlite) → HybridSearch (sql.js) → Worker API
```

**주요 결정:**

| 결정 사항 | 선택 | 근거 |
|----------|------|------|
| DB 엔진 | PGlite (PostgreSQL WASM) | pgvector 네이티브 지원, SQL 호환 |
| 임베딩 모델 | OpenAI text-embedding-3-small (1536차원) | 고품질, Worker 경유 불필요 |
| 검색 알고리즘 | RRF (k=60) | 벡터 + FTS 결합, 단순하면서 효과적 |
| Auto Sync 주기 | 5분 고정 | UI 드롭다운 대신 단순화 |
| sql.js 파일 | 유지 (fallback) | 점진적 마이그레이션 |

---

## 주요 구현사항

### 1. PGlite DB 서비스 (`database.ts`)

- `initDatabaseService()`: 앱 시작 시 `index.ts`에서 호출
- `closeDatabaseService()`: `will-quit` 이벤트에서 정리
- DB 경로: `~/Library/Application Support/linear-capture/local.db`
- 스키마: documents (id, source_type, content, title, metadata, embedding), sync_cursors

### 2. 소스별 동기화 어댑터

| 소스 | 어댑터 | 특징 |
|------|--------|------|
| Slack | `sync-adapters/slack-sync.ts` | conversations.history, 채널별 증분 동기화, 워크스페이스 분리 |
| Notion | `sync-adapters/notion-sync.ts` | 로컬 캐시(`notion-local-reader`) 우선, API fallback |
| Linear | `sync-adapters/linear-sync.ts` | `issueSearch` SDK 메서드, content에 담당자/프로젝트 포함 |
| Gmail | `sync-adapters/gmail-sync.ts` | 배치 처리 (40개/배치, 500ms 딜레이), CF Worker 50 subrequest 제한 대응 |

**동기화 트리거:**
- 앱 시작 시 백그라운드 동기화
- OAuth 연결 성공 시 즉시 동기화 (`oauth-handlers.ts`)
- Settings > Sync Now 버튼 (수동)
- 5분 주기 Auto Sync 스케줄러

### 3. 검색 파이프라인 (`local-search.ts`)

```
쿼리 입력
  ├── query.length <= 3 → likeSearch() (LIKE fallback)
  └── query.length > 3
        ├── semanticSearch() (벡터 코사인 유사도)
        ├── keywordSearch() (FTS tsvector)
        │     └── FTS 결과 0건 → likeSearch() fallback
        └── RRF 병합 (k=60)
              → 최종 결과
```

**LIKE 검색 범위:** title, content, metadata(assigneeName, projectName, teamName)

### 4. Context Adapter 패턴 (소스별 균등 배분)

- `QUOTA_PER_SOURCE = 5`: 각 소스별 최대 5개
- `context.getRelated` IPC 핸들러에서 `Promise.allSettled`로 병렬 검색
- URL 기반 중복 제거 + confidence 점수 정렬
- Slack 3중 검색 제거 (API 1회만), 시맨틱 재정렬 제거

### 5. Linear 검색 통합

- `LinearService.searchIssues()`: `@linear/sdk`의 `client.searchIssues()` 활용
- `LinearAdapter`: ContextAdapter 인터페이스 구현
- content에 메타데이터 포함: `담당자: ${name}`, `프로젝트: ${name}`, `팀: ${name}`

### 6. 임베딩 서비스

- **앱 내 직접 호출**: `EmbeddingService` (OpenAI SDK, Settings에서 API Key 입력)
- **배치 처리**: `embedBatch()` - 최대 10개씩 청크 분할
- Graceful degradation: API Key 없으면 키워드 검색만 수행
- Gmail 동기화 속도: 40개 기준 8초 → 0.8초 (배치 적용, 10배 개선)

### 7. Force Re-sync 기능

- Settings UI에 "Force" 버튼 추가
- `syncFull(clearExisting=true)`: 기존 데이터 삭제 후 전체 재동기화
- IPC `sync:trigger`에 `{ source, force }` 객체 파라미터 지원 (하위 호환)

### 8. 디버그 지원

- `_debug` 필드: 검색 파이프라인 각 단계 추적
- DevTools Console에서 `result._debug` 확인
- 각 단계 로그: adapter 생성, isConnected, fetchItems 결과, search 결과

---

## 해결한 문제들

### 검색 품질

| 문제 | 원인 | 해결 |
|------|------|------|
| "cto" 검색 시 Linear 이슈 안 나옴 | Incremental sync가 기존 데이터 metadata 미업데이트 | Force Re-sync + content에 metadata 포함 |
| 짧은 키워드 검색 실패 | `websearch_to_tsquery`가 3글자 이하 stopword 처리 | `likeSearch()` fallback 추가 |
| Slack 결과가 전체의 대부분 차지 | 3중 검색 + 순서대로 push | 소스별 quota 5개, 중복 검색 제거 |
| AI 제목으로 검색 시 결과 없음 | 긴 제목을 그대로 쿼리로 사용 | 키워드 추출 함수 (`extractKeywords`) |
| FTS에서 metadata 검색 불가 | tsvector에 metadata 미포함 | LIKE fallback에 metadata 필드 포함 |

### IPC/통신

| 문제 | 원인 | 해결 |
|------|------|------|
| semanticSearch 영원히 pending | 외부 JS에서 ipcRenderer 접근 타이밍 이슈 | `semantic-search.js`를 `index.html` 인라인으로 이동 |
| 검색 결과 비어있음 | Slack Rich Message의 `text` 필드 빈 문자열 | Worker에 `extractTextFromBlocks()` 추가 |

### 동기화/초기화

| 문제 | 원인 | 해결 |
|------|------|------|
| PGlite DB 미생성 | `initDatabaseService()` 미호출 | `index.ts` app.whenReady()에서 호출 추가 |
| API Key 없으면 앱 크래시 | `EmbeddingService` 생성자에서 즉시 throw | `local-search.ts`에서 nullable 처리, graceful degradation |
| syncSource() 미동작 | stub 함수 (로그만 출력) | sync-adapters 호출로 교체 |
| Gmail "Too many subrequests" | CF Worker Free plan 50 subrequest 제한 | 배치 처리 (40개/배치, 500ms 딜레이) |
| Slack OAuth 스코프 부족 | private channel에 groups:read/history 필요 | Worker OAuth 스코프에 추가 후 재연결 |

---

## 현재 아키텍처

### 검색 Fallback Chain

```
1. LocalSearchService (PGlite + pgvector)
     ├── Hybrid RRF (벡터 + FTS)
     └── LIKE fallback (짧은 키워드)
2. HybridSearch (sql.js, 레거시)
3. Worker API (최종 fallback)
```

### 주요 파일 구조

```
src/services/
  ├── database.ts               # PGlite DB 서비스
  ├── local-search.ts           # 하이브리드 검색 오케스트레이터
  ├── embedding-service.ts      # OpenAI 임베딩 (앱 내 직접 호출)
  ├── text-preprocessor.ts      # 텍스트 전처리
  ├── hybrid-search.ts          # RRF 결합 검색 (sql.js 레거시)
  ├── local-vector-store.ts     # SQLite 벡터 저장소 (sql.js 레거시)
  ├── embedding-client.ts       # Worker 임베딩 클라이언트 (레거시)
  ├── sync-adapters/
  │     ├── slack-sync.ts       # Slack 동기화
  │     ├── notion-sync.ts      # Notion 동기화
  │     ├── linear-sync.ts      # Linear 동기화
  │     └── gmail-sync.ts       # Gmail 동기화
  ├── context-adapters/
  │     ├── slack-adapter.ts    # Slack 실시간 검색
  │     ├── notion-adapter.ts   # Notion 검색 (로컬 캐시 우선)
  │     ├── gmail-adapter.ts    # Gmail 검색
  │     └── linear-adapter.ts   # Linear 이슈 검색
  └── linear-client.ts          # searchIssues() 메서드 포함

src/main/
  ├── index.ts                  # DB 초기화, Auto Sync 스케줄러
  ├── ipc-handlers.ts           # sync:trigger, openai:get-key 등
  └── oauth-handlers.ts         # OAuth 후 자동 동기화

src/renderer/
  ├── index.html                # 시맨틱 검색 인라인 스크립트
  └── settings.html             # Data Sync UI, Force Re-sync 버튼
```

### Settings UI (Data Sync 섹션)

- OpenAI API Key 입력/저장
- 소스별 연결 상태 + Sync Now 버튼 + Force Re-sync 버튼
- "Synced N items" 결과 표시 (2초 후 "just now"로 전환)
- 5분마다 자동 동기화 안내 문구
- i18n 다국어 지원 (en/ko/de/fr/es)
