# F04. Slack 통합 (완료)

Linear Capture에 Slack 연동 기능을 추가한 전체 작업 기록.

---

## 1. 맥락 통합 (Slack + Notion OAuth)

### 개요
- Slack/Notion OAuth 연동 + 메시지/페이지 검색 + 이슈 설명에 컨텍스트 첨부
- Cloudflare Worker 확장 (OAuth 토큰 저장, 검색 프록시)
- 6-Task 구조: Worker 기반 → Slack OAuth → Slack 검색 UI → Notion OAuth → Notion 검색 UI → 통합

### 주요 결정사항

| 항목 | 결정 |
|------|------|
| 인증 방식 | 시스템 브라우저 + HTTPS→deep link 리다이렉트 |
| 토큰 저장 | Worker KV (device_id 기반 매핑) |
| Slack Token | User Token (`search:read` 스코프), Bot Token 불가 |
| Rate Limit | Slack 20 req/min, Notion 3 req/sec |
| MVP 범위 | Slack 특정 채널 + Notion 전체 워크스페이스 |

### 구현 파일

| 파일 | 역할 |
|------|------|
| `src/services/slack-client.ts` | Slack OAuth + 검색 서비스 |
| `src/services/notion-client.ts` | Notion OAuth + 검색 서비스 |
| `src/renderer/settings.html` | 연결 상태 관리 UI |
| `src/renderer/index.html` | Context Search 섹션 (Slack/Notion 탭, 검색, 체크박스 선택) |

### 완료 상태 (2025-01-29)
- Task 1~4 완료: Worker OAuth, Slack 연동/검색, Notion 연동
- Task 5~6 대기: Notion 검색 UI, 통합 Context 섹션

---

## 2. 시맨틱 검색 + 지표 수집

### 개요
- 키워드 → 시맨틱 검색으로 업그레이드 (OpenAI Embedding, Stateless)
- Worker `/search`, `/track` 엔드포인트 추가
- 비용: ~$0.15/월 (OpenAI Embedding)

### 아키텍처
- **Stateless**: Slack API 호출 → 메시지 임베딩 → 코사인 유사도 → 결과 반환 → 데이터 휘발 (DB 저장 없음)
- **지표 수집**: `app_open`, `issue_created` 이벤트를 deviceId(익명)와 함께 KV 저장

### 생성 파일

| 파일 | 역할 |
|------|------|
| `src/types/context-search.ts` | ContextItem, ContextAdapter, TrackRequest 타입 |
| `src/services/semantic-search.ts` | Worker `/search` 호출 래퍼 |
| `src/services/analytics.ts` | Worker `/track` 호출 래퍼 |
| `src/services/context-adapters/slack-adapter.ts` | SlackMessage → ContextItem 변환 |

### 검증 결과
- `/search`: "로그인이 안됩니다" → "인증 오류" 0.59, "비밀번호" 0.49, "날씨" 0.18
- 37 tests, 0 failures, Worker `app_open` 로그 확인

---

## 3. Slack 포맷 파서

### 문제
AI 추천에서 Slack 메시지의 raw 포맷이 변환되지 않음:
- `<url|텍스트>` → `[텍스트](url)`
- `<#C123|general>` → `#general`
- `<!here>` → `@here`

### 해결
`slack-user-cache.ts`의 `resolve()` 함수 구조 변경:
- 기존: `userMap` 미로드 시 즉시 원본 반환 (새 변환 실행 안 됨)
- 변경: `let result = text` 도입, 사용자 멘션은 조건부, 나머지 변환은 항상 실행

### 변환 규칙

| 포맷 | 변환 | 비고 |
|------|------|------|
| `<@U123>` | `@이름` | userMap에서 조회 (기존) |
| `<#C123\|name>` | `#name` | 이름 없으면 원본 유지 |
| `<!here>` | `@here` | channel, everyone도 동일 |
| `<url\|텍스트>` | `[텍스트](url)` | URL만 있으면 URL 추출 |

---

## 4. DM 채널 title 유저 ID 변환

### 문제
DM 채널 title이 `#U07B2GLQQER`로 표시 (사용자 이름 미변환)

### 원인
- `semantic-search.ts`에서 title에 `resolve()` 미적용
- `resolve()` 정규식이 `<@...>` 형태만 지원, `#U...` 형태 미지원

### 해결
1. `convertHybridResults()`에서 title도 `resolve()` 처리
2. `resolve()`에 DM title 정규식 추가: `^#([A-Z][A-Z0-9]+)$` → `@사용자명`
   - 일반 채널명 (`#general`)은 소문자 포함이라 매칭 안 됨

---

## 5. 유저 멘션 실명 변환

### 개요
`<@U04M2VCUU4C>` → `@실제이름` 변환 (표시 시점)

### 구현
1. **Worker**: `GET /slack/users` 엔드포인트 (users.list API)
2. **Client**: `SlackUserCache` 싱글턴 (앱 시작 시 1회 로드, 메모리 캐시)
3. **통합**: `SemanticSearchService.convertHybridResults()`에서 Slack 결과에 변환 적용
4. **초기화**: 앱 시작 시 + OAuth 재연결 시 캐시 로드

### 핵심 원칙
- 캐시 미로드 시 에러 없이 원본 반환 (graceful degradation)
- 매 검색마다 API 호출 금지 (캐싱 필수)
- UI 코드 수정 없음

---

## 6. 채널 선택기

### 초기 구현
- OAuth 완료 후 채널 선택 모달 + Settings에서 채널 목록 관리
- 기본값: 전체 채널 선택 (opt-out 방식)
- `renderChannelList()` 함수 추상화 (모달/Settings 공유)
- i18n 번역 키 9개 추가

### 모달 리디자인
- inline collapsible → modal 기반으로 변경 (Notion/Gmail row와 시각적 일관성)
- Settings에는 "12/45 channels [Edit]" 요약 행만 표시
- `showChannelSelectionModal(mode)`: `'post-oauth'` (Skip=모두 저장) vs `'edit'` (Cancel=취소)

---

## 7. 채널 필터 버그 수정

### 문제
`local-search.ts`에서 `getSelectedSlackChannels()`가 전체 채널 목록을 반환하는데, `selected` 플래그를 무시하고 모든 채널 ID로 필터링.

### 수정 (3곳: vectorSearch, ftsSearch, likeSearch)
```javascript
// Before (버그)
const channelIds = selectedChannels.map(ch => ch.id);  // 모든 채널

// After (수정)
const selectedIds = allChannels.filter(ch => ch.selected).map(ch => ch.id);
// allChannels.length === 0 → 전체 포함 (opt-out 기본값)
// selectedIds.length > 0 → 선택된 채널만
// selectedIds.length === 0 && allChannels.length > 0 → Slack 제외
```

---

## 관련 파일 요약

| 파일 | 역할 |
|------|------|
| `src/services/slack-client.ts` | Slack OAuth + 검색 |
| `src/services/slack-user-cache.ts` | 유저 캐시 + resolve() 포맷 파서 |
| `src/services/semantic-search.ts` | 시맨틱 검색 + 유저 멘션 변환 |
| `src/services/analytics.ts` | 지표 전송 |
| `src/services/context-adapters/slack-adapter.ts` | SlackMessage → ContextItem |
| `src/services/local-search.ts` | 채널 필터링 (vectorSearch/fts/like) |
| `src/renderer/settings.html` | 채널 선택기 (모달 + 요약 행) |
| `src/renderer/index.html` | Context Search 섹션 |
| `src/types/context-search.ts` | 공통 타입 |
