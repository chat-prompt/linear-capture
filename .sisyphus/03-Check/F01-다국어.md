# F01-다국어 (i18n) 기능 통합 문서

## 개요

Linear Capture 앱에 다국어(i18n) 지원을 추가한 기능. 초기 한국어/영어 2개 언어에서 시작하여 독일어, 프랑스어, 스페인어를 포함한 **5개 언어**로 확장. `npm run translate` 명령어로 Gemini API 기반 자동 번역을 지원하며, `npm run validate:i18n`으로 번역 파일 검증이 가능.

**최종 지원 언어**: English, 한국어, Deutsch, Francais, Espanol

**핵심 파일**:

| 파일 | 역할 |
|------|------|
| `src/main/i18n.ts` | Main process i18next 초기화, `SUPPORTED_LANGUAGES` 정의 |
| `locales/{en,ko,de,fr,es}/translation.json` | 언어별 번역 파일 (~212개 키) |
| `src/services/settings-store.ts` | `getLanguage()`, `setLanguage()` 함수 |
| `scripts/translate-i18n.js` | Gemini API 자동 번역 스크립트 |
| `scripts/validate-i18n.js` | 번역 키 검증 스크립트 |

---

## 구현 히스토리

### 1단계: i18n 인프라 구축

- **라이브러리**: i18next (react-i18next가 아닌 vanilla JS용)
- Main/Renderer 프로세스 각각 i18next 초기화 필요 (Electron 특성)
- `electron-store`를 사용해 언어 설정 저장/로드
- 시스템 언어 자동 감지 (`app.getLocale()`) + Settings에서 수동 변경
- 번역 키 구조: `common.`, `settings.`, `capture.`, `onboarding.`, `dialogs.` 등 15개 카테고리

### 2단계: HTML 파일 번역 적용

- `index.html`, `settings.html`, `onboarding.html` 3개 HTML 파일의 하드코딩 문자열을 `data-i18n` 속성으로 교체
- 동적 콘텐츠(에러 메시지, 상태 텍스트)는 `t()` 함수로 직접 호출
- 언어 변경 시 페이지 새로고침 없이 실시간 UI 업데이트 (IPC `language-changed` 이벤트)
- Settings 페이지에 Language 드롭다운 추가

### 3단계: 5개 언어 확장

- en/ko에서 de/fr/es 3개 언어 추가 (AI 자동 번역)
- `SUPPORTED_LANGUAGES` 배열을 3곳(i18n.ts, settings-store.ts, settings.html)에서 동기화
- `validate-i18n.js` 검증 스크립트로 키 누락/추가 자동 감지

### 4단계: 자동 번역 스크립트

- `scripts/translate-i18n.js` 생성 - Gemini API로 누락 번역 자동 생성
- 영어(en) 기준으로 다른 4개 언어의 누락 키 감지 후 번역
- `{{variable}}` interpolation 패턴 보존 검증
- 기존 번역 보존 (누락된 키만 추가)
- 부분 저장 지원 (API 에러 시 성공 번역만 저장)

### 5단계: AI 분석 출력 언어 지원

- 캡처 후 AI 분석 결과(이슈 제목/본문)가 사용자 선택 언어로 출력되도록 수정
- 앱에서 `language` 파라미터를 Worker로 전달
- Worker의 프롬프트에 동적 언어 지시(`getLanguageInstruction()`) 추가
- 한국어가 기본(추가 지시 없음), 다른 언어 선택 시 명시적 영어/독일어 등 출력 지시

### 6단계: Worker 프롬프트 완전 분리

- 하드코딩된 한국어 프롬프트 제거 (예: `"JSON 응답 형식"`)
- `PromptTemplates` 인터페이스에 `jsonFormatHeader`, `outputLanguageInstruction` 추가
- 5개 언어별 별도 템플릿 파일(en.ts, ko.ts, de.ts, fr.ts, es.ts)로 완전 분리
- 언어 전환 시 혼합 출력 문제 해결

---

## 주요 결정사항

| 결정 | 이유 |
|------|------|
| i18next 사용 (CDN 아닌 번들링) | Electron 앱이므로 로컬 파일 로드가 적합 |
| 트레이 메뉴 영어 유지 | macOS 네이티브 메뉴는 시스템 언어와 일관성 |
| 온보딩에 언어 선택 단계 없음 | 시스템 언어로 자동 감지, Settings에서 변경 가능 |
| 영어(en)가 번역 기준 | fallback 언어이자 자동 번역의 소스 |
| Gemini API로 자동 번역 | 비용 효율적이고 충분한 품질 |
| 드롭다운 라벨(Team, Project 등) 영어 고정 | Linear API 데이터와 일치, 혼란 방지 |
| Priority 옵션(Urgent, High 등) 영어 고정 | Linear 표준 용어 유지 |
| `getLanguage()` (settings-store) 사용 | i18next 내부 상태보다 안정적 |
| Worker 프롬프트 언어별 완전 분리 | Dynamic instruction만으로는 혼합 출력 발생 |

---

## 해결한 버그들

### 1. 프로덕션 locales 경로 오류
- **증상**: 패키징 후 영어 설정인데 메인 UI가 한국어로 표시
- **원인**: `process.resourcesPath` 대신 `app.getAppPath()`를 사용해야 asar 내부 경로 접근 가능
- **수정**: `src/main/i18n.ts` 경로 변경

### 2. 캡처 창 스크립트 전체 미실행 (SyntaxError)
- **증상**: 언어 변경이 캡처 창에 반영 안 됨
- **원인**: `capture-ready`, `ai-analysis-ready` 콜백에 `async` 키워드 누락 → `await` 사용으로 파싱 에러 → 전체 스크립트 미실행
- **수정**: 4개 함수에 `async` 키워드 추가 (`capture-ready`, `ai-analysis-ready`, `renderSlackResults`, `renderNotionResults`)

### 3. 동적 UI 요소 미갱신
- **증상**: 언어 변경 시 버튼 텍스트, 드롭다운 기본값(None, Unassigned) 미변경
- **수정**: `updateDynamicUI()` 함수 추가, `createSearchableSelect`에 `updateDefaultLabel()` 메서드 추가

### 4. 언어 변경 후 한국어로 되돌아가는 문제
- **원인**: Worker 호출 시 `getCurrentLanguage()` (i18next 내부 상태) 대신 `getLanguage()` (settings-store) 사용 필요
- **수정**: `index.ts`에서 언어 소스를 settings-store로 변경

### 5. AI 분석 제목이 한국어로만 출력
- **원인**: Worker 템플릿에 제목 번역 강제 지시 부재
- **수정**: 4개 언어 템플릿의 `outputLanguageInstruction`에 제목 포함 명시적 번역 지시 추가

---

## 최종 아키텍처

```
앱 (Electron)
├── src/main/i18n.ts          # Main process i18next 초기화
│   ├── SUPPORTED_LANGUAGES = ['en', 'ko', 'de', 'fr', 'es']
│   ├── getCurrentLanguage()  # i18next 현재 언어
│   └── changeLanguage()      # 언어 변경 + IPC 브로드캐스트
├── src/services/settings-store.ts
│   ├── getLanguage()         # electron-store에서 언어 로드 (안정적)
│   └── setLanguage()         # 언어 저장
├── locales/{en,ko,de,fr,es}/translation.json  # ~212개 키
└── src/renderer/*.html
    ├── data-i18n 속성        # 정적 텍스트 번역
    ├── t() 함수 호출          # 동적 텍스트 번역
    ├── translatePage()        # data-i18n 일괄 적용
    ├── autoTranslate()        # 역방향 맵 기반 자동 번역
    └── updateDynamicUI()      # 버튼/드롭다운 동적 업데이트

Worker (Cloudflare)
├── src/prompts/templates/{en,ko,de,fr,es}.ts  # 언어별 프롬프트 템플릿
│   ├── titleRules            # 제목 규칙 (언어별)
│   ├── descriptionTemplate   # 본문 템플릿 (언어별)
│   ├── jsonFormatHeader      # JSON 형식 안내 (언어별)
│   └── outputLanguageInstruction  # 출력 언어 강제 지시
└── src/prompts/issue-prompt.ts
    └── buildImagePrompt/buildTextPrompt  # 템플릿 사용

번역 자동화
├── scripts/translate-i18n.js   # npm run translate (Gemini API)
└── scripts/validate-i18n.js    # npm run validate:i18n (키 검증)
```

**언어 변경 흐름**:
1. Settings 드롭다운에서 언어 선택
2. `setLanguage()` → electron-store에 저장
3. `changeLanguage()` → i18next 언어 변경
4. IPC `language-changed` 이벤트 → 모든 창에 브로드캐스트
5. 각 창: `translatePage()` + `autoTranslate()` + `updateDynamicUI()` 실행

**AI 분석 언어 흐름**:
1. 캡처 시 `getLanguage()`로 현재 언어 조회
2. Worker 요청에 `language` 파라미터 포함
3. Worker가 해당 언어 템플릿 로드
4. AI가 지정 언어로 제목/본문 생성
